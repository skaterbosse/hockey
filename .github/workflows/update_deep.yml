name: update-deep

permissions:
  contents: write

on:
  schedule:
    - cron: "0 3 * * *"     # KÃ¶r dagligen kl 03:00
  workflow_dispatch:

jobs:
  deep-update:
    runs-on: ubuntu-latest

    steps:

    # ----------------------------------------------------------
    # CHECKOUT
    # ----------------------------------------------------------
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: main

    # ----------------------------------------------------------
    # Python + jq
    # ----------------------------------------------------------
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install tools
      run: |
        python3 -m pip install --upgrade pip
        pip install beautifulsoup4 requests certifi pandas
        sudo apt-get update
        sudo apt-get install -y jq

    # ----------------------------------------------------------
    # DATE
    # ----------------------------------------------------------
    - name: Determine today's date
      id: datestep
      run: echo "today=$(date +%Y-%m-%d)" >> "$GITHUB_OUTPUT"

    # ----------------------------------------------------------
    # FETCH MATCHES FOR TODAY..TODAY+7 (write to games_new.csv)
    # ----------------------------------------------------------
    - name: Fetch matches for date window
      run: |
        TODAY=${{ steps.datestep.outputs.today }}
        for i in {0..7}; do
          DATE=$(date -d "$TODAY + $i days" +%Y-%m-%d)
          echo "Fetching matches for $DATE"
          python3 scripts/createGamesFile.py --date "$DATE" --outfile "data/games_new_tmp_$i.csv"
        done

        # Combine all tmp into games_new.csv
        echo "Combining into games_new.csv"
        head -1 data/games_new_tmp_0.csv > data/games_new.csv
        tail -q -n +2 data/games_new_tmp_*.csv >> data/games_new.csv

    # ----------------------------------------------------------
    # MERGE WITH EXISTING games.csv
    # ----------------------------------------------------------
    - name: Merge games.csv
      run: |
        TODAY=${{ steps.datestep.outputs.today }}
        python3 scripts/mergeGames.py --date "$TODAY"
        rm data/games_new_tmp_*.csv data/games_new.csv || true

    # ----------------------------------------------------------
    # UPDATE SERIES (reset DoneToday)
    # ----------------------------------------------------------
    - name: Update series.csv
      run: |
        TODAY=${{ steps.datestep.outputs.today }}
        python3 scripts/updateSeriesFile.py --date "$TODAY" --reset-done

    # ----------------------------------------------------------
    # COMMIT & PUSH
    # ----------------------------------------------------------
    - name: Commit & Push changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

        git add data/games.csv data/series.csv || true

        if git diff --cached --quiet; then
          echo "No changes to commit."
          exit 0
        fi

        git commit -m "Deep update $(date -u +'%Y-%m-%d %H:%M UTC')"
        git push origin main

