name: update_deep

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      date:
        description: "Override date (YYYY-MM-DD) for deep update"
        required: false
  schedule:
    - cron: "0 3 * * *"   # Kör dagligen kl 03:00

jobs:
  deep_update:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    env:
      TZ: Europe/Stockholm

    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set TODAY
        id: today
        run: |
          if [ -n "${{ github.event.inputs.date }}" ]; then
              DATE="${{ github.event.inputs.date }}"
          else
              DATE=$(date +%F)
          fi
          echo "TODAY=$DATE" >> $GITHUB_ENV
          echo "Using TODAY=$DATE"

      - name: Setup python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          pip install --upgrade pip
          pip install requests beautifulsoup4

      - name: Ensure data dir exists
        run: mkdir -p data

      # 1) FETCH today's matches → data/games_new.csv
      - name: Fetch today’s matches
        run: |
          echo "Fetching matches for $TODAY"
          python3 scripts/createGamesFile.py --date "$TODAY" -dbg

      # 2) MERGE games_new.csv with games.csv → gör att inget försvinner
      - name: Merge into games.csv
        run: |
          python3 scripts/mergeGames.py

      # 3) Uppdatera series.csv med Live=Yes/YesLight/No
      - name: Update series table (Simple/Light/Normal)
        run: |
          python3 scripts/updateSeriesFile.py --date "$TODAY"

      # 4) Commit files if changed
      - name: Commit & push if changed
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          if git status --porcelain | grep -q .; then
            git add data/*
            git commit -m "deep_update $(date +'%F %T')"
            git push
          else
            echo "No changes to commit."
          fi

