name: update-deep

on:
  schedule:
    - cron: "0 3 * * *"   # Kör dagligen kl 03:00
  workflow_dispatch:

jobs:
  update-deep:
    runs-on: ubuntu-latest

    steps:

    # ----------------------------------------------------------
    # 1. CHECKOUT
    # ----------------------------------------------------------
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: main

    # ----------------------------------------------------------
    # 2. Setup Python
    # ----------------------------------------------------------
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip install beautifulsoup4 requests certifi

    # ----------------------------------------------------------
    # 3. Ensure directories exist
    # ----------------------------------------------------------
    - name: Create required directories
      run: |
        mkdir -p cache/deep
        mkdir -p logs

    # ----------------------------------------------------------
    # 4. Archive oldest date (ROBUST VERSION)
    # ----------------------------------------------------------
    - name: Archive expired day into oldGames.csv (robust)
      run: |
        echo "[ARCHIVE] Steg 1 – Identifierar datum som ska flyttas..."

        TODAY=$(date +%Y-%m-%d)
        EXPIRE_DATE=$(date -d "$TODAY -5 days" +%Y-%m-%d)

        echo "[ARCHIVE] EXPIRE_DATE = $EXPIRE_DATE"

        # Om games.csv saknas → hoppa över
        if [ ! -f data/games.csv ]; then
          echo "[ARCHIVE] games.csv saknas – hoppar över arkivering."
          exit 0
        fi

        # Kontrollera om det finns något att arkivera
        if ! grep -q "^$EXPIRE_DATE" data/games.csv ; then
          echo "[ARCHIVE] Inga matcher på $EXPIRE_DATE i games.csv – hoppar över."
          exit 0
        fi

        echo "[ARCHIVE] Det finns rader att arkivera."

        # Flytta matcherna, utan att krascha om grep hittar få/inga rader
        grep "^$EXPIRE_DATE" data/games.csv >> data/oldGames.csv || true

        # Skapa ny games.csv utan de flyttade raderna
        grep -v "^$EXPIRE_DATE" data/games.csv > data/games.tmp || true
        mv data/games.tmp data/games.csv

        echo "[ARCHIVE] Arkivering klar."
        echo "[ARCHIVE] $(grep -c "^$EXPIRE_DATE" data/oldGames.csv) rader totalt med detta datum i oldGames.csv."

    # ----------------------------------------------------------
    # 5. RUN DEEP WINDOW FETCH
    # ----------------------------------------------------------
    - name: Run rolling deep fetch
      run: |
        echo "===================="
        echo "RUNNING DEEP WINDOW"
        echo "===================="

        python3 scripts/rolling_deep_fetch.py --window 12

        echo "===================="
        echo "DEEP WINDOW DONE"
        echo "===================="

    # ----------------------------------------------------------
    # 6. Collect output from rolling_deep_fetch.py → tmp_concat_deep.txt
    # ----------------------------------------------------------
    - name: Collect deep fetch output
      run: |
        echo "[COLLECT] Samlar ihop output..."

        if [ ! -f tmp_concat_deep.txt ]; then
          echo "[COLLECT] tmp_concat_deep.txt saknas – deep fetch misslyckades."
          exit 1
        fi

        echo "[COLLECT] tmp_concat_deep.txt hittad – fortsätter."

    # ----------------------------------------------------------
    # 7. Generate updated games.csv using getClubs.py
    # ----------------------------------------------------------
    - name: Build games.csv
      run: |
        echo "[CLUBS] Genererar games.csv baserat på tmp_concat_deep.txt"

        python3 scripts/getClubs.py \
          -gf tmp_concat_deep.txt \
          -cf scripts/Clubs.txt \
          -af scripts/Arenas.csv \
          -scf scripts/Combined_clubs_teams.txt \
          -ogf tmp_deep_update.txt

        mv tmp_deep_update.txt data/games.csv

        echo "[CLUBS] Ny games.csv klar."

    # ----------------------------------------------------------
    # 8. Print diagnostics
    # ----------------------------------------------------------
    - name: Diagnostic summary
      run: |
        echo "========== DIAGNOSTIK =========="

        FIRST=$(head -1 data/games.csv | cut -d',' -f1)
        LAST=$(tail -1 data/games.csv | cut -d',' -f1)

        echo "Games.csv date range: $FIRST → $LAST"

        echo "Antal rader i games.csv:"
        wc -l data/games.csv

        echo "Antal rader i oldGames.csv:"
        wc -l data/oldGames.csv

        echo "========== SLUT =========="

    # ----------------------------------------------------------
    # 9. Commit changes
    # ----------------------------------------------------------
    - name: Commit & Push deep update
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

        git add data/games.csv data/oldGames.csv cache/deep logs || true

        if git diff --cached --quiet; then
          echo "Inga ändringar att commita."
          exit 0
        fi

        git commit -m "Deep update $(date -u +'%Y-%m-%d %H:%M UTC')"
        git push origin main

