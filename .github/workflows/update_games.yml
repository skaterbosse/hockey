name: Update games.csv (deep + shallow automation)

on:
  schedule:
    # Deep fetch en gång per natt kl. 03:00 Stockholmstid
    - cron: "0 2 * * *"
    # Shallow update var 5:e minut mellan 06–22 UTC (07–23 svensk tid)
    - cron: "*/5 6-22 * * *"
  workflow_dispatch:

env:
  TZ: Europe/Stockholm

jobs:
  update-games:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies (incl. certifi fix)
        run: |
          python3 -m pip install -r ./scripts/requirements.txt
          python3 -m pip install certifi
          export SSL_CERT_FILE=$(python3 -m certifi)
          echo "Using SSL cert from: $SSL_CERT_FILE"

      - name: Setup folder structure
        run: |
          mkdir -p cache/deep
          mkdir -p cache/shallow
          mkdir -p logs

      - name: Decide if shallow update should run
        id: shallow_gate
        run: |
          python3 ./scripts/shallow_update_gatekeeper.py > logs/gatekeeper.log
          if grep -q "RUN_SHALLOW=true" logs/gatekeeper.log; then
            echo "run_shallow=true" >> $GITHUB_OUTPUT
          else
            echo "run_shallow=false" >> $GITHUB_OUTPUT
          fi

      - name: Shallow update (real-time results update)
        if: ${{ steps.shallow_gate.outputs.run_shallow == 'true' }}
        run: |
          echo "Running shallow update..."
          python3 ./scripts/getGames.py -sh -sd $(date +'%Y-%m-%d') -ed $(date +'%Y-%m-%d') -ah null -f cache/shallow/tmp_shallow.txt

          # Merge into master games.csv
          python3 ./scripts/UpdateGames.py data/games.csv cache/shallow/tmp_shallow.txt

          echo "$(date +"%Y-%m-%d %H:%M:%S") shallow update OK" >> logs/shallow.log

      - name: Deep fetch (03:00)
        if: ${{ github.event.schedule == '0 2 * * *' }}
        run: |
          echo "Running deep fetch..."
          TODAY=$(date +'%Y-%m-%d')
          python3 ./scripts/getGames.py -sd $TODAY -ed $TODAY -ah null -f cache/deep/tmp_deep.txt

          # Replace master games.csv
          cp cache/deep/tmp_deep.txt data/games.csv

          echo "$(date +"%Y-%m-%d %H:%M:%S") deep fetch OK" >> logs/deep.log

      - name: Commit and push changes (if games.csv changed)
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

          git add data/games.csv logs/*.log || true

          if git diff --cached --quiet; then
            echo "Nothing to commit."
            exit 0
          fi

          git commit -m "Auto-update games.csv ($(date +"%Y-%m-%d %H:%M"))"
          git push origin main

