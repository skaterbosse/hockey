name: update-games

on:
  schedule:
    # 03:00 Europe/Stockholm (02:00 UTC vintertid)
    - cron: '0 2 * * *'
    # var 5:e minut mellan 06â€“22 UTC = 07â€“23 svensk tid
    - cron: '*/5 6-22 * * *'
  workflow_dispatch:

jobs:
  update-games:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Stockholm

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install -r scripts/requirements.txt
          pip install certifi pytz

      - name: Prepare logs directory
        run: mkdir -p logs cache/deep

      - name: Determine mode (shallow or deep)
        id: mode
        run: |
          hour=$(date +%H)
          if [ "$hour" = "02" ]; then
            echo "mode=deep" >> $GITHUB_OUTPUT
          else
            echo "mode=shallow" >> $GITHUB_OUTPUT
          fi

      # ====================
      # ðŸŸ¢ SHALLOW UPDATES
      # ====================
      - name: Run shallow gatekeeper
        if: steps.mode.outputs.mode == 'shallow'
        run: |
          python3 ./scripts/shallow_update_gatekeeper.py | tee logs/gatekeeper.log
          if grep -q "run=False" logs/gatekeeper.log; then
            echo "Gatekeeper: no shallow update needed."
            exit 0
          fi

      - name: Run shallow update
        if: steps.mode.outputs.mode == 'shallow'
        run: |
          TODAY=$(date +%F)
          python3 ./scripts/getGames.py -sh -sd $TODAY -ed $TODAY -ah null -f cache/shallow_today.txt
          python3 ./scripts/UpdateGames.py data/games.csv cache/shallow_today.txt
          echo "Shallow update completed."

      # ====================
      # ðŸ”µ DEEP UPDATE (03:00)
      # ====================
      - name: Run deep update (rolling window)
        if: steps.mode.outputs.mode == 'deep'
        run: |
          set -e
          TODAY=$(date +%F)
          START=$(date -d "$TODAY -4 days" +%F)
          END=$(date -d "$TODAY +7 days" +%F)
          echo "Deep fetch window: $START â†’ $END"

          TMPFILE=data/games.tmp.csv
          FINALFILE=data/games.csv

          # read existing dates from current games.csv if available
          touch $FINALFILE
          EXISTING_DATES=$(awk -F';' 'NR>1 {print $1}' $FINALFILE | sort -u)

          rm -f $TMPFILE
          for i in $(seq 0 11); do
            DATE=$(date -d "$START +$i days" +%F)
            # skip if already exists, except today
            if [[ "$DATE" != "$TODAY" ]] && echo "$EXISTING_DATES" | grep -q "$DATE"; then
              echo "Skipping $DATE (already exists)"
              continue
            fi

            echo "Fetching $DATE..."
            python3 ./scripts/getGames.py -sd $DATE -ed $DATE -ah null -f cache/deep/All_games_${DATE}_deep.txt
            python3 ./scripts/getClubs.py -gf cache/deep/All_games_${DATE}_deep.txt -cf scripts/Clubs.txt -af scripts/Arenas.csv -scf scripts/Combined_clubs_teams.txt -ogf cache/deep/All_games_${DATE}_deep_update.txt

            if [ ! -f "$TMPFILE" ]; then
              cp cache/deep/All_games_${DATE}_deep_update.txt $TMPFILE
            else
              tail -n +2 cache/deep/All_games_${DATE}_deep_update.txt >> $TMPFILE
            fi
          done

          mv $TMPFILE $FINALFILE
          echo "âœ… Deep update completed, new data/games.csv created."

      # ====================
      # ðŸ”§ COMMIT AND PUSH
      # ====================
      - name: Commit and push changes
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/games.csv logs/
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "Auto-update games.csv ($(date '+%Y-%m-%d %H:%M'))"
          git push origin main

      - name: Show log summary
        if: always()
        run: |
          echo "========== LOGS =========="
          ls -l logs/
          tail -n 20 logs/* || true

