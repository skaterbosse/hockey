name: Update games.csv

on:
  schedule:
    # Deep update – en gång per natt
    - cron: "0 2 * * *"  # 03:00 svensk tid (02:00 UTC)
    # Shallow update — var 5:e minut mellan 06–22 UTC
    - cron: "*/5 6-22 * * *"
  workflow_dispatch:

jobs:

  deep_daily:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 2 * * *'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set timezone
        run: sudo timedatectl set-timezone Europe/Stockholm

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r scripts/requirements.txt

      - name: Run deep fetch (today + expand forward window)
        run: |
          python3 scripts/deep_daily_window.py

      - name: Commit changes (if any)
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          if [[ -n $(git status --porcelain) ]]; then
            git add data/games.csv
            git commit -m "Deep update (auto)"
            git push
          else
            echo "✅ No changes to commit"
          fi

      - name: Cleanup logs
        run: |
          find logs/ -type f -mtime +30 -delete || true


  shallow_live:
    runs-on: ubuntu-latest
    if: github.event.schedule != '0 2 * * *'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set timezone
        run: sudo timedatectl set-timezone Europe/Stockholm

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r scripts/requirements.txt

      - name: Run shallow update only if matches are relevant
        run: |
          python3 scripts/shallow_update_gatekeeper.py

      - name: Commit changes (if any)
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          if [[ -n $(git status --porcelain) ]]; then
            git add data/games.csv
            git commit -m "Shallow update (auto)"
            git push
          else
            echo "✅ No changes to commit"
          fi

      - name: Cleanup logs
        run: |
          find logs/ -type f -mtime +30 -delete || true

