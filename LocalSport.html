<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="theme-color" content="#ffffff" />
<title>LocalSport v17.3 ‚Äì komplett</title>

<style>
:root{
  --topbar-h:56px;
  --hint-h:26px;
  --slot-h:42px;
  --bg:#f2f4f8;
  --hair:#e1e5eb;
  --text:#0f172a;
  --muted:#64748b;
  --accent:#16a34a;
  --link:#2563eb;
}

*{box-sizing:border-box}
html,body{
  margin:0;padding:0;height:100%;
  background:var(--bg);color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  overscroll-behavior:none;
}

.device{
  width:100%;
  height:100dvh;
  overflow:hidden;
  display:flex;
  flex-direction:column;
}

/* ---------- TOP BAR ---------- */
.topbar{
  position:sticky;
  top:0;
  z-index:500;
  background:#fff;
  border-bottom:1px solid var(--hair);
}

.topbar-inner{
  display:grid;
  grid-template-columns:1fr auto 1fr;
  align-items:center;
  padding:6px 8px;
  gap:6px;
  height:var(--topbar-h);
}

.cluster-left,.cluster-right{
  display:flex;align-items:center;gap:8px;
}
.cluster-center{
  display:flex;align-items:center;justify-content:center;gap:8px;
}

.icon-btn{
  width:32px;height:32px;
  display:grid;place-items:center;
  border-radius:10px;
  border:1px solid var(--hair);
  background:#f8fafc;
}

.date-block{
  display:flex;flex-direction:column;align-items:center;
  line-height:1.1;font-weight:700;font-size:14px;
}

/* ---------- SORTERING ---------- */
.sort-stack{
  transform:scale(.9);
  display:flex;flex-direction:column;align-items:center;
  padding:4px 6px;border-radius:10px;
  background:#fff;border:1px solid var(--hair);
}
.sort-top{font-size:12px;font-weight:600;margin-bottom:2px}
.sort-bottom{display:flex;gap:4px}

.pill{
  padding:4px 8px;border-radius:999px;font-size:11px;font-weight:600;
  border:1px solid var(--hair);cursor:pointer;user-select:none;
}
.pill.on{background:#dcfce7;color:var(--accent);border-color:#86efac}
.pill.off{background:#f1f5f9;color:#94a3b8;border-color:#cbd5e1}
.pill.lock{opacity:.55;cursor:not-allowed}

/* ---------- HINT ---------- */
.hint{
  position:sticky;top:var(--topbar-h);
  z-index:450;
  height:var(--hint-h);
  font-size:12px;
  color:var(--muted);
  text-align:center;
  line-height:var(--hint-h);
  background:#fff;
  border-bottom:1px solid var(--hair);
}

/* ---------- STICKY ARENA SLOT ---------- */
.group-slot{
  position:sticky;
  top:calc(var(--topbar-h) + var(--hint-h));
  height:var(--slot-h);
  background:#fff;
  z-index:425;
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 12px;
  border-bottom:1px dashed var(--hair);
  font-weight:700;
}

/* ---------- SCROLL ---------- */
.scroll{
  flex:1;overflow-y:auto;overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
  background:var(--bg);
  width:100%;
}

/* ---------- ARENA HEADER (scrollbar) ---------- */
.arena-header{
  background:#fff;
  font-weight:700;
  padding:10px 12px;
  display:flex;justify-content:space-between;
  border-bottom:1px dashed var(--hair);
}
.arena-header.active-hidden{
  height:0;padding:0;margin:0;border:0;overflow:hidden;
}

/* ---------- GAME CARD ---------- */
.game{
  background:#fff;
  padding:8px 12px;
  display:grid;gap:6px;
  border-top:1px dashed var(--hair);
}
.game-top{
  display:flex;align-items:center;gap:8px;
  flex-wrap:nowrap;
}
.game-top.dynamic-scale .game-time,
.game-top.dynamic-scale .game-series a,
.game-top.dynamic-scale .game-mid{
  font-size:var(--dyn,14px);
}
.game-time{font-weight:700;white-space:nowrap}
.game-series a{color:var(--link);font-weight:600;text-decoration:none;white-space:nowrap}
.game-mid{text-align:center;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.game-right{margin-left:auto;color:var(--muted);font-size:12px;white-space:nowrap}

.game-bottom{
  display:grid;grid-template-columns:1fr auto 1fr;
  align-items:center;gap:6px;
}
.team{display:flex;align-items:center;gap:6px;font-weight:600}
.team.right{justify-self:start}
.team-logo{
  width:26px;height:26px;
  border-radius:50%;object-fit:cover;
  border:1px solid var(--hair);background:#f3f4f6;
}
.team-name{
  max-width:min(36vw,150px);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  font-size:clamp(11px,2.4vw,14px);
}
.result a{
  display:inline-flex;justify-content:center;align-items:center;
  min-width:72px;height:26px;padding:0 8px;
  border-radius:8px;border:1px solid var(--hair);
  background:#f1f5f9;color:#111;
  font-weight:700;text-decoration:none;
}
.divider{height:10px;background:var(--bg);border-top:1px dashed var(--hair)}
</style>
</head>

<body>
<div class="device">

<header class="topbar">
  <div class="topbar-inner">
    <div class="cluster-left">
      <button class="icon-btn">üè†</button>
      <button class="icon-btn">üó∫Ô∏è</button>
    </div>
    <div class="cluster-center">
      <button class="icon-btn">‚óÄ</button>
      <div class="date-block">
        <span>Idag</span><span>Tors</span><span>23 okt</span>
      </div>
      <button class="icon-btn">‚ñ∂</button>
    </div>
    <div class="cluster-right">
      <div class="sort-stack">
        <div class="sort-top">Sortering</div>
        <div class="sort-bottom">
          <span id="pillPlace"  class="pill on">Plats</span>
          <span id="pillSeries" class="pill off">Serie</span>
          <span id="pillTime"   class="pill on lock">Tid</span>
        </div>
      </div>
      <button class="icon-btn">‚öôÔ∏è</button>
    </div>
  </div>
</header>

<div class="hint">Visar matcher n√§ra: Kruniusv√§gen 1, Billdal</div>

<div id="groupSlot" class="group-slot">
  <div class="group-title">Kungsbacka Ishall A</div>
  <div class="group-sub">Avst 8 km</div>
</div>

<!-- H√§r fylls scroll-inneh√•llet i del 2 -->
<main id="scrollArea" class="scroll"></main>
<script>
/* =============================
   DATA
   ============================= */

/* Team logos (paths are relative) */
const LOGOS = {
  backen:  "logos/B√§cken_HC__119055af-fc61-4108-82a8-a0cd0e883df0.png",
  grastorp:"logos/Gr√§storps_IK__c6811c5f-e2c9-43e2-a9c2-73ab53f63fd1.png",
  hanhals: "logos/Hanhals_IF__b65395a8-4623-46e4-96ab-97ff2e0e7b72.png",
  kungalv: "logos/Kung√§lvs_IK__620a9df2-1b0b-4bc5-b9eb-7e88670f4c7b.png",
};

/* Arena distances */
const ARENAS = {
  "Kungsbacka Ishall A": 8,
  "√Öse & Viste Arena": 104
};

/* 5 matches in Arena 1, 10 matches in Arena 2 */
const GAMES = [
  /* ------- Kungsbacka Ishall A (5 matcher) ------- */
  { arena:"Kungsbacka Ishall A", series:"HockeyTv√•an S√∂dra", time:"09:00",
    home:{name:"Hanhals IF",logo:LOGOS.hanhals},
    away:{name:"B√§cken HC",logo:LOGOS.backen},   result:"‚Äì" },

  { arena:"Kungsbacka Ishall A", series:"J18 Region S√∂dra", time:"09:40",
    home:{name:"Kung√§lvs IK",logo:LOGOS.kungalv},
    away:{name:"Gr√§storps IK",logo:LOGOS.grastorp}, result:"3 - 2" },

  { arena:"Kungsbacka Ishall A", series:"J20 Region Syd", time:"10:20",
    home:{name:"B√§cken HC U20",logo:LOGOS.backen},
    away:{name:"IF M√∂lndal Hockey",logo:LOGOS.hanhals}, result:"‚Äì" },

  { arena:"Kungsbacka Ishall A", series:"Tr√§ningsmatch", time:"11:00",
    home:{name:"Gr√§storps IK J18",logo:LOGOS.grastorp},
    away:{name:"Kung√§lvs IK J18",logo:LOGOS.kungalv}, result:"2 - 4" },

  { arena:"Kungsbacka Ishall A", series:"HockeyTv√•an V√§stra", time:"11:40",
    home:{name:"Hisingen Hockey",logo:LOGOS.hanhals},
    away:{name:"Partille HK",logo:LOGOS.backen}, result:"‚Äì" },

  /* ------- √Öse & Viste Arena (10 matcher) ------- */
  { arena:"√Öse & Viste Arena", series:"HockeyTv√•an S√∂dra", time:"09:20",
    home:{name:"Gr√§storps IK",logo:LOGOS.grastorp},
    away:{name:"Kung√§lvs IK",logo:LOGOS.kungalv}, result:"‚Äì" },

  { arena:"√Öse & Viste Arena", series:"J20 Region Syd", time:"10:00",
    home:{name:"Hanhals IF",logo:LOGOS.hanhals},
    away:{name:"B√§cken HC",logo:LOGOS.backen}, result:"2 - 2" },

  { arena:"√Öse & Viste Arena", series:"J18 Region S√∂dra", time:"10:40",
    home:{name:"Kung√§lvs IK J18",logo:LOGOS.kungalv},
    away:{name:"Gr√§storps IK J18",logo:LOGOS.grastorp}, result:"‚Äì" },

  { arena:"√Öse & Viste Arena", series:"HockeyTv√•an V√§stra", time:"11:20",
    home:{name:"B√§cken HC",logo:LOGOS.backen},
    away:{name:"Nybro Vikings IF",logo:LOGOS.backen}, result:"‚Äì" },

  { arena:"√Öse & Viste Arena", series:"Tr√§ningsmatch", time:"12:00",
    home:{name:"Gr√§storps IK",logo:LOGOS.grastorp},
    away:{name:"Hisingen Hockey",logo:LOGOS.hanhals}, result:"4 - 1" },

  { arena:"√Öse & Viste Arena", series:"J20 Region Syd", time:"12:40",
    home:{name:"Hanhals IF U20",logo:LOGOS.hanhals},
    away:{name:"IF M√∂lndal Hockey",logo:LOGOS.hanhals}, result:"‚Äì" },

  { arena:"√Öse & Viste Arena", series:"HockeyTv√•an S√∂dra", time:"13:20",
    home:{name:"Kung√§lvs IK",logo:LOGOS.kungalv},
    away:{name:"Troja-Ljungby",logo:LOGOS.hanhals}, result:"‚Äì" },

  { arena:"√Öse & Viste Arena", series:"J18 Region S√∂dra", time:"14:00",
    home:{name:"B√§cken HC J18",logo:LOGOS.backen},
    away:{name:"Kalmar HC",logo:LOGOS.backen}, result:"3 - 0" },

  { arena:"√Öse & Viste Arena", series:"HockeyTv√•an V√§stra", time:"14:40",
    home:{name:"Gr√§storps IK",logo:LOGOS.grastorp},
    away:{name:"Partille HK",logo:LOGOS.backen}, result:"‚Äì" },

  { arena:"√Öse & Viste Arena", series:"Tr√§ningsmatch", time:"15:20",
    home:{name:"IF M√∂lndal Hockey",logo:LOGOS.hanhals},
    away:{name:"K√•llereds SK",logo:LOGOS.hanhals}, result:"‚Äì" },
];
/* =============================
   HELPERS & RENDERING
   ============================= */

/* DOM refs */
const scroll   = document.getElementById('scrollArea');
const groupSlot= document.getElementById('groupSlot');
const pillPlace  = document.getElementById('pillPlace');
const pillSeries = document.getElementById('pillSeries');
const pillTime   = document.getElementById('pillTime');

/* Modes */
const MODE = { PLACE:'place', SERIES:'series', SERIES_TIME:'series_time' };
let mode = MODE.PLACE;

/* Utilities */
function parseTime(t){const [H,M]=t.split(':').map(Number);return H*60+M;}
function km(arena){return ARENAS[arena] ?? 0;}
function seriesPriority(name){
  const n = (name||'').toLowerCase();
  if(n.includes('shl')) return 1;
  if(n.includes('ha') || n.includes('allsvenskan')) return 2;
  if(n.includes('sdhl')) return 3;
  if(n.includes('hockeyettan')) return 4;
  if(n.includes('hockeytv√•an')) return 10;
  if(n.includes('ndhl')) return 11;
  if(n.includes('hockeytrean')) return 12;
  if(n.includes('damtv√•an')) return 13;
  if(n.includes('hockeyfyran')) return 14;
  if(n.includes('j20')||n.includes('u20')) return 20;
  if(n.includes('j18')||n.includes('u18')) return 22;
  if(n.includes('tr√§nings')) return 90;
  return 50;
}

/* Sorting */
function sortGames(){
  if(mode===MODE.PLACE){
    return [...GAMES].sort((a,b)=> km(a.arena)-km(b.arena) || parseTime(a.time)-parseTime(b.time));
  }else if(mode===MODE.SERIES){
    return [...GAMES].sort((a,b)=> seriesPriority(a.series)-seriesPriority(b.series) || parseTime(a.time)-parseTime(b.time));
  }else{ // SERIES_TIME
    return [...GAMES].sort((a,b)=> parseTime(a.time)-parseTime(b.time) || seriesPriority(a.series)-seriesPriority(b.series));
  }
}

/* Card builders */
function gameCard(g, seriesMode){
  const a=document.createElement('article'); a.className='game'; a.dataset.arena=g.arena;
  const top=document.createElement('div'); top.className=seriesMode?'game-top dynamic-scale':'game-top';
  const t = `<div class="game-time">${g.time}</div>`;
  const s = `<div class="game-series"><a href="#">${g.series}</a></div>`;
  const midRight = seriesMode ? `<div class="game-mid">${g.arena}</div><div class="game-right">Avst ${km(g.arena)} km</div>` : '';
  top.innerHTML = t + s + midRight;

  const bottom=document.createElement('div'); bottom.className='game-bottom';
  bottom.innerHTML = `
    <div class="team"><img class="team-logo" src="${g.home.logo}" alt=""><span class="team-name">${g.home.name}</span></div>
    <div class="result"><a href="#">${g.result}</a></div>
    <div class="team right"><img class="team-logo" src="${g.away.logo}" alt=""><span class="team-name">${g.away.name}</span></div>
  `;

  a.appendChild(top); a.appendChild(bottom);
  return a;
}

/* Pills styling + clicks */
function applyPills(){
  pillPlace.className  = (mode===MODE.PLACE) ? 'pill on' : 'pill off';
  pillSeries.className = (mode===MODE.SERIES || mode===MODE.SERIES_TIME) ? 'pill on' : 'pill off';
  pillTime.className   = (mode===MODE.PLACE) ? 'pill on lock' : (mode===MODE.SERIES_TIME ? 'pill on' : 'pill off');
}
pillPlace.onclick  = ()=> setMode(MODE.PLACE);
pillSeries.onclick = ()=> setMode(MODE.SERIES);
pillTime.onclick   = ()=> { if(mode!==MODE.PLACE) setMode(mode===MODE.SERIES ? MODE.SERIES_TIME : MODE.SERIES); };

/* Auto-scale top row (Serie-l√§ge) */
function autoScaleTopRows(){
  if(mode===MODE.PLACE) return;
  const rows = scroll.querySelectorAll('.game-top.dynamic-scale');
  rows.forEach(row=>{
    let f=14; row.style.setProperty('--dyn', f+'px');
    // krymp tills det f√•r plats, men inte mindre √§n 11px
    while(row.scrollWidth > row.clientWidth && f>11){
      f -= 1; row.style.setProperty('--dyn', f+'px');
    }
  });
}

/* Render list */
let arenaOrder = [];
let currentArena = null;

function render(){
  scroll.innerHTML = '';
  const list = sortGames();

  if(mode===MODE.PLACE){
    // gruppera per arena
    const byArena = {};
    for(const g of list)(byArena[g.arena]??=[]).push(g);
    arenaOrder = Object.keys(byArena).sort((a,b)=> km(a)-km(b));

    // init sticky header
    currentArena = arenaOrder[0] || null;
    if(currentArena){
      document.querySelector('.group-title').textContent = currentArena;
      document.querySelector('.group-sub').textContent   = `Avst ${km(currentArena)} km`;
    }

    // bygg sektioner
    arenaOrder.forEach((arena, idx)=>{
      if(idx>0){ const d=document.createElement('div'); d.className='divider'; scroll.appendChild(d); }
      const h = document.createElement('div'); h.className='arena-header'; h.dataset.arenaHeader = arena;
      h.innerHTML = `<div>${arena}</div><div>Avst ${km(arena)} km</div>`;
      if(idx===0) h.classList.add('active-hidden'); // undvik dubblett f√∂r aktiv arena
      scroll.appendChild(h);

      const games = byArena[arena].slice().sort((a,b)=> parseTime(a.time)-parseTime(b.time));
      games.forEach(g=> scroll.appendChild(gameCard(g,false)));
    });

    updateStickyArena(true);
  } else {
    // Serie-l√§gen: inga arena-headers
    arenaOrder = [];
    const seriesMode = true;

    if(mode===MODE.SERIES){
      const bySeries = {};
      for(const g of list)(bySeries[g.series]??=[]).push(g);
      const keys = Object.keys(bySeries).sort((a,b)=> seriesPriority(a)-seriesPriority(b) || a.localeCompare(b,'sv'));
      let first=true;
      keys.forEach(k=>{
        const games = bySeries[k].slice().sort((a,b)=> parseTime(a.time)-parseTime(b.time));
        if(!first){ const d=document.createElement('div'); d.className='divider'; scroll.appendChild(d); }
        first=false;
        games.forEach(g=> scroll.appendChild(gameCard(g,seriesMode)));
      });
    } else { // SERIES_TIME
      list.forEach(g=> scroll.appendChild(gameCard(g,seriesMode)));
    }
    autoScaleTopRows();
  }
}

/* =============================
   STICKY ARENA SWITCHING
   ============================= */

/*
 Ned√•t: byt till n√§sta arena n√§r sticky-f√§ltet t√§cker >= 50% av n√§sta arenas HEADER.
 Upp√•t: (1) l√§gg tillbaka aktuell arenas header n√§r dess f√∂rsta match n√•r sticky-bottom,
        (2) byt till f√∂reg√•ende arena n√§r dess header √§r 100% synlig inom scroll-ytan.
*/
let lastChangeTs = 0;

function updateStickyArena(force=false){
  if(mode!==MODE.PLACE || !arenaOrder.length) return;

  const now = performance.now();
  const debounced = (now - lastChangeTs < 20); // mild debounce mot fladdrande

  const slotRect = groupSlot.getBoundingClientRect();
  const slotBottom = slotRect.bottom;

  // Synligt scrollf√∂nster (mellan sticky-bottom och scrollens synliga botten)
  const scrollRect = scroll.getBoundingClientRect();
  const viewTop    = slotBottom;
  const viewBottom = scrollRect.bottom;

  // Samla headers i aktuell ordning
  const headers = arenaOrder.map(a=> document.querySelector(`.arena-header[data-arena-header="${a}"]`));

  let next = currentArena || arenaOrder[0];
  const idx = arenaOrder.indexOf(currentArena);

  // --- UPP√ÖT steg (1): l√§gg tillbaka aktuell arenas header n√§r dess f√∂rsta match n√•r sticky-bottom
  if(idx >= 0){
    const currArena  = arenaOrder[idx];
    const currHeader = document.querySelector(`.arena-header[data-arena-header="${currArena}"]`);
    const firstCard  = document.querySelector(`.game[data-arena="${currArena}"]`);
    if(currHeader && firstCard){
      const fr = firstCard.getBoundingClientRect();
      if(fr.top >= slotBottom){
        // Toppen p√• f√∂rsta kortet √§r under sticky ‚Üí headern ska vara synlig i listan
        currHeader.classList.remove('active-hidden');
      } else {
        // Annars d√∂ljer vi headern f√∂r den aktiva arenan (f√∂r att undvika dubblett)
        currHeader.classList.add('active-hidden');
      }
    }
  }

  // --- NED√ÖT: byt n√§r sticky t√§cker >= 50% av n√§sta arenas HEADER
  if(idx >= 0 && idx < arenaOrder.length-1){
    const nh = document.querySelector(`.arena-header[data-arena-header="${arenaOrder[idx+1]}"]`);
    if(nh){
      const r = nh.getBoundingClientRect();
      const overlap = Math.max(0, slotBottom - r.top); // hur mycket sticky √∂verlappar headern
      if(overlap >= r.height*0.5){
        next = arenaOrder[idx+1];
      }
    }
  }

  // --- UPP√ÖT steg (2): byt f√∂rst n√§r f√∂reg√•ende arenas header √§r 100% synlig
  if(idx > 0){
    const ph = document.querySelector(`.arena-header[data-arena-header="${arenaOrder[idx-1]}"]`);
    if(ph){
      const r = ph.getBoundingClientRect();
      const fullyVisible = (r.top >= viewTop) && (r.bottom <= viewBottom);
      if(fullyVisible){
        next = arenaOrder[idx-1];
      }
    }
  }

  // Byt arena?
  if(next !== currentArena || force){
    if(!force && debounced) return; // undvik f√∂r t√§ta byten
    lastChangeTs = now;

    currentArena = next;

    // uppdatera sticky text
    const titleEl = document.querySelector('.group-title');
    const subEl   = document.querySelector('.group-sub');
    if(titleEl) titleEl.textContent = currentArena;
    if(subEl)   subEl.textContent   = `Avst ${km(currentArena)} km`;

    // D√∂lj endast den aktiva arenans in-list-header
    headers.forEach(h=>{
      if(!h) return;
      const isActive = (h.dataset.arenaHeader === currentArena);
      h.classList.toggle('active-hidden', isActive);
    });
  }
}

/* =============================
   MODE SWITCH
   ============================= */
function setMode(m){
  mode = m;
  applyPills();
  render();
  groupSlot.style.display = (mode===MODE.PLACE) ? 'flex' : 'none';
}

/* =============================
   INIT
   ============================= */
applyPills();
render();

/* Scroll listener f√∂r sticky logik */
scroll.addEventListener('scroll', ()=> updateStickyArena(false));

</script>
</main>
</div>
</body>
</html>

