<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="theme-color" content="#ffffff" />
<title>LocalSport v14.4 – iPhone Sticky förbättrad</title>
<style>
/* --- samma CSS som v14.3 --- (oförändrat, utelämnat här för tydlighet) */
</style>
</head>
<body>
<div class="device">

<header class="topbar">
  <!-- exakt samma header som v14.3 -->
</header>

<div class="hint">Visar matcher nära: Kruniusvägen 1, Billdal (57.590214, 11.946082)</div>

<div id="groupSlot" class="group-slot">
  <div class="group-title">Kungsbacka Ishall A</div>
  <div class="group-sub">Avst 8 km</div>
</div>

<main id="scrollArea" class="scroll"></main>

</div>

<script>
/* ------- data (matcher + logos) IDENTISK med v14.3 ------- */
const LOGOS = {...};        // exakt samma som v14.3
const ARENAS = {...};       // exakt samma
const GAMES = [...];        // exakt samma

/* ------- MODE och pill handlers IDENTISK med v14.3 ------- */
const MODE = { PLACE:'place', SERIES:'series', SERIES_TIME:'series_time' };
let mode = MODE.PLACE;
...
/* UI pill logic – samma som v14.3 */
...

/* Build game card – samma som v14.3 */
function gameCard(g, seriesMode){ ... }

/* ✅ v14.4 — Förbättrad hysteresis & debounce för iPhone */
let currentArena = null;
let lastScrollY = 0;
let lastSwitchTime = 0;             // <--- ny, debounce timer
let stableDirection = null;         // <--- ny, direction state

function updateStickyFromHeaders(){

  const headers = Array.from(scroll.querySelectorAll('.arena-header'));
  if (!headers.length) return;

  const y = scroll.scrollTop;
  const now = performance.now();

  // 1) direction stabilizer
  const dirNow = (y > lastScrollY) ? "down" : "up";
  if (stableDirection !== dirNow) {
      stableDirection = dirNow;
      lastSwitchTime = now;        // byt inte arena direkt vid riktningbyte
      lastScrollY = y;
      return;
  }

  // 2) kräver minst 60ms stabil riktning
  if (now - lastSwitchTime < 60) {
      lastScrollY = y;
      return;
  }

  lastScrollY = y;

  const baseTop = scroll.getBoundingClientRect().top;

  // ✅ större hysteresis specifikt för iPhone sticky-bounce
  const enter = baseTop + (stableDirection === "down" ? 95 : 65);
  const exit  = baseTop + (stableDirection === "down" ? 65 : 95);

  let candidate = currentArena;

  for (const h of headers){
    const topY = h.getBoundingClientRect().top;

    if (stableDirection === "down") {
      if (topY <= enter) candidate = h.dataset.arenaHeader;
    } else {
      if (topY <= exit)  candidate = h.dataset.arenaHeader;
    }
  }

  if (candidate !== currentArena){
    currentArena = candidate;
    document.querySelector('.group-title').textContent = currentArena;
    document.querySelector('.group-sub').textContent   = `Avst ${ARENAS[currentArena]} km`;
    headers.forEach(h => h.classList.toggle('active-hidden', h.dataset.arenaHeader === currentArena));
  }
}

/* Rendering (identisk med v14.3) */
function render(){ ... }

/* Init */
applyPills();
render();
</script>
</body>
</html>

