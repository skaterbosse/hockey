<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="theme-color" content="#ffffff" />
<title>LocalSport v17.9</title>
<style>
:root{
  --topbar-h:56px; --hint-h:26px; --slot-h:42px;
  --bg:#f0f3f8; --hair:#e2e8f0; --text:#0f172a; --muted:#64748b; --accent:#16a34a; --link:#2563eb;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;height:100%;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Roboto,Arial,Helvetica,sans-serif;overscroll-behavior:none}
.device{width:100%;height:100dvh;display:flex;flex-direction:column;overflow:hidden}

/* Top bar */
.topbar{position:sticky;top:0;z-index:500;background:#fff;border-bottom:1px solid var(--hair)}
.topbar-inner{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;height:var(--topbar-h);padding:6px 8px}
.cluster-left,.cluster-right{display:flex;gap:8px;align-items:center}
.cluster-center{display:flex;align-items:center;justify-content:center;gap:8px}
.icon-btn{width:32px;height:32px;display:grid;place-items:center;border-radius:10px;border:1px solid var(--hair);background:#f1f5f9}
.date-block{display:flex;flex-direction:column;align-items:center;justify-content:center;line-height:1.05;font-weight:700;font-size:13.5px}

/* Sortering pills */
.sort-stack{border:1px solid var(--hair);border-radius:10px;background:#fff;padding:4px 6px;display:flex;flex-direction:column;align-items:center;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.sort-top{font-size:12px;font-weight:600;margin-bottom:2px}
.sort-bottom{display:flex;gap:4px}
.pill{padding:4px 8px;border-radius:999px;font-size:11px;font-weight:600;border:1px solid var(--hair);cursor:pointer;user-select:none}
.pill.on{background:#dcfce7;color:var(--accent);border-color:#86efac}
.pill.off{background:#f1f5f9;color:#94a3b8;border-color:#cbd5e1}
.pill.lock{opacity:.65;cursor:not-allowed}

/* Hint row */
.hint{position:sticky;top:var(--topbar-h);z-index:450;height:var(--hint-h);line-height:var(--hint-h);font-size:12px;color:var(--muted);text-align:center;background:#fff;border-bottom:1px solid var(--hair)}

/* Sticky arena slot (Plats) */
.group-slot{position:sticky;top:calc(var(--topbar-h) + var(--hint-h));z-index:425;height:var(--slot-h);background:#fff;border-bottom:1px dashed var(--hair);display:flex;align-items:center;justify-content:space-between;padding:10px 12px;font-weight:700}

/* Scroll area */
.scroll{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;background:var(--bg)}

/* Arena header in scroll (Plats) */
.arena-header{background:#fff;padding:10px 12px;border-bottom:1px dashed var(--hair);font-weight:700;display:flex;justify-content:space-between}
.arena-header.active-hidden{height:0;padding:0;margin:0;border:0;visibility:hidden;overflow:hidden}

/* Divider */
.divider{height:8px;background:var(--bg);border-top:1px dashed var(--hair)}

/* Game card */
.game{padding:8px 12px;background:#fff;border-top:1px dashed #e5e7eb;display:grid;gap:6px}
.game-top{display:flex;align-items:center;gap:8px;flex-wrap:nowrap}
.game-time{font-weight:700;white-space:nowrap;flex:0 0 auto}
.game-series a{color:var(--link);text-decoration:none;font-weight:600;white-space:nowrap}
.game-mid{flex:1 1 auto;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:700}
.game-right{flex:0 0 auto;white-space:nowrap;color:var(--muted);font-size:12px}
.game-bottom{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:6px}
.team{display:inline-flex;align-items:center;gap:6px;font-weight:600}
.team.right{justify-self:start;text-align:left}
.team-logo{width:26px;height:26px;border-radius:50%;border:1px solid var(--hair);object-fit:cover;background:#f2f2f2}
.team-name{max-width:min(38vw,165px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:13px}
.result a{display:inline-flex;align-items:center;justify-content:center;min-width:72px;height:26px;padding:0 10px;border-radius:8px;border:1px solid var(--hair);background:#f1f5f9;font-weight:700;color:#0f172a;text-decoration:none}

/* Series view‚Äîauto scale top row text if tight */
.game-top.dynamic-scale .game-time,.game-top.dynamic-scale .game-series a,.game-top.dynamic-scale .game-mid{font-size:var(--dyn-font,14px)}

@media (min-width:768px){.device{max-width:720px;margin:auto}}
@media (min-width:1024px){.device{max-width:840px}}
</style>
</head>
<body>
<div class="device">

  <!-- Top bar -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="cluster-left">
        <button class="icon-btn" aria-label="Hem">üè†</button>
        <button class="icon-btn" aria-label="Karta">üó∫Ô∏è</button>
      </div>
      <div class="cluster-center">
        <button class="icon-btn" aria-label="F√∂reg√•ende dag" id="btnPrev">‚óÄ</button>
        <div class="date-block">
          <span>Idag</span>
          <span>Tors</span>
          <span>23 okt</span>
        </div>
        <button class="icon-btn" aria-label="N√§sta dag" id="btnNext">‚ñ∂</button>
      </div>
      <div class="cluster-right">
        <div class="sort-stack">
          <div class="sort-top">Sortering</div>
          <div class="sort-bottom">
            <span id="pillPlace"  class="pill on">Plats</span>
            <span id="pillSeries" class="pill off">Serie</span>
            <span id="pillTime"   class="pill on lock">Tid</span>
          </div>
        </div>
        <button class="icon-btn" aria-label="Inst√§llningar">‚öôÔ∏è</button>
      </div>
    </div>
  </header>

  <!-- Hint -->
  <div class="hint">Visar matcher n√§ra: Kruniusv√§gen 1, Billdal</div>

  <!-- Sticky arena slot -->
  <div id="groupSlot" class="group-slot">
    <div class="group-title">Kungsbacka Ishall A</div>
    <div class="group-sub">Avst 8 km</div>
  </div>

  <!-- Scroll content -->
  <main id="scrollArea" class="scroll"></main>

</div>

<script>
/* ============ DATA ============ */
const LOGOS = {
  backen:"logos/B√§cken_HC__119055af-fc61-4108-82a8-a0cd0e883df0.png",
  grastorp:"logos/Gr√§storps_IK__c6811c5f-e2c9-43e2-a9c2-73ab53f63fd1.png",
  hanhals:"logos/Hanhals_IF__b65395a8-4623-46e4-96ab-97ff2e0e7b72.png",
  kungalv:"logos/Kung√§lvs_IK__620a9df2-1b0b-4bc5-b9eb-7e88670f4c7b.png",
};

const ARENAS = {"Kungsbacka Ishall A":8,"√Öse & Viste Arena":104};

const GAMES = [
  // Kungsbacka (5)
  { arena:"Kungsbacka Ishall A", series:"HockeyTv√•an S√∂dra", time:"09:00", home:{name:"Hanhals IF",logo:LOGOS.hanhals}, away:{name:"B√§cken HC",logo:LOGOS.backen}, result:"‚Äì" },
  { arena:"Kungsbacka Ishall A", series:"J18 Region S√∂dra",   time:"09:40", home:{name:"Kung√§lvs IK",logo:LOGOS.kungalv}, away:{name:"Gr√§storps IK",logo:LOGOS.grastorp}, result:"3 - 2" },
  { arena:"Kungsbacka Ishall A", series:"J20 Region Syd",     time:"10:20", home:{name:"B√§cken HC U20",logo:LOGOS.backen}, away:{name:"IF M√∂lndal Hockey",logo:LOGOS.hanhals}, result:"‚Äì" },
  { arena:"Kungsbacka Ishall A", series:"Tr√§ningsmatch",      time:"11:00", home:{name:"Gr√§storps IK J18",logo:LOGOS.grastorp}, away:{name:"Kung√§lvs IK J18",logo:LOGOS.kungalv}, result:"2 - 4" },
  { arena:"Kungsbacka Ishall A", series:"HockeyTv√•an V√§stra", time:"11:40", home:{name:"Hisingen Hockey",logo:LOGOS.hanhals}, away:{name:"Partille HK",logo:LOGOS.backen}, result:"‚Äì" },
  // √Öse & Viste (15)
  { arena:"√Öse & Viste Arena",   series:"HockeyTv√•an S√∂dra",  time:"09:20", home:{name:"Gr√§storps IK",logo:LOGOS.grastorp}, away:{name:"Kung√§lvs IK",logo:LOGOS.kungalv}, result:"‚Äì" },
  { arena:"√Öse & Viste Arena",   series:"J20 Region Syd",      time:"10:00", home:{name:"Hanhals IF",logo:LOGOS.hanhals}, away:{name:"B√§cken HC",logo:LOGOS.backen}, result:"2 - 2" },
  { arena:"√Öse & Viste Arena",   series:"J18 Region S√∂dra",    time:"10:40", home:{name:"Kung√§lvs IK J18",logo:LOGOS.kungalv}, away:{name:"Gr√§storps IK J18",logo:LOGOS.grastorp}, result:"‚Äì" },
  { arena:"√Öse & Viste Arena",   series:"HockeyTv√•an V√§stra",  time:"11:20", home:{name:"B√§cken HC",logo:LOGOS.backen}, away:{name:"Nybro Vikings IF",logo:LOGOS.backen}, result:"‚Äì" },
  { arena:"√Öse & Viste Arena",   series:"Tr√§ningsmatch",       time:"12:00", home:{name:"Gr√§storps IK",logo:LOGOS.grastorp}, away:{name:"Hisingen Hockey",logo:LOGOS.hanhals}, result:"4 - 1" },
  { arena:"√Öse & Viste Arena",   series:"J20 Region Syd",      time:"12:40", home:{name:"Hanhals IF U20",logo:LOGOS.hanhals}, away:{name:"IF M√∂lndal Hockey",logo:LOGOS.hanhals}, result:"‚Äì" },
  { arena:"√Öse & Viste Arena",   series:"HockeyTv√•an S√∂dra",   time:"13:20", home:{name:"Kung√§lvs IK",logo:LOGOS.kungalv}, away:{name:"Troja-Ljungby",logo:LOGOS.hanhals}, result:"‚Äì" },
  { arena:"√Öse & Viste Arena",   series:"J18 Region S√∂dra",    time:"14:00", home:{name:"B√§cken HC J18",logo:LOGOS.backen}, away:{name:"Kalmar HC",logo:LOGOS.backen}, result:"3 - 0" },
  { arena:"√Öse & Viste Arena",   series:"HockeyTv√•an V√§stra",  time:"14:40", home:{name:"Gr√§storps IK",logo:LOGOS.grastorp}, away:{name:"Partille HK",logo:LOGOS.backen}, result:"‚Äì" },
  { arena:"√Öse & Viste Arena",   series:"Tr√§ningsmatch",       time:"15:20", home:{name:"IF M√∂lndal Hockey",logo:LOGOS.hanhals}, away:{name:"K√•llereds SK",logo:LOGOS.hanhals}, result:"‚Äì" },
  { arena:"√Öse & Viste Arena",   series:"J18 Region S√∂dra",    time:"16:00", home:{name:"Gr√§storps IK J18",logo:LOGOS.grastorp}, away:{name:"Kung√§lvs IK J18",logo:LOGOS.kungalv}, result:"‚Äì" },
  { arena:"√Öse & Viste Arena",   series:"J20 Region Syd",      time:"16:40", home:{name:"B√§cken HC U20",logo:LOGOS.backen}, away:{name:"Hanhals IF U20",logo:LOGOS.hanhals}, result:"‚Äì" },
  { arena:"√Öse & Viste Arena",   series:"HockeyTv√•an S√∂dra",   time:"17:20", home:{name:"Kung√§lvs IK",logo:LOGOS.kungalv}, away:{name:"Gr√§storps IK",logo:LOGOS.grastorp}, result:"‚Äì" },
  { arena:"√Öse & Viste Arena",   series:"Tr√§ningsmatch",       time:"18:00", home:{name:"B√§cken HC",logo:LOGOS.backen}, away:{name:"Hisingen Hockey",logo:LOGOS.hanhals}, result:"‚Äì" },
  { arena:"√Öse & Viste Arena",   series:"HockeyTv√•an V√§stra",  time:"18:40", home:{name:"Gr√§storps IK",logo:LOGOS.grastorp}, away:{name:"Kung√§lvs IK",logo:LOGOS.kungalv}, result:"‚Äì" },
];

/* ============ SORT MODES & DOM ============ */
const MODE={PLACE:'place',SERIES:'series',SERIES_TIME:'series_time'}; let mode=MODE.PLACE;
const pillPlace=document.getElementById('pillPlace'), pillSeries=document.getElementById('pillSeries'), pillTime=document.getElementById('pillTime');
const scroll=document.getElementById('scrollArea'), slot=document.getElementById('groupSlot');
let currentArena=null, arenaOrder=[], lastScrollTop=0;

/* Helpers */
function km(ar){return ARENAS[ar]??0}
function parseTime(t){const [H,M]=t.split(':').map(Number);return H*60+M}
function seriesPriority(s){
  const n=s.toLowerCase();
  if(n.includes('hockeytv√•an'))return 10;
  if(n.includes('j20')||n.includes('u20'))return 14;
  if(n.includes('j18')||n.includes('u18'))return 15;
  if(n.includes('tr√§nings'))return 99;
  return 50;
}

/* Sorting */
function sortGames(){
  if(mode===MODE.PLACE) return [...GAMES].sort((a,b)=> km(a.arena)-km(b.arena) || parseTime(a.time)-parseTime(b.time));
  if(mode===MODE.SERIES) return [...GAMES].sort((a,b)=> seriesPriority(a.series)-seriesPriority(b.series) || parseTime(a.time)-parseTime(b.time));
  return [...GAMES].sort((a,b)=> parseTime(a.time)-parseTime(b.time) || seriesPriority(a.series)-seriesPriority(b.series));
}

/* Render pieces */
function gameCard(g, seriesMode){
  const a=document.createElement('article'); a.className='game'; a.dataset.arena=g.arena;
  const top=document.createElement('div'); top.className=seriesMode?'game-top dynamic-scale':'game-top';
  const left=`<div class="game-time">${g.time}</div><div class="game-series"><a href="#">${g.series}</a></div>`;
  const midRight = seriesMode ? `<div class="game-mid">${g.arena}</div><div class="game-right">Avst ${km(g.arena)} km</div>` : '';
  top.innerHTML = left + midRight;
  const bottom=document.createElement('div'); bottom.className='game-bottom';
  bottom.innerHTML = `
    <div class="team"><img class="team-logo" src="${g.home.logo}" alt=""><span class="team-name">${g.home.name}</span></div>
    <div class="result"><a href="#">${g.result}</a></div>
    <div class="team right"><img class="team-logo" src="${g.away.logo}" alt=""><span class="team-name">${g.away.name}</span></div>`;
  a.appendChild(top); a.appendChild(bottom);
  return a;
}

function render(){
  scroll.innerHTML = '';
  const list = sortGames();

  if(mode===MODE.PLACE){
    const byArena={}; list.forEach(g=> (byArena[g.arena]??=[]).push(g));
    arenaOrder = Object.keys(byArena).sort((a,b)=> km(a)-km(b));
    currentArena = arenaOrder[0] || null;
    if(currentArena){
      slot.querySelector('.group-title').textContent=currentArena;
      slot.querySelector('.group-sub').textContent=`Avst ${km(currentArena)} km`;
    }
    arenaOrder.forEach((aName,idx)=>{
      if(idx>0){ const d=document.createElement('div'); d.className='divider'; scroll.appendChild(d); }
      const hdr=document.createElement('div'); hdr.className='arena-header'; hdr.dataset.arenaHeader=aName;
      hdr.innerHTML=`<div>${aName}</div><div>Avst ${km(aName)} km</div>`;
      if(idx===0) hdr.classList.add('active-hidden');
      scroll.appendChild(hdr);

      byArena[aName].slice().sort((x,y)=> parseTime(x.time)-parseTime(y.time))
                      .forEach(g=> scroll.appendChild(gameCard(g,false)));
    });
    slot.style.display='flex';
  } else {
    arenaOrder=[]; currentArena=null; slot.style.display='none';
    const seriesMode=true;
    if(mode===MODE.SERIES){
      const bySeries={}; list.forEach(g=> (bySeries[g.series]??=[]).push(g));
      const keys=Object.keys(bySeries).sort((a,b)=> seriesPriority(a)-seriesPriority(b) || a.localeCompare(b,'sv'));
      let first=true;
      keys.forEach(s=>{
        const gs=bySeries[s].slice().sort((a,b)=> parseTime(a.time)-parseTime(b.time));
        if(!first){ const d=document.createElement('div'); d.className='divider'; scroll.appendChild(d); }
        first=false; gs.forEach(g=> scroll.appendChild(gameCard(g,seriesMode)));
      });
    } else {
      list.forEach(g=> scroll.appendChild(gameCard(g,seriesMode)));
    }
    autoScaleTopRows();
  }

  // reset scroll state & apply sticky state once
  lastScrollTop = scroll.scrollTop;
  updateStickyArena(true);
}

/* Auto-scale for series rows (fit text without wrapping) */
function autoScaleTopRows(){
  if(mode===MODE.PLACE) return;
  const rows=scroll.querySelectorAll('.game-top.dynamic-scale');
  rows.forEach(row=>{
    let f=14; row.style.setProperty('--dyn-font', f+'px');
    while(row.scrollWidth>row.clientWidth && f>11){
      f--; row.style.setProperty('--dyn-font', f+'px');
    }
  });
}

/* Pills */
function applyPills(){
  pillPlace.className=(mode===MODE.PLACE)?'pill on':'pill off';
  pillSeries.className=(mode===MODE.SERIES||mode===MODE.SERIES_TIME)?'pill on':'pill off';
  pillTime.className=(mode===MODE.PLACE)?'pill on lock':(mode===MODE.SERIES_TIME?'pill on':'pill off');
}
pillPlace.onclick = ()=>{ mode=MODE.PLACE; applyPills(); render(); };
pillSeries.onclick= ()=>{ mode=MODE.SERIES; applyPills(); render(); };
pillTime.onclick  = ()=>{ if(mode!==MODE.PLACE){ mode=(mode===MODE.SERIES)?MODE.SERIES_TIME:MODE.SERIES; applyPills(); render(); } };

/* ===== Sticky arena switching (with iPhone fix) =====
   Down: switch when sticky covers >= 50% of next header.
   Up:   switch only after current header is >=95% visible inside the scroll container AND its top is below the sticky edge.
*/
function visiblePercentInContainer(rect, containerRect){
  const interTop = Math.max(rect.top, containerRect.top);
  const interBot = Math.min(rect.bottom, containerRect.bottom);
  const inter = Math.max(0, interBot - interTop);
  return inter / Math.max(1, rect.height);
}

function updateStickyArena(force=false){
  if(mode!==MODE.PLACE || !arenaOrder.length){ return; }

  const st = scroll.scrollTop;
  const dir = (st > lastScrollTop) ? 'down' : (st < lastScrollTop ? 'up' : 'none');
  lastScrollTop = st;

  const slotRect = slot.getBoundingClientRect();
  const stickyBottom = slotRect.bottom;
  const contRect = scroll.getBoundingClientRect();

  let next = currentArena || arenaOrder[0];
  const idx = arenaOrder.indexOf(currentArena);

  // down: 50% coverage of next header
  if(dir==='down' && idx>=0 && idx < arenaOrder.length-1){
    const nh = document.querySelector(`.arena-header[data-arena-header="${arenaOrder[idx+1]}"]`);
    if(nh){
      const r = nh.getBoundingClientRect();
      const covered = Math.max(0, stickyBottom - r.top);
      if(covered >= r.height * 0.5){ next = arenaOrder[idx+1]; }
    }
  }

  // up: wait until current header is >=95% visible inside container AND below sticky edge
  if(dir==='up' && idx>0){
    const currHdr = document.querySelector(`.arena-header[data-arena-header="${arenaOrder[idx]}"]`);
    if(currHdr){
      const r = currHdr.getBoundingClientRect();
      const vp = visiblePercentInContainer(r, contRect);
      if(r.top >= stickyBottom && vp >= 0.95){
        next = arenaOrder[idx-1];
      }
    }
  }

  if(force || next !== currentArena){
    currentArena = next;
    if(currentArena){
      document.querySelector('.group-title').textContent = currentArena;
      document.querySelector('.group-sub').textContent   = `Avst ${km(currentArena)} km`;
    }
    // show all headers except the active one
    arenaOrder.forEach(name=>{
      const h=document.querySelector(`.arena-header[data-arena-header="${name}"]`);
      if(h) h.classList.toggle('active-hidden', name===currentArena);
    });
  }
}

/* Init */
applyPills();
render();
scroll.addEventListener('scroll', ()=> updateStickyArena(false));
</script>
</body>
</html>

