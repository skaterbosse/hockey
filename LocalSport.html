<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="theme-color" content="#ffffff" />
<title>LocalSport v14.6 ‚Äì Stabil iPhone sticky + fade</title>
<style>
:root{
  --topbar-h:56px;
  --hint-h:26px;
  --slot-h:42px;
  --hair:#e2e8f0;
  --bg:#f0f3f8;
  --card:#fff;
  --text:#0f172a;
  --muted:#64748b;
  --accent:#16a34a;
  --link:#2563eb;
}
*{box-sizing:border-box}
html,body{
  margin:0;padding:0;height:100%;
  background:var(--bg);color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,Roboto,Arial,Helvetica,sans-serif;
  overscroll-behavior:none;
}
.device{width:100%;height:100dvh;overflow:hidden;display:flex;flex-direction:column}

/* ====== LAGER 1: Topbar ====== */
.topbar{position:sticky;top:0;z-index:500;background:#fff;border-bottom:1px solid var(--hair)}
.topbar-inner{
  display:grid;grid-template-columns:1fr auto 1fr;align-items:center;
  gap:6px;padding:6px 8px;height:var(--topbar-h)
}
.cluster-left,.cluster-right{display:flex;align-items:center;gap:8px}
.cluster-center{display:flex;align-items:center;justify-content:center;gap:8px}
.icon-btn{
  width:32px;height:32px;display:grid;place-items:center;
  border-radius:10px;border:1px solid var(--hair);background:#f1f5f9
}
.date-block{
  display:flex;flex-direction:column;align-items:center;
  line-height:1.1;font-weight:700;font-size:14px
}
.sort-stack{
  transform:scale(.9);display:flex;flex-direction:column;align-items:center;
  padding:4px 6px;border:1px solid var(--hair);border-radius:10px;background:#fff;
  box-shadow:0 1px 2px rgba(0,0,0,.04)
}
.sort-top{font-size:12px;font-weight:600;margin-bottom:2px;text-align:center}
.sort-bottom{display:flex;gap:4px}
.pill{
  padding:4px 8px;border-radius:999px;font-size:11px;font-weight:600;
  border:1px solid var(--hair);cursor:pointer;user-select:none
}
.pill.on{background:#dcfce7;color:var(--accent);border-color:#86efac}
.pill.off{background:#f1f5f9;color:#94a3b8;border-color:#cbd5e1}
.pill.lock{opacity:.6;cursor:not-allowed}

/* ====== LAGER 2: Hint ====== */
.hint{
  position:sticky;top:var(--topbar-h);z-index:450;color:var(--muted);font-size:12px;text-align:center;
  line-height:var(--hint-h);height:var(--hint-h);background:#fff;border-bottom:1px solid var(--hair)
}

/* ====== LAGER 3: Sticky slot (Plats) ====== */
.group-slot{
  position:sticky;top:calc(var(--topbar-h)+var(--hint-h));z-index:425;height:var(--slot-h);
  background:#fff;border-bottom:1px dashed var(--hair);
  display:flex;align-items:center;justify-content:space-between;padding:10px 12px;font-weight:700;
  will-change:opacity, transform;
  transition:opacity .16s ease-in-out;
}
.group-slot.swap{ opacity:0.2; }  /* C: fade-only vid byte */

/* ====== LAGER 4: Scroll ====== */
.scroll{
  flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;
  background:var(--bg);padding:0;margin:0;width:100%
}

/* Arena-header inuti listan (Plats) */
.arena-header{
  background:#fff;font-weight:700;padding:10px 12px;border-bottom:1px dashed var(--hair);
  display:flex;justify-content:space-between;
  transition:height .15s ease, padding .15s ease, border .15s ease, margin .15s ease
}
.arena-header.active-hidden{height:0;padding:0;border:0;margin:0;overflow:hidden}

/* Game card */
.game{
  padding:8px 12px;border-top:1px dashed #e5e7eb;display:grid;gap:6px;background:#fff;width:100%
}
.game-top{display:flex;align-items:center;gap:8px;flex-wrap:nowrap}
.game-time{font-weight:700;flex:0 0 auto;white-space:nowrap}
.game-series a{color:var(--link);text-decoration:none;font-weight:600;white-space:nowrap}
.game-mid{flex:1 1 auto;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:700}
.game-right{flex:0 0 auto;margin-left:auto;white-space:nowrap;color:var(--muted);font-size:12px}
.game-bottom{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:6px}
.team{display:inline-flex;align-items:center;gap:6px;font-weight:600}
.team.right{justify-self:start;text-align:left}
.team-logo{width:26px;height:26px;border-radius:50%;border:1px solid var(--hair);object-fit:cover;background:#f1f5f9}
.team-name{
  max-width:min(36vw,160px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  font-size:clamp(10px,2.5vw,13px)
}
.result a{
  display:inline-flex;justify-content:center;align-items:center;min-width:72px;height:26px;padding:0 8px;
  border-radius:8px;border:1px solid var(--hair);background:#f1f5f9;color:#0f172a;font-weight:700;text-decoration:none;text-align:center
}
.divider{height:8px;background:var(--bg);border-top:1px dashed var(--hair)}

/* Dynamisk textstorlek i Serie-vy ‚Äì Tid/Serie/Arena skalar tillsammans */
.game-top.dynamic-scale .game-time,
.game-top.dynamic-scale .game-series a,
.game-top.dynamic-scale .game-mid{font-size:var(--dyn-font,14px)}

/* Respons (maxbredd) */
@media(min-width:768px){.device{max-width:720px;margin:auto}}
@media(min-width:1024px){.device{max-width:840px}}
</style>
</head>
<body>
<div class="device">

  <!-- ====== LAGER 1 ====== -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="cluster-left">
        <button class="icon-btn" aria-label="Hem">üè†</button>
        <button class="icon-btn" aria-label="Karta">üó∫Ô∏è</button>
      </div>
      <div class="cluster-center">
        <button class="icon-btn" aria-label="F√∂reg√•ende dag">‚óÄ</button>
        <div class="date-block"><span>Idag</span><span>Tors</span><span>23 okt</span></div>
        <button class="icon-btn" aria-label="N√§sta dag">‚ñ∂</button>
      </div>
      <div class="cluster-right">
        <div class="sort-stack">
          <div class="sort-top">Sortering</div>
          <div class="sort-bottom">
            <span id="pillPlace"  class="pill on">Plats</span>
            <span id="pillSeries" class="pill off">Serie</span>
            <span id="pillTime"   class="pill on lock">Tid</span>
          </div>
        </div>
        <button class="icon-btn" aria-label="Inst√§llningar">‚öôÔ∏è</button>
      </div>
    </div>
  </header>

  <!-- ====== LAGER 2 ====== -->
  <div class="hint">Visar matcher n√§ra: Kruniusv√§gen 1, Billdal (57.590214, 11.946082)</div>

  <!-- ====== LAGER 3 (Plats) ====== -->
  <div id="groupSlot" class="group-slot">
    <div class="group-title">Kungsbacka Ishall A</div>
    <div class="group-sub">Avst 8 km</div>
  </div>

  <!-- ====== LAGER 4 ====== -->
  <main id="scrollArea" class="scroll"></main>

</div>

<script>
/* -------- LOGOS -------- */
const LOGOS = {
  backen:  "logos/B√§cken_HC__119055af-fc61-4108-82a8-a0cd0e883df0.png",
  grastorp:"logos/Gr√§storps_IK__c6811c5f-e2c9-43e2-a9c2-73ab53f63fd1.png",
  hanhals: "logos/Hanhals_IF__b65395a8-4623-46e4-96ab-97ff2e0e7b72.png",
  kungalv: "logos/Kung√§lvs_IK__620a9df2-1b0b-4bc5-b9eb-7e88670f4c7b.png",
};

/* -------- DATA -------- */
const ARENAS = { "Kungsbacka Ishall A":8, "√Öse & Viste Arena":104 };

/* 5 + 10 matcher */
const GAMES = [
  // Kungsbacka (5)
  { arena:"Kungsbacka Ishall A", series:"HockeyTv√•an S√∂dra", time:"09:00",
    home:{name:"Hanhals IF",logo:LOGOS.hanhals}, away:{name:"B√§cken HC",logo:LOGOS.backen}, result:"‚Äì" },
  { arena:"Kungsbacka Ishall A", series:"J18 Region S√∂dra", time:"09:40",
    home:{name:"Kung√§lvs IK",logo:LOGOS.kungalv}, away:{name:"Gr√§storps IK",logo:LOGOS.grastorp}, result:"3 - 2" },
  { arena:"Kungsbacka Ishall A", series:"J20 Region Syd", time:"10:20",
    home:{name:"B√§cken HC U20",logo:LOGOS.backen}, away:{name:"IF M√∂lndal Hockey",logo:LOGOS.hanhals}, result:"‚Äì" },
  { arena:"Kungsbacka Ishall A", series:"Tr√§ningsmatch", time:"11:00",
    home:{name:"Gr√§storps IK J18",logo:LOGOS.grastorp}, away:{name:"Kung√§lvs IK J18",logo:LOGOS.kungalv}, result:"2 - 4" },
  { arena:"Kungsbacka Ishall A", series:"HockeyTv√•an V√§stra", time:"11:40",
    home:{name:"Hisingen Hockey",logo:LOGOS.hanhals}, away:{name:"Partille HK",logo:LOGOS.backen}, result:"‚Äì" },

  // √Öse & Viste (10)
  { arena:"√Öse & Viste Arena", series:"HockeyTv√•an S√∂dra", time:"09:20",
    home:{name:"Gr√§storps IK",logo:LOGOS.grastorp}, away:{name:"Kung√§lvs IK",logo:LOGOS.kungalv}, result:"‚Äì" },
  { arena:"√Öse & Viste Arena", series:"J20 Region Syd", time:"10:00",
    home:{name:"Hanhals IF",logo:LOGOS.hanhals}, away:{name:"B√§cken HC",logo:LOGOS.backen}, result:"2 - 2" },
  { arena:"√Öse & Viste Arena", series:"J18 Region S√∂dra", time:"10:40",
    home:{name:"Kung√§lvs IK J18",logo:LOGOS.kungalv}, away:{name:"Gr√§storps IK J18",logo:LOGOS.grastorp}, result:"‚Äì" },
  { arena:"√Öse & Viste Arena", series:"HockeyTv√•an V√§stra", time:"11:20",
    home:{name:"B√§cken HC",logo:LOGOS.backen}, away:{name:"Nybro Vikings IF",logo:LOGOS.backen}, result:"‚Äì" },
  { arena:"√Öse & Viste Arena", series:"Tr√§ningsmatch", time:"12:00",
    home:{name:"Gr√§storps IK",logo:LOGOS.grastorp}, away:{name:"Hisingen Hockey",logo:LOGOS.hanhals}, result:"4 - 1" },
  { arena:"√Öse & Viste Arena", series:"J20 Region Syd", time:"12:40",
    home:{name:"Hanhals IF U20",logo:LOGOS.hanhals}, away:{name:"IF M√∂lndal Hockey",logo:LOGOS.hanhals}, result:"‚Äì" },
  { arena:"√Öse & Viste Arena", series:"HockeyTv√•an S√∂dra", time:"13:20",
    home:{name:"Kung√§lvs IK",logo:LOGOS.kungalv}, away:{name:"Troja-Ljungby",logo:LOGOS.hanhals}, result:"‚Äì" },
  { arena:"√Öse & Viste Arena", series:"J18 Region S√∂dra", time:"14:00",
    home:{name:"B√§cken HC J18",logo:LOGOS.backen}, away:{name:"Kalmar HC",logo:LOGOS.backen}, result:"3 - 0" },
  { arena:"√Öse & Viste Arena", series:"HockeyTv√•an V√§stra", time:"14:40",
    home:{name:"Gr√§storps IK",logo:LOGOS.grastorp}, away:{name:"Partille HK",logo:LOGOS.backen}, result:"‚Äì" },
  { arena:"√Öse & Viste Arena", series:"Tr√§ningsmatch", time:"15:20",
    home:{name:"IF M√∂lndal Hockey",logo:LOGOS.hanhals}, away:{name:"K√•llereds SK",logo:LOGOS.hanhals}, result:"‚Äì" },
];

/* -------- MODE, refs -------- */
const MODE = { PLACE:'place', SERIES:'series', SERIES_TIME:'series_time' };
let mode = MODE.PLACE;

const groupSlot = document.getElementById('groupSlot');
const scroll    = document.getElementById('scrollArea');
const pillPlace  = document.getElementById('pillPlace');
const pillSeries = document.getElementById('pillSeries');
const pillTime   = document.getElementById('pillTime');

/* -------- Helpers -------- */
function parseTime(t){ const [H,M]=t.split(':').map(Number); return H*60+M; }
function km(a){ return ARENAS[a] ?? 0; }
function seriesPriority(name){
  const n = name.toLowerCase();
  if (n.includes("hockeytv√•an")) return 10;
  if (n.includes("ndhl")) return 11;
  if (n.includes("hockeytrean")) return 12;
  if (n.includes("damtv√•an")) return 13;
  if (n.includes("j20") || n.includes("u20")) return 14;
  if (n.includes("j18") || n.includes("u18")) return 15;
  if (n.includes("hockeyfyran")) return 16;
  if (n.includes("tr√§nings")) return 99;
  return 50;
}

/* -------- UI (pills) -------- */
function applyPills(){
  pillPlace.className  = (mode===MODE.PLACE) ? "pill on" : "pill off";
  pillSeries.className = (mode===MODE.SERIES || mode===MODE.SERIES_TIME) ? "pill on" : "pill off";
  if (mode===MODE.PLACE) pillTime.className = "pill on lock";
  else pillTime.className = (mode===MODE.SERIES_TIME ? "pill on" : "pill off");
}
pillPlace.onclick  = ()=> setMode(MODE.PLACE);
pillSeries.onclick = ()=> setMode(MODE.SERIES);
pillTime.onclick   = ()=>{
  if (mode===MODE.PLACE) return; // l√•st i plats
  setMode(mode===MODE.SERIES ? MODE.SERIES_TIME : MODE.SERIES);
};

/* -------- Game card -------- */
function gameCard(g, seriesMode){
  const a = document.createElement('article'); 
  a.className='game';
  a.dataset.arena = g.arena;

  const top = document.createElement('div'); 
  top.className = seriesMode ? 'game-top dynamic-scale' : 'game-top';

  const t = document.createElement('div'); t.className='game-time'; t.textContent = g.time;
  const s = document.createElement('div'); s.className='game-series'; s.innerHTML = `<a href="#">${g.series}</a>`;
  top.appendChild(t); top.appendChild(s);

  if (seriesMode){
    const mid = document.createElement('div'); mid.className='game-mid'; mid.textContent = g.arena;
    const right = document.createElement('div'); right.className='game-right'; right.textContent = `Avst ${km(g.arena)} km`;
    top.appendChild(mid); top.appendChild(right);
  }

  const bottom = document.createElement('div'); bottom.className='game-bottom';
  bottom.innerHTML = `
    <div class="team"><img class="team-logo" src="${g.home.logo}" alt=""><span class="team-name">${g.home.name}</span></div>
    <div class="result"><a href="#">${g.result}</a></div>
    <div class="team right"><img class="team-logo" src="${g.away.logo}" alt=""><span class="team-name">${g.away.name}</span></div>
  `;

  a.appendChild(top); a.appendChild(bottom);
  return a;
}

/* -------- Sticky: exakt v√§xling + fade (C) -------- */
let currentArena = null;
let lastChangeTs = 0;

function updateStickyArena(){
  const headers = Array.from(scroll.querySelectorAll('.arena-header'));
  if (!headers.length) return;

  const slotBottom = groupSlot.getBoundingClientRect().bottom;
  const tolerance = 5; // px tolerans f√∂r iOS avrundning

  let next = headers[0].dataset.arenaHeader;

  for (const header of headers){
    const arenaName = header.dataset.arenaHeader;
    const games = scroll.querySelectorAll(`.game[data-arena="${arenaName}"]`);
    if (!games.length) continue;

    const last = games[games.length - 1];
    const lastBottom = last.getBoundingClientRect().bottom;

    // Byt f√∂rst n√§r sista spelet passerat sticky-ytan (med liten tolerans)
    if (lastBottom < slotBottom + tolerance){
      next = arenaName;
    } else {
      break;
    }
  }

  if (next !== currentArena){
    // Liten debounce (f√∂r iPhone-bounce): 80ms mellan byten
    const now = performance.now();
    if (now - lastChangeTs < 80) return;
    lastChangeTs = now;

    // Fade (C): l√§gg p√• klass, byt text, ta bort klass
    groupSlot.classList.add('swap');

    currentArena = next;
    document.querySelector('.group-title').textContent = currentArena;
    document.querySelector('.group-sub').textContent   = `Avst ${km(currentArena)} km`;

    headers.forEach(h => h.classList.toggle('active-hidden', h.dataset.arenaHeader === currentArena));

    setTimeout(()=> groupSlot.classList.remove('swap'), 160);
  }
}

/* -------- Autoscale top row (Serie-vy) -------- */
function autoScaleTopRows(){
  if (mode===MODE.PLACE) return;
  const rows = scroll.querySelectorAll('.game-top.dynamic-scale');
  rows.forEach(row=>{
    let font = 14;
    row.style.setProperty('--dyn-font', font + 'px');
    while (row.scrollWidth > row.clientWidth && font > 11){
      font -= 1;
      row.style.setProperty('--dyn-font', font + 'px');
    }
  });
}

/* -------- Render -------- */
let scrollBound = false;

function render(){
  scroll.innerHTML = "";

  if (mode===MODE.PLACE){
    groupSlot.style.display = "flex";
    if (!scrollBound){ scroll.addEventListener('scroll', updateStickyArena, {passive:true}); scrollBound = true; }

    // Grupp: Arena ‚Üí sortera p√• avst√•nd; inom arena sortera p√• tid
    const byArena = {};
    for (const g of GAMES) (byArena[g.arena] ||= []).push(g);
    const arenas = Object.keys(byArena).sort((a,b)=> km(a)-km(b));

    // Init sticky
    currentArena = arenas[0] || null;
    if (currentArena){
      document.querySelector('.group-title').textContent = currentArena;
      document.querySelector('.group-sub').textContent   = `Avst ${km(currentArena)} km`;
    }

    // Render: divider inf√∂r arena 2+, g√∂m f√∂rsta headern i listan (no-dup)
    arenas.forEach((aName, idx)=>{
      if (idx>0){
        const d = document.createElement('div'); d.className='divider'; scroll.appendChild(d);
      }
      const header = document.createElement('div');
      header.className = 'arena-header';
      header.dataset.arenaHeader = aName;
      header.innerHTML = `<div>${aName}</div><div>Avst ${km(aName)} km</div>`;
      if (idx===0) header.classList.add('active-hidden');
      scroll.appendChild(header);

      const list = byArena[aName].slice().sort((x,y)=> parseTime(x.time)-parseTime(y.time));
      for (const g of list) scroll.appendChild(gameCard(g, /*seriesMode=*/false));
    });

    updateStickyArena();

  } else if (mode===MODE.SERIES){
    groupSlot.style.display = "none";
    if (scrollBound){ scroll.removeEventListener('scroll', updateStickyArena); scrollBound = false; }

    // Grupp: Serie ‚Üí divider mellan serier, sortering: serieprio ‚Üí tid
    const bySeries = {};
    for (const g of GAMES) (bySeries[g.series] ||= []).push(g);
    const keys = Object.keys(bySeries).sort((a,b)=> seriesPriority(a)-seriesPriority(b) || a.localeCompare(b,'sv'));

    let first = true;
    for (const s of keys){
      const list = bySeries[s].slice().sort((a,b)=>{
        const p = seriesPriority(a.series) - seriesPriority(b.series);
        if (p !== 0) return p;
        return parseTime(a.time) - parseTime(b.time);
      });
      if (!first){
        const d = document.createElement('div'); d.className='divider'; scroll.appendChild(d);
      }
      first = false;
      for (const g of list) scroll.appendChild(gameCard(g, /*seriesMode=*/true));
    }
    autoScaleTopRows();

  } else if (mode===MODE.SERIES_TIME){
    groupSlot.style.display = "none";
    if (scrollBound){ scroll.removeEventListener('scroll', updateStickyArena); scrollBound = false; }

    // Global tidsordning (serieprio sekund√§r)
    const list = GAMES.slice().sort((a,b)=>{
      const t = parseTime(a.time) - parseTime(b.time);
      if (t !== 0) return t;
      return seriesPriority(a.series) - seriesPriority(b.series);
    });
    for (const g of list) scroll.appendChild(gameCard(g, /*seriesMode=*/true));
    autoScaleTopRows();
  }
}

/* -------- Mode switch -------- */
function setMode(m){
  mode = m;
  applyPills();
  render();
}

/* Init */
applyPills();
render();
</script>
</body>
</html>

