<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="mobile-web-app-capable" content="yes" />
<title>LocalSport – stabil + autoscroll B</title>

<style>
:root{
  --topbar-h:56px;
  --hint-h:26px;
  --slot-h:42px;
  --bg:#f0f3f8;
  --hair:#e2e8f0;
  --text:#0f172a;
  --muted:#64748b;
  --accent:#16a34a;
  --link:#2563eb;
  --result-bg:#0f172a; /* resultatbox: samma i båda vyer */
  --result-fg:#ffffff;
}

/* ===== BAS ===== */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,Roboto,Arial,sans-serif;color:var(--text);overscroll-behavior:none;}
.device{width:100%;height:100dvh;display:flex;flex-direction:column;overflow:hidden;}

/* ===== TOPP HEADER (Oförändrad layout/utseende) ===== */
.topbar{position:sticky;top:0;z-index:500;background:#fff;border-bottom:1px solid var(--hair);}
.topbar-inner{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;height:var(--topbar-h);padding:6px;}
.cluster-left,.cluster-right{display:flex;gap:8px;align-items:center;}
.icon-btn{width:32px;height:32px;border-radius:10px;border:1px solid var(--hair);background:#f1f5f9;display:grid;place-items:center;cursor:pointer;}
.icon-img{width:20px;height:20px;object-fit:contain;}
.cluster-center{display:flex;align-items:center;justify-content:center;gap:8px;}
.date-block{display:flex;flex-direction:column;align-items:center;font-weight:700;font-size:13.5px;line-height:1.1;}
/* Sorteringsbox (oförändrad) */
.sort-stack{border:1px solid var(--hair);border-radius:10px;background:#fff;padding:4px 6px;display:flex;flex-direction:column;align-items:center;}
.sort-top{font-size:12px;font-weight:600;margin-bottom:2px;}
.sort-bottom{display:flex;gap:4px;}
.pill{padding:4px 8px;font-size:11px;border-radius:999px;font-weight:600;border:1px solid var(--hair);cursor:pointer;user-select:none;}
.pill.on{background:#dcfce7;border-color:#86efac;color:var(--accent);}
.pill.off{background:#f1f5f9;border-color:#cbd5e1;color:#94a3b8;}
.pill.lock{opacity:.6;cursor:not-allowed;}

/* Hintfält (oförändrat) */
.hint{position:sticky;top:var(--topbar-h);height:var(--hint-h);background:#fff;border-bottom:1px solid var(--hair);text-align:center;font-size:12px;line-height:var(--hint-h);color:var(--muted);z-index:450;}

/* ===== Aktiv arena-slot (Plats-vy) ===== */
.group-slot{position:sticky;top:calc(var(--topbar-h) + var(--hint-h));height:var(--slot-h);display:flex;justify-content:space-between;align-items:center;padding:10px 12px;font-size:14px;font-weight:700;background:#fff;border-bottom:1px dashed var(--hair);z-index:425;}
/* OBS: streckad kant var tidigare önskad/stabil. Vi ändrar inte. */

/* ===== Scrollarea ===== */
.scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;background:var(--bg);}

/* ===== Arena-header i listan (Plats-vy) ===== */
.arena-header{padding:10px 12px;background:#fff;border-bottom:1px dashed var(--hair);font-weight:700;display:flex;justify-content:space-between;}
.arena-header.active-hidden{visibility:hidden;height:0;padding:0;margin:0;border:none;}

/* ===== Matchkort – samma i båda vyerna ===== */
.game{background:#fff;border-top:1px dashed #e5e7eb;padding:8px 12px;display:grid;gap:6px;}
.game-top{display:flex;align-items:center;gap:8px;flex-wrap:nowrap;}
.game-time{font-weight:700;white-space:nowrap;}
.game-series a{text-decoration:none;font-weight:600;color:var(--link);white-space:nowrap;}
.game-mid{flex:1 1 auto;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:700;}
.game-right{white-space:nowrap;font-size:12px;color:var(--muted);}
.game-bottom{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;}
.team{display:inline-flex;align-items:center;gap:6px;font-weight:600;}
.team-logo{width:26px;height:26px;border-radius:4px; /* osynlig fyrkant – ingen ring */ object-fit:contain;background:transparent;}
.team-name{max-width:min(38vw,165px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:13px;}
/* Resultatbox – exakt samma i båda vyerna */
.result a,.result div{display:inline-block;padding:2px 10px;border-radius:8px;border:1px solid var(--hair);background:#f1f5f9;text-decoration:none;font-weight:700;color:var(--text);}

/* Divider mellan arenor (befintlig) */
.divider{height:7px;background:var(--bg);border-top:1px dashed var(--hair);}

/* ===== Serie-vy – statiskt fönster + layoutjusteringar uppe/nere ===== */
.series-static{overflow-y:auto;overflow-x:hidden;}
.series-toprow{display:grid;grid-template-columns:49% 29% 18%;column-gap:2%;align-items:center;}
.series-toprow .series-name{min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.series-toprow .arena-name{min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:left;}
.series-toprow .dist{min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:right;color:var(--muted);font-size:12px;}
.series-bottomrow{display:grid;grid-template-columns:auto 1fr auto 1fr;align-items:center;column-gap:6px;}
.series-bottomrow .time{white-space:nowrap;font-weight:700;color:#000;}
.series-bottomrow .left,.series-bottomrow .right{display:flex;align-items:center;gap:6px;}
.series-bottomrow .left{justify-content:flex-end;}
.series-bottomrow .right{justify-content:flex-start;}
.series-result{display:flex;justify-content:center;}
.series-result .result a,.series-result .result div{display:inline-block;padding:2px 10px;border-radius:8px;border:1px solid var(--hair);background:#f1f5f9;text-decoration:none;font-weight:700;color:var(--text);}
</style>
</head>

<body>
<div class="device">

  <!-- TOPP HEADER (oförändrad) -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="cluster-left">
        <button class="icon-btn" id="btnHome" title="Hem"><img class="icon-img" src="icons/home.jpeg" alt="home"></button>
        <button class="icon-btn" id="btnMap" title="Karta"><img class="icon-img" src="icons/map.jpeg" alt="map"></button>
      </div>

      <div class="cluster-center">
        <button class="icon-btn" id="btnPrev" title="Föregående">◀</button>
        <div class="date-block"><span id="lblRel">Idag</span><span id="lblWday">Tors</span><span id="lblDate">23 okt</span></div>
        <button class="icon-btn" id="btnNext" title="Nästa">▶</button>
      </div>

      <div class="cluster-right">
        <div class="sort-stack">
          <div class="sort-top">Sortering</div>
          <div class="sort-bottom">
            <span id="pillPlace" class="pill on">Plats</span>
            <span id="pillSeries" class="pill off">Serie</span>
            <span id="pillTime" class="pill off">Tid</span>
          </div>
        </div>
        <button class="icon-btn" id="btnSettings" title="Inställningar">⚙️</button>
      </div>
    </div>
  </header>

  <div class="hint" id="hint">Visar matcher nära: Kruniusvägen 1, Billdal</div>

  <!-- Aktiv arena (Plats-vy) – oförändrat utseende -->
  <div id="groupSlot" class="group-slot" style="display:none;">
    <div class="group-title"></div>
    <div class="group-sub"></div>
  </div>

  <!-- SCROLL -->
  <main id="scrollArea" class="scroll"></main>
</div>

<script>
/* =========================
   KONFIG / STATE
========================= */
const USER_LAT = 57.590214281624824;
const USER_LON = 11.94608216084837;

const pillPlace = document.getElementById('pillPlace');
const pillSeries = document.getElementById('pillSeries');
const pillTime = document.getElementById('pillTime');

const scrollArea = document.getElementById('scrollArea');
const slot = document.getElementById('groupSlot');
const slotTitle = slot.querySelector('.group-title');
const slotSub = slot.querySelector('.group-sub');

const lblRel = document.getElementById('lblRel');
const lblWday = document.getElementById('lblWday');
const lblDate = document.getElementById('lblDate');

let allGames = [];
let logoMap = {};
let currentDateISO = null;

const MODE = { PLACE:'place', SERIES:'series', SERIES_TIME:'series_time' };
let mode = MODE.PLACE;

/* =========================
   LASTNING AV DATA
========================= */
Promise.all([
  fetch('data/Clubs_Organisatons_logos__ClubOrgName_LogoFileName.txt').then(r=>r.text()),
  fetch('data/games.csv').then(r=>r.text())
]).then(([mapTxt, csvTxt])=>{
  mapTxt.trim().split('\n').forEach(line=>{
    const [n,f] = line.split(';');
    if(n && f) logoMap[n.trim()] = f.trim();
  });
  allGames = parseCSV(csvTxt);
  setToday(); // start på dagens datum
});

/* CSV -> objekt */
function parseCSV(txt){
  const lines = txt.split('\n').filter(x=>x.trim().length>0);
  const out=[];
  // Förutsätter rubrikrad på rad 1
  for(let i=1;i<lines.length;i++){
    const f = lines[i].split(';');
    if(f.length<19) continue;
    out.push({
      date:f[0], time:f[1], series_name:f[2], link_to_series:f[3], admin_host:f[4],
      home_team:f[5], away_team:f[6], result:f[7], result_link:f[8],
      arena:f[9], status:f[10], iteration_fetched:f[11], iterations_total:f[12],
      home_club_list:f[13]||'', away_club_list:f[14]||'',
      arena_nbr:f[15], PreferedName:f[16],
      Lat: parseFloat(f[17]), Long: parseFloat(f[18])
    });
  }
  return out;
}

/* =========================
   DATUM
========================= */
function setToday(){
  const d = new Date();
  currentDateISO = d.toISOString().slice(0,10);
  render();
}
function changeDate(offset){
  const d = new Date(currentDateISO);
  d.setDate(d.getDate()+offset);
  currentDateISO = d.toISOString().slice(0,10);
  render();
}
document.getElementById('btnPrev').onclick = ()=>changeDate(-1);
document.getElementById('btnNext').onclick = ()=>changeDate(+1);
document.getElementById('btnHome').onclick = ()=>setToday();

/* =========================
   SORT-PILLS
========================= */
pillPlace.onclick = ()=>{ mode = MODE.PLACE; applyPills(); render(); };
pillSeries.onclick = ()=>{ mode = MODE.SERIES; applyPills(); render(); };
pillTime.onclick   = ()=>{ 
  if(mode===MODE.PLACE){ /* i plats-vy ändrar vi inte layouten */ }
  else { mode = (mode===MODE.SERIES)? MODE.SERIES_TIME : MODE.SERIES; }
  applyPills(); render();
};

function applyPills(){
  pillPlace.className = 'pill '+(mode===MODE.PLACE?'on':'off');
  const seriesOn = (mode===MODE.SERIES || mode===MODE.SERIES_TIME);
  pillSeries.className = 'pill '+(seriesOn?'on':'off');
  pillTime.className = 'pill '+(mode===MODE.SERIES_TIME?'on':'off');
}

/* =========================
   RENDER
========================= */
function render(){
  // datumetikett
  const d = new Date(currentDateISO);
  const wdays = ['Sön','Mån','Tis','Ons','Tors','Fre','Lör'];
  const months = ['jan','feb','mar','apr','maj','jun','jul','aug','sep','okt','nov','dec'];
  lblRel.textContent = relWord(d);
  lblWday.textContent = wdays[d.getDay()];
  lblDate.textContent = `${d.getDate()} ${months[d.getMonth()]}`;

  const list = allGames.filter(g=>g.date===currentDateISO);
  if(list.length===0){
    slot.style.display='none';
    scrollArea.innerHTML = `<div style="padding:20px;font-size:20px;text-align:center;background:#fff;">Inga matcher idag</div>`;
    return;
  }

  if(mode===MODE.PLACE){
    renderPlace(list);
  }else{
    renderSeries(list);
  }
}

function relWord(d){
  const today = new Date(); today.setHours(0,0,0,0);
  const dd = new Date(d); dd.setHours(0,0,0,0);
  const diff = (dd - today)/(1000*60*60*24);
  if(diff===0) return 'Idag';
  if(diff===-1) return 'Igår';
  if(diff===1) return 'Imorgon';
  return '';
}

/* =========================
   PLATS-VY (ORÖRD MATCHLAYOUT)
   + återställd stabil stickiness
   + autoscroll B
========================= */
let arenaOrder=[];
let currentArena=null;
let lastScrollTop=0;

function renderPlace(list){
  // Grupp per arena (endast arenor som har matcher denna dag)
  const byArena = {};
  list.forEach(g=>{
    const name = g.PreferedName || g.arena || 'Arena';
    (byArena[name] ||= []).push(g);
  });

  // Sortera arenor på avstånd
  arenaOrder = Object.keys(byArena).sort((a,b)=>{
    const da = haversine(byArena[a][0].Lat, byArena[a][0].Long, USER_LAT, USER_LON);
    const db = haversine(byArena[b][0].Lat, byArena[b][0].Long, USER_LAT, USER_LON);
    return da-db;
  });

  // Sätt initial aktiv arena (första) och slot
  currentArena = arenaOrder[0];
  slotTitle.textContent = currentArena;
  const dkm = haversine(byArena[currentArena][0].Lat, byArena[currentArena][0].Long, USER_LAT, USER_LON).toFixed(1);
  slotSub.textContent = `Avst ${dkm} km`;
  slot.style.display='flex';

  // Bygg lista:
  // – Visa inte aktiv arenas header i listan (för att undvika duplikat)
  // – Resterande arenor med header + matcher
  const frag = [];
  for(const arena of arenaOrder){
    if(arena!==currentArena){
      const dist = haversine(byArena[arena][0].Lat, byArena[arena][0].Long, USER_LAT, USER_LON).toFixed(1);
      frag.push(`<div class="arena-header" data-arena="${arena}">
                   <div>${arena}</div><div>Avst ${dist} km</div>
                 </div>`);
    }
    // matcher (oförändrad layout)
    byArena[arena].sort((a,b)=>a.time.localeCompare(b.time));
    byArena[arena].forEach(g=> frag.push(gameCardPlace(g)));
    if(arena!==arenaOrder[arenaOrder.length-1]) frag.push(`<div class="divider"></div>`);
  }
  scrollArea.innerHTML = frag.join('');

  // Scroll-hanterare
  scrollArea.onscroll = onPlaceScroll.bind(null, byArena);
  lastScrollTop = scrollArea.scrollTop; // init
}

// Byt arena-triggers (återställd stabil logik) + autoscroll B:
function onPlaceScroll(byArena){
  const st = scrollArea.scrollTop;
  const dir = st > lastScrollTop ? 'down' : 'up';
  lastScrollTop = st;

  const stickyBottom = slot.getBoundingClientRect().bottom;

  const headers = [...scrollArea.querySelectorAll('.arena-header')];

  // Hjälpare för att hitta index
  const idx = arenaOrder.indexOf(currentArena);

  if(dir==='down' && idx<arenaOrder.length-1){
    // Byt när nuvarande arenas sista match inte längre är synlig alls
    const lastOfCurr = lastGameEl(currentArena);
    if(lastOfCurr && !isAnyPartVisible(lastOfCurr)){
      const nextArena = arenaOrder[idx+1];
      setActiveArena(nextArena, byArena);

      // AUTOSCROLL NER: första matchen i nya arenan överst
      const firstNext = firstGameEl(nextArena);
      if(firstNext){
        const offset = stickyOffset();
        scrollArea.scrollTo({ top:firstNext.offsetTop - offset, behavior:'auto' });
      }
    }
  }else if(dir==='up' && idx>0){
    // Byt när föregående arenas header blivit helt synlig i listan
    const prev = arenaOrder[idx-1];
    const prevHeader = headers.find(h=>h.dataset.arena===prev);
    if(prevHeader && isFullyVisible(prevHeader)){
      setActiveArena(prev, byArena);

      // AUTOSCROLL UPP: visa EN (sista) match fullt synlig
      const lastPrev = lastGameEl(prev);
      if(lastPrev){
        const offset = stickyOffset();
        // placera så att sista matchen syns helt strax under slotten
        const targetTop = Math.max(0, lastPrev.offsetTop - (scrollArea.clientHeight - lastPrev.offsetHeight) );
        scrollArea.scrollTo({ top: targetTop, behavior:'auto' });
      }
    }
  }

  // Dölj endast aktiva arenans header i listan
  headers.forEach(h=>h.classList.toggle('active-hidden', h.dataset.arena===currentArena));
}

function setActiveArena(arena, byArena){
  if(arena===currentArena) return;
  currentArena = arena;
  slotTitle.textContent = currentArena;
  const dkm = haversine(byArena[arena][0].Lat, byArena[arena][0].Long, USER_LAT, USER_LON).toFixed(1);
  slotSub.textContent = `Avst ${dkm} km`;
}

function stickyOffset(){ return (document.querySelector('.topbar').offsetHeight + document.querySelector('.hint').offsetHeight + slot.offsetHeight); }

function isAnyPartVisible(el){
  const r = el.getBoundingClientRect();
  const a = scrollArea.getBoundingClientRect();
  // synlig om någon del ligger inom scrollArea-vertikal
  return (r.bottom > a.top + slot.offsetHeight) && (r.top < a.bottom);
}

function isFullyVisible(el){
  const r = el.getBoundingClientRect();
  const a = scrollArea.getBoundingClientRect();
  return r.top >= a.top + slot.offsetHeight && r.bottom <= a.bottom;
}

function firstGameEl(arena){
  // första .game som tillhör arenan (via data-arena)
  return scrollArea.querySelector(`.game[data-arena="${cssEscape(arena)}"]`);
}
function lastGameEl(arena){
  const list = [...scrollArea.querySelectorAll(`.game[data-arena="${cssEscape(arena)}"]`)];
  return list.length? list[list.length-1] : null;
}

/* =========================
   SERIE-VY – statisk + resultatbox = plats-vy
========================= */
function renderSeries(list){
  slot.style.display='none'; // ingen aktiv arenarubrik i serie-vy
  scrollArea.onscroll = null;

  // Sortera: SERIE (prio) → TID, eller TID → SERIE (sekundärt)
  let arr = [...list];
  if(mode===MODE.SERIES){
    arr.sort(seriesPriorityThenTime);
  }else if(mode===MODE.SERIES_TIME){
    arr.sort((a,b)=>{
      const t = a.time.localeCompare(b.time);
      if(t!==0) return t;
      return seriesPriorityThenTime(a,b);
    });
  }

  const frag=[];
  arr.forEach(g=> frag.push(gameCardSeries(g)));
  scrollArea.innerHTML = frag.join('');
}

/* =========================
   KORTBYGGARE (oförändrat i Plats-vy),
   Serie-vy använder samma resultatbox/loggor
========================= */
function gameCardPlace(g){
  const homeLogo = pickLogo(g.home_club_list);
  const awayLogo = pickLogo(g.away_club_list);
  const resHTML = (g.result_link && g.result && g.result.trim()!=='–')
    ? `<div class="result"><a href="${g.result_link}" target="_blank">${g.result}</a></div>`
    : `<div class="result"><div>${g.result || '–'}</div></div>`;

  return `
  <article class="game" data-arena="${escapeHtml(g.PreferedName||g.arena||'Arena')}">
    <div class="game-top">
      <div class="game-time">${escapeHtml(g.time||'')}</div>
      <div class="game-series">${seriesLinkHTML(g)}</div>
    </div>
    <div class="game-bottom">
      <div class="team" style="justify-self:flex-end;">
        <span class="team-name" style="text-align:right;">${escapeHtml(g.home_team||'')}</span>
        <img class="team-logo" src="${homeLogo}" alt="">
      </div>
      ${resHTML}
      <div class="team" style="justify-self:flex-start;">
        <img class="team-logo" src="${awayLogo}" alt="">
        <span class="team-name" style="text-align:left;">${escapeHtml(g.away_team||'')}</span>
      </div>
    </div>
  </article>`;
}

function gameCardSeries(g){
  const homeLogo = pickLogo(g.home_club_list);
  const awayLogo = pickLogo(g.away_club_list);
  const distance = haversine(g.Lat,g.Long,USER_LAT,USER_LON).toFixed(1)+' km';

  const resHTML = (g.result_link && g.result && g.result.trim()!=='–')
    ? `<div class="result"><a href="${g.result_link}" target="_blank">${g.result}</a></div>`
    : `<div class="result"><div>${g.result || '–'}</div></div>`;

  return `
  <article class="game">
    <!-- Övre rad: Serie (49%), Arena (29%), Avstånd (18%), gap 2% -->
    <div class="series-toprow">
      <div class="series-name">${seriesLinkHTML(g)}</div>
      <div class="arena-name">${escapeHtml(g.PreferedName||g.arena||'')}</div>
      <div class="dist">${distance}</div>
    </div>

    <!-- Nedre rad: Tid | Hemma + logo | RESULTAT | logo + Borta -->
    <div class="series-bottomrow">
      <div class="time">${escapeHtml(g.time||'')}</div>

      <div class="left">
        <span class="team-name" style="max-width:min(38vw,165px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-align:right;">${escapeHtml(g.home_team||'')}</span>
        <img class="team-logo" src="${homeLogo}" alt="">
      </div>

      <div class="series-result">
        ${resHTML}
      </div>

      <div class="right">
        <img class="team-logo" src="${awayLogo}" alt="">
        <span class="team-name" style="max-width:min(38vw,165px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-align:left;">${escapeHtml(g.away_team||'')}</span>
      </div>
    </div>
  </article>`;
}

/* =========================
   SERIE-PRIO (förenklad tolkning enligt tidig spec)
========================= */
function seriesPriorityThenTime(a,b){
  const pa = seriesPriority(a), pb = seriesPriority(b);
  if(pa!==pb) return pa-pb;
  // sekundärt tid
  const t = a.time.localeCompare(b.time);
  if(t!==0) return t;
  // slutligen namn
  return (a.series_name||'').localeCompare(b.series_name||'');
}

function seriesPriority(g){
  const host = (g.admin_host||'').toLowerCase();
  const sn = (g.series_name||'').toLowerCase();

  // 1) SIF
  if(host.includes('svenska ishockey')) {
    if(/^shl/.test(sn)) return 1;
    if(/^(ha|hockeyallsvenskan)/.test(sn)) return 2;
    if(/^sdhl/.test(sn)) return 3;
    if(/hockeyettan/.test(sn)) return 4;
    if(/^swe\b/.test(sn)) return 5;
    const u = uRank(sn); if(u) return 100 - u; // högre U först
    return 900;
  }

  // 2) Regioner (Syd 93, Öst 95, Norr 96, Väst 94) – ordning 93,95,96,94
  if(/\b(93|94|95|96)\b/.test(host) || /(region|syd|väst|öst|norr)/.test(host)){
    if(/hockeytvåan/.test(sn)) return 10;
    if(/ndhl/.test(sn)) return 11;
    if(/hockeytrean/.test(sn)) return 12;
    if(/u20\s*regional/.test(sn)) return 13;
    if(/hockeyfyran/.test(sn)) return 14;
    const u = uRank(sn); if(u) return 100 - u;
    if(/tv[- ]?pucken|distriktslag|blekinge|stockholm|göteborg|skåne|västmanland|småland|hälsingland|gästrikland|värmland|västerbotten|ångermanland|medelpad|norrbotten|gotland|halland|östergötland|örebro/.test(sn)) return 120;
    // samma värde – finjusteras INTE mer här för att hålla det enkelt/stabilt
    return 920;
  }

  // 3) Distrikt
  if(/förbund/.test(host)){
    if(/hockeyfyran/.test(sn)) return 200;
    if(/division\s*5/.test(sn)) return 201;
    const u = uRank(sn); if(u) return 100 - u;
    return 950;
  }

  return 9999;
}

function uRank(sn){
  const m = sn.match(/\bu(\d{2})\b/);
  if(!m) return 0;
  const n = parseInt(m[1],10);
  return n; // högre tal = högre prio → vi inverterar i prio (100-n)
}

/* =========================
   LOGOTYPER
========================= */
function pickLogo(listStr){
  const first = (listStr||'').split(',')[0].trim();
  const f = logoMap[first];
  if(!f) return 'logos/placeholder.png';
  return `logos/${f}`;
}

/* =========================
   HJÄLPARE
========================= */
function seriesLinkHTML(g){
  const sn = g.series_name||'';
  const link = (g.link_to_series||'').trim();
  if(link) return `<a href="${escapeHtml(link)}" target="_blank">${escapeHtml(sn)}</a>`;
  return escapeHtml(sn);
}

function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

function cssEscape(s){ return (s||'').replace(/["\\]/g,'\\$&'); }

function haversine(lat1,lon1,lat2,lon2){
  const R=6371, toRad=x=>x*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
</script>
</body>
</html>

