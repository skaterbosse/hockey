<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="mobile-web-app-capable" content="yes">
<title>LocalSport – Plats & Serie</title>
<style>
:root{
  --topbar-h:56px;
  --hint-h:26px;
  --slot-h:42px;
  --bg:#f0f3f8;
  --hair:#e2e8f0;
  --text:#0f172a;
  --muted:#64748b;
  --accent:#16a34a;
  --link:#2563eb;
  --danger:#dc2626;
  --pill-off-bg:#f1f5f9;
  --pill-off-bd:#cbd5e1;
  --pill-off-tx:#94a3b8;
  --card:#fff;
  --result-w:88px; /* fast bredd för resultatbox */
  --time-w:62px;   /* fast bredd för tidfält */
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,Roboto,Arial,sans-serif;color:var(--text);overscroll-behavior:none}
.device{width:100%;height:100dvh;display:flex;flex-direction:column;overflow:hidden}

/* Topbar */
.topbar{position:sticky;top:0;z-index:500;background:#fff;border-bottom:1px solid var(--hair)}
.topbar-inner{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;height:var(--topbar-h);padding:6px 8px;gap:8px}
.cluster-left,.cluster-right{display:flex;gap:8px;align-items:center}
.icon-btn{width:32px;height:32px;border-radius:10px;border:1px solid var(--hair);background:#f1f5f9;display:grid;place-items:center;cursor:pointer}
.icon-btn img{width:20px;height:20px;object-fit:contain}
.cluster-center{display:flex;align-items:center;justify-content:center;gap:10px;min-width:0}
.date-block{display:flex;flex-direction:column;align-items:center;font-weight:700;font-size:13.5px;line-height:1.1;min-width:110px}
.arrow{width:28px;height:28px;border:1px solid var(--hair);border-radius:8px;background:#fff;display:grid;place-items:center;font-weight:800;cursor:pointer}
.arrow.green{color:#16a34a;border-color:#86efac}
.arrow.gray{color:#94a3b8;border-color:#cbd5e1}

/* Sortering */
.sort-stack{border:1px solid var(--hair);border-radius:10px;background:#fff;padding:4px 6px;display:flex;flex-direction:column;align-items:center}
.sort-top{font-size:12px;font-weight:600;margin-bottom:2px}
.sort-bottom{display:flex;gap:4px}
.pill{padding:4px 8px;font-size:11px;border-radius:999px;font-weight:600;border:1px solid var(--hair);cursor:pointer;user-select:none}
.pill.on{background:#dcfce7;border-color:#86efac;color:var(--accent)}
.pill.off{background:var(--pill-off-bg);border-color:var(--pill-off-bd);color:var(--pill-off-tx)}
.pill.lock{opacity:.6;cursor:not-allowed}

/* Hint */
.hint{position:sticky;top:var(--topbar-h);height:var(--hint-h);background:#fff;border-bottom:1px solid var(--hair);text-align:center;font-size:12px;line-height:var(--hint-h);color:var(--muted);z-index:450}

/* Aktiv arena-slot (Plats-vy) – exakt samma stil som arena-header i listan */
.group-slot{
  position:sticky;top:calc(var(--topbar-h) + var(--hint-h));
  height:auto; /* höjden styrs av padding */
  padding:10px 12px;
  display:flex;justify-content:space-between;align-items:center;
  background:#fff;z-index:425;border-bottom:1px solid var(--hair);
  font-weight:700;font-size:14px;
}

/* Scrollarea */
.scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;background:var(--bg)}

/* Arena header i scroll-listan */
.arena-header{padding:10px 12px;background:#fff;border-bottom:1px solid var(--hair);font-weight:700;display:flex;justify-content:space-between;font-size:14px}
.arena-header.active-hidden{display:none}

/* Matchkort */
.game{background:#fff;border-top:1px solid #e5e7eb;padding:8px 12px;display:grid;gap:6px}

/* Övre rad – PLATS-VY: [Tid][Serie] */
.game-top--place{display:flex;align-items:center;gap:8px;min-width:0}
.game-time{width:var(--time-w);min-width:var(--time-w);text-align:left;font-weight:700;white-space:nowrap;overflow:hidden}
.game-series{flex:1 1 auto;min-width:0}
.game-series a{color:var(--link);text-decoration:none;font-weight:600}
.game-series .series-text{display:inline-block;max-width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Övre rad – SERIE-VY: [Serie][Arena][Avst] */
.game-top--series{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center}
.series-left{min-width:0}
.series-left a{color:var(--link);text-decoration:none;font-weight:600}
.series-left .series-text{display:inline-block;max-width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.series-arena{min-width:0;text-align:right;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.series-dist{width:64px;text-align:right;color:var(--muted);font-size:12px;white-space:nowrap}

/* Nedre rad – gemensam layout: [Hemma][logo][RESULT][logo][Borta] */
.game-bottom{display:grid;grid-template-columns:1fr auto var(--result-w) auto 1fr;align-items:center;gap:6px}
.team{display:inline-flex;align-items:center;gap:6px;font-weight:600}
.team-left{justify-content:flex-end}
.team-right{justify-content:flex-start}
.team-logo-box{width:26px;height:26px;display:grid;place-items:center}
.team-logo{width:100%;height:100%;object-fit:contain;background:transparent;border:none;border-radius:0}

/* Avstånd (Plats-vy uppe till höger om aktiv header & i arena-header) */
.dist{color:var(--muted);font-size:12px;white-space:nowrap}

/* Resultatbox */
.result a,.result .plain{
  display:inline-grid;place-items:center;text-decoration:none;
  width:var(--result-w);height:26px;border:1px solid var(--hair);
  border-radius:8px;background:#f1f5f9;font-weight:700;color:var(--text)
}
.result a.link{color:var(--link)}
.result .plain{color:var(--text)}
/* “–” utan knapp: görs som plain text i samma yta */
.result-dash{display:inline-grid;place-items:center;width:var(--result-w);height:26px}

/* Debug markering (valfritt: query ?debug=1) */
.debug .shrunk{color:var(--danger)}
.debug .trunc::after{content:"";}

/* Responsiva justeringar */
@media (min-width:768px){
  :root{ --result-w:96px; --time-w:70px }
}

/* Utility för dold sektion (t.ex. slot i serie-vy) */
.hidden{display:none !important}
</style>
</head>
<body>
<div class="device">

  <!-- TOP BAR -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="cluster-left">
        <button id="btnHome" class="icon-btn" title="Hem">
          <img src="icons/home.jpeg" alt="Hem">
        </button>
        <button id="btnMap" class="icon-btn" title="Karta">
          <img src="icons/map.jpeg" alt="Karta">
        </button>
      </div>

      <div class="cluster-center" id="dateCluster">
        <button id="prevDay" class="arrow gray" title="Föregående datum">◀</button>
        <div class="date-block" id="dateLabel"><span>Idag</span><span>Tors</span><span>—</span></div>
        <button id="nextDay" class="arrow gray" title="Nästa datum">▶</button>
      </div>

      <div class="cluster-right">
        <div class="sort-stack">
          <div class="sort-top">Sortering</div>
          <div class="sort-bottom">
            <span id="pillPlace" class="pill on">Plats</span>
            <span id="pillSeries" class="pill off">Serie</span>
            <span id="pillTime" class="pill on lock">Tid</span>
          </div>
        </div>
        <button id="btnSettings" class="icon-btn" title="Inställningar">⚙️</button>
      </div>
    </div>
  </header>

  <div class="hint" id="hint">Visar matcher nära: Kruniusvägen 1, Billdal</div>

  <!-- Aktiv arena-slot (Plats-vy). Döljs i Serie-vy -->
  <div id="activeArenaSlot" class="group-slot hidden">
    <div class="group-title">—</div>
    <div class="dist">—</div>
  </div>

  <!-- Scroll-lista -->
  <main id="scrollArea" class="scroll">
    <!-- Renderas dynamiskt -->
  </main>
</div>

<script>
/* ------------------------- KONFIG ------------------------- */
const DEBUG = new URLSearchParams(location.search).get("debug")==="1";
if(DEBUG) document.documentElement.classList.add("debug");

const USER = { lat:57.590214281624824, lon:11.94608216084837 }; // Billdal
const GAMES_CSV = "data/games.csv";
const CLUBMAP_TXT = "data/Clubs_Organisatons_logos__ClubOrgName_LogoFileName.txt";

/* ------------------------- DOM ---------------------------- */
const scrollEl = document.getElementById("scrollArea");
const activeSlot = document.getElementById("activeArenaSlot");
const slotTitle = activeSlot.querySelector(".group-title");
const slotDist  = activeSlot.querySelector(".dist");
const dateLabel = document.getElementById("dateLabel");
const prevDayBtn= document.getElementById("prevDay");
const nextDayBtn= document.getElementById("nextDay");
const pillPlace = document.getElementById("pillPlace");
const pillSeries= document.getElementById("pillSeries");
const pillTime  = document.getElementById("pillTime");
const hintEl    = document.getElementById("hint");

const btnHome   = document.getElementById("btnHome");
const btnMap    = document.getElementById("btnMap");

/* ------------------------- STATE -------------------------- */
const MODE = { PLACE:"place", SERIES:"series", SERIES_TIME:"series_time" };
let mode = MODE.PLACE;

let allGames = [];     // alla rader från CSV (som objekt)
let gamesByDate = [];  // filtrerat på valt datum
let clubLogos = new Map(); // "Klubb/Organisation" -> "logoFilnamn"
let currentDate = todayYMD();    // "YYYY-MM-DD"
let currentArena = null;         // namn på aktiv arena (Plats-vy)
let arenaOrder = [];             // ordning av arenor (Plats-vy)
let lastScrollTop = 0;

/* ------------------------- HELPERS ------------------------ */
function todayYMD(){
  const now = new Date(); // enligt device
  const y = now.getFullYear();
  const m = String(now.getMonth()+1).padStart(2,"0");
  const d = String(now.getDate()).padStart(2,"0");
  return `${y}-${m}-${d}`;
}
function fmtWeekday(d){
  const wd = ["Sön","Mån","Tis","Ons","Tors","Fre","Lör"];
  return wd[d.getDay()];
}
function fmtDateHuman(ymd){
  const [y,m,d]=ymd.split("-").map(Number);
  const dt=new Date(y,m-1,d);
  const months = ["jan","feb","mar","apr","maj","jun","jul","aug","sep","okt","nov","dec"];
  return { wd:fmtWeekday(dt), d:d, mon:months[m-1] };
}
function ymdShift(ymd, delta){
  const [y,m,d] = ymd.split("-").map(Number);
  const dt=new Date(y,m-1,d); dt.setDate(dt.getDate()+delta);
  const Y=dt.getFullYear(), M=String(dt.getMonth()+1).padStart(2,"0"), D=String(dt.getDate()).padStart(2,"0");
  return `${Y}-${M}-${D}`;
}
function haversine(lat1,lon1,lat2,lon2){
  const R=6371; const toRad = x => x*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function parseCSVSemicolon(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
  if(lines.length===0) return [];
  const header = lines[0].split(";").map(h=>h.trim());
  return lines.slice(1).map(line=>{
    const cols = line.split(";").map(c=>c.trim());
    const obj={};
    header.forEach((h,i)=>obj[h]=cols[i]??"");
    return obj;
  });
}
async function fetchText(url){
  try{
    const res = await fetch(url);
    if(!res.ok){ console.error("⚠️ Kunde inte läsa:", url, res.status); return ""; }
    return await res.text();
  }catch(e){
    console.error("⚠️ Fetch error:", url, e); return "";
  }
}
function parseClubsMap(text){
  const rows = text.split(/\r?\n/).filter(l=>l.trim().length>0);
  const map = new Map();
  rows.forEach(line=>{
    const idx = line.indexOf(";");
    if(idx>0){
      const name = line.slice(0,idx).trim();
      const file = line.slice(idx+1).trim();
      if(name && file) map.set(name, file);
    }
  });
  return map;
}
function firstClub(list){
  // list: "A,B,C" -> "A"
  if(!list) return "";
  return list.split(",")[0].trim();
}
function textFits(el){
  return el.scrollWidth <= el.clientWidth + 1; // margin för subpixlar
}
function shrinkToFit(el, min=10){
  let size = parseFloat(getComputedStyle(el).fontSize);
  while(!textFits(el) && size>min){
    size -= 0.5;
    el.style.fontSize = size+"px";
  }
}
function truncateWithDot(str, max){
  if(str.length<=max) return str;
  return str.slice(0, max) + ".";
}
function setDateHeader(ymd){
  const {wd,d,mon} = fmtDateHuman(ymd);
  const today = todayYMD();
  dateLabel.innerHTML = (ymd===today)
   ? `<span>Idag</span><span>${wd}</span><span>${d} ${mon}</span>`
   : `<span></span><span>${wd}</span><span>${d} ${mon}</span>`;
}
function setArrowsState(hasPrev,hasNext){
  prevDayBtn.classList.toggle("green",hasPrev);
  prevDayBtn.classList.toggle("gray",!hasPrev);
  nextDayBtn.classList.toggle("green",hasNext);
  nextDayBtn.classList.toggle("gray",!hasNext);
}

/* ---------- LOGO: smart trim av vita/transparenta kanter ---------- */
async function smartTrimLogo(src){
  return new Promise(resolve=>{
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => {
      try{
        const w = img.naturalWidth, h = img.naturalHeight;
        const can = document.createElement("canvas");
        can.width=w; can.height=h;
        const ctx = can.getContext("2d");
        ctx.drawImage(img,0,0);
        const {data} = ctx.getImageData(0,0,w,h);
        const isWhiteOrTransp = (r,g,b,a) => (a<10) || (r>245 && g>245 && b>245);
        let top=h, left=w, right=0, bottom=0, found=false;
        for(let y=0;y<h;y++){
          for(let x=0;x<w;x++){
            const idx=(y*w+x)*4; const r=data[idx],g=data[idx+1],b=data[idx+2],a=data[idx+3];
            if(!isWhiteOrTransp(r,g,b,a)){
              found=true;
              if(y<top) top=y;
              if(y>bottom) bottom=y;
              if(x<left) left=x;
              if(x>right) right=x;
            }
          }
        }
        if(!found){ resolve(src); return; }
        const cw = Math.max(1, right-left+1);
        const ch = Math.max(1, bottom-top+1);
        const can2 = document.createElement("canvas");
        can2.width=cw; can2.height=ch;
        const c2 = can2.getContext("2d");
        c2.drawImage(can, left, top, cw, ch, 0, 0, cw, ch);
        resolve(can2.toDataURL("image/png"));
      }catch(e){
        console.warn("Trim fail, fallback original:", e);
        resolve(src);
      }
    };
    img.onerror = ()=> resolve(src);
    img.src = src;
  });
}

/* ---------------- Serie-prioritering ---------------- */
const REGION_ORDER = ["93","95","96","94"]; // Syd, Öst, Norr, Väst
const DISTRICT_ORDER = [
  ["Stockholms Ishockeyförbund","15"],
  ["Göteborgs Ishockeyförbund","6"],
  ["Västergötlands Ishockeyförbund","20"],
  ["Smålands Ishockeyförbund","14"],
  ["Bohuslän Dals Ishockeyförbund","2"],
  ["Skånes Ishockeyförbund","13"],
  ["Upplands Ishockeyförbund","17"],
  ["Södermanlands Ishockeyförbund","16"],
  ["Hälsinglands Ishockeyförbund","8"],
  ["Östergötlands Ishockeyförbund","23"],
  ["Gästriklands Ishockeyförbund","5"],
  ["Norrbottens Ishockeyförbund","11"],
  ["Blekinge Ishockeyförbund","1"],
  ["Örebro läns Ishockeyförbund","12"],
  ["Västmanlands Ishockeyförbund","21"],
  ["Dalanas Ishockeyförbund","3"],
  ["Jämtland-Härjedalens Ishockeyförbund","9"],
  ["Gotlands Ishockeyförbund","4"],
  ["Ångermanlands Ishockeyförbund","22"],
  ["Västerbottens Ishockeyförbund","19"],
  ["Värmlands Ishockeyförbund","18"],
  ["Medelpads Ishockeyförbund","10"],
  ["Hallands Ishockeyförbund","7"]
].map(([name,code])=>({name,code}));

function seriesTier({admin_host, series_name}){
  // SIF (90)
  if(admin_host.includes("Svenska Ishockeyförbundet") || admin_host.includes("Svenska Ishockey Förbundet")){
    const s = series_name.toLowerCase();
    if(/shl\b/i.test(series_name)) return [1,1];            // SHL
    if(/\bha\b|\bhockeyallsvenskan\b/i.test(series_name)) return [1,2]; // HA
    if(/sdhl/i.test(series_name)) return [1,3];             // SDHL
    if(/hockeyettan/i.test(series_name)) return [1,4];      // HockeyEttan
    if(/\bswe\b|landslag|team sweden/i.test(s)) return [1,5]; // landslag
    const u = (series_name.match(/\bU(\d+)\b/i)||[])[1];
    if(u) return [1, 20 - parseInt(u,10)]; // högre U (20) får lägre sorttal (dvs före)
    return [1,99];
  }

  // Regioner (93/94/95/96)
  const regCode = (series_name.match(/\b(93|94|95|96)\b/)||[])[1] || (admin_host.match(/\b(93|94|95|96)\b/)||[])[1] || null;
  if(regCode){
    const s = series_name.toLowerCase();
    // Top order: 1:HockeyTvåan, 2:NDHL, 3:HockeyTrean, 5:DamTvåan, 4:U20 Regional, 6:HockeyFyran
    if(/hockeytvåan/i.test(s)) return [2,1, REGION_ORDER.indexOf(regCode)];
    if(/\bndhl\b/i.test(s)) return [2,2, REGION_ORDER.indexOf(regCode)];
    if(/hockeytrean/i.test(s)) return [2,3, REGION_ORDER.indexOf(regCode)];
    if(/damtvåan/i.test(s)) return [2,5, REGION_ORDER.indexOf(regCode)];
    if(/u20.*regional|regional.*u20/i.test(s)) return [2,4, REGION_ORDER.indexOf(regCode)];
    if(/hockeyfyran/i.test(s)) return [2,6, REGION_ORDER.indexOf(regCode)];
    const u = (series_name.match(/\bU(\d+)\b/i)||[])[1];
    if(u) return [2, 20 - parseInt(u,10), REGION_ORDER.indexOf(regCode)];
    if(/tv-pucken|distriktslag/i.test(s)) return [2,50, REGION_ORDER.indexOf(regCode)];
    return [2,99, REGION_ORDER.indexOf(regCode)];
  }

  // Distrikt
  const distIdx = DISTRICT_ORDER.findIndex(d=>admin_host.includes(d.name));
  if(distIdx>=0){
    const s = series_name.toLowerCase();
    if(/hockeyfyran/i.test(s)) return [3,1, distIdx];
    if(/division\s*5|\bdiv\s*5\b/i.test(s)) return [3,2, distIdx];
    const u = (series_name.match(/\bU(\d+)\b/i)||[])[1];
    if(u) return [3, 20 - parseInt(u,10), distIdx];
    return [3,99, distIdx];
  }

  // Okänd – lägst
  return [9,99,99];
}

/* ---------------- Ladda data ---------------- */
async function loadData(){
  const [csvTxt, clubTxt] = await Promise.all([ fetchText(GAMES_CSV), fetchText(CLUBMAP_TXT) ]);
  if(!csvTxt){ allGames=[]; return; }
  allGames = parseCSVSemicolon(csvTxt).map(row=>{
    // Säkerställ fältnamn enligt spec
    const lat = parseFloat(row["Lat"]||"0");
    const lon = parseFloat(row["Long"]||"0");
    const arenaPreferred = row["PreferedName"]||row["arena"]||"";
    const dist = (isFinite(lat)&&isFinite(lon) && lat!==0 && lon!==0) ? haversine(USER.lat, USER.lon, lat, lon) : null;
    return {
      date: row["date"]||"",
      time: row["time"]||"",
      series_name: row["series_name"]||"",
      link_to_series: row["link_to_series"]||"",
      admin_host: row["admin_host"]||"",
      home_team: row["home_team"]||"",
      away_team: row["away_team"]||"",
      result: row["result"]||"",
      result_link: row["result_link"]||"",
      arena_raw: row["arena"]||"",
      status: row["status"]||"",
      home_club_list: row["home_club_list"]||"",
      away_club_list: row["away_club_list"]||"",
      arena_nbr: row["arena_nbr"]||"",
      PreferedName: arenaPreferred,
      Lat: lat, Long: lon,
      distance_km: dist
    };
  });

  clubLogos = parseClubsMap(clubTxt||"");
  if(DEBUG) console.log("Loaded games:", allGames.length, "clubs:", clubLogos.size);
}

/* ---------------- Render flows ---------------- */
function applyPills(){
  pillPlace.className = (mode===MODE.PLACE) ? "pill on" : "pill off";
  pillSeries.className= (mode===MODE.SERIES||mode===MODE.SERIES_TIME) ? "pill on" : "pill off";
  pillTime.className  = (mode===MODE.PLACE) ? "pill on lock" : (mode===MODE.SERIES_TIME ? "pill on" : "pill off");
}

function filterByDate(){
  gamesByDate = allGames.filter(g=>g.date===currentDate);
  // sortera “plats” baserat på distance (arena-grupper)
  // (serievy sorteras separat)
}

function groupByArena(list){
  const map = new Map();
  list.forEach(g=>{
    const a = g.PreferedName || g.arena_raw || "—";
    if(!map.has(a)) map.set(a, []);
    map.get(a).push(g);
  });
  // sortera matcher inom arena på tid
  for(const arr of map.values()){
    arr.sort((a,b)=> (a.time||"").localeCompare(b.time||""));
  }
  return map;
}

function placeOrderArenas(map){
  // sortera arenor på avstånd (stigande). Arenor utan avstånd i slutet.
  const arr = Array.from(map.keys());
  arr.sort((a,b)=>{
    const ga = map.get(a)[0], gb = map.get(b)[0];
    const da = ga && isFinite(ga.distance_km) ? ga.distance_km : 1e9;
    const db = gb && isFinite(gb.distance_km) ? gb.distance_km : 1e9;
    if(da!==db) return da-db;
    return a.localeCompare(b);
  });
  return arr;
}

function seriesSort(list){
  // Serie-vy: sortera på seriesTier, sedan tid (om mode SERIES_TIME)
  return [...list].sort((a,b)=>{
    const A = seriesTier(a), B = seriesTier(b);
    for(let i=0;i<Math.max(A.length,B.length);i++){
      const av=A[i]??0,bv=B[i]??0;
      if(av!==bv) return av-bv;
    }
    if(mode===MODE.SERIES_TIME){
      return (a.time||"").localeCompare(b.time||"");
    }else{
      // SERIES (tid sekundärt): först tier, därefter tid
      return (a.time||"").localeCompare(b.time||"");
    }
  });
}

function hasGamesOn(ymd){
  return allGames.some(g=>g.date===ymd);
}

function updateDateUI(){
  setDateHeader(currentDate);
  setArrowsState( hasGamesOn(ymdShift(currentDate,-1)), hasGamesOn(ymdShift(currentDate,+1)) );
}

/* --------- Logo path resolve ---------- */
function logoPathForTeamList(list){
  const club = firstClub(list);
  if(!club) return null;
  const logoFile = clubLogos.get(club);
  if(!logoFile) return null;
  return `logos/${logoFile}`;
}

/* --------- Match card renderers --------- */
function renderMatchPlace(g){
  // Övre rad: [Tid][Serie]
  const seriesText = g.series_name || "";
  const seriesLink = g.link_to_series || "";
  const safeSeries = truncateWithDot(seriesText, 50);

  // Nedre rad: [Hemma][logo][RESULT][logo][Borta]
  const homeLogo = logoPathForTeamList(g.home_club_list);
  const awayLogo = logoPathForTeamList(g.away_club_list);

  // Tid / Postponed i tidfältets fasta bredd med shrink
  const timeText = g.status && g.status.toLowerCase().includes("postpon") ? "Postponed" : (g.time || "");
  const timeHTML = `<div class="game-time"><span class="time-text">${timeText}</span></div>`;

  const seriesHTML = seriesLink
    ? `<div class="game-series"><a href="${seriesLink}" target="_blank" rel="noopener"><span class="series-text">${safeSeries}</span></a></div>`
    : `<div class="game-series"><span class="series-text">${safeSeries}</span></div>`;

  const res = (g.result||"").trim();
  let resultHTML = `<div class="result-dash">–</div>`;
  if(res){
    if(g.result_link){
      resultHTML = `<div class="result"><a class="link" href="${g.result_link}" target="_blank" rel="noopener">${res}</a></div>`;
    }else{
      resultHTML = `<div class="result"><span class="plain">${res}</span></div>`;
    }
  }

  const homeName = truncateWithDot(g.home_team||"", 30);
  const awayName = truncateWithDot(g.away_team||"", 30);

  return `
  <article class="game" data-arena="${(g.PreferedName||g.arena_raw||"")}">
    <div class="game-top--place">
      ${timeHTML}
      ${seriesHTML}
    </div>
    <div class="game-bottom">
      <div class="team team-left">
        <span class="team-name home-name">${homeName}</span>
        <div class="team-logo-box">
          ${homeLogo ? `<img class="team-logo" src="${homeLogo}" alt="">` : `<span class="team-logo">?</span>`}
        </div>
      </div>
      <!-- gap före resultat är i grid-gap -->
      ${resultHTML}
      <div class="team team-right">
        <div class="team-logo-box">
          ${awayLogo ? `<img class="team-logo" src="${awayLogo}" alt="">` : `<span class="team-logo">?</span>`}
        </div>
        <span class="team-name away-name">${awayName}</span>
      </div>
    </div>
  </article>
  `;
}

function renderMatchSeries(g){
  // Övre rad: [Serie][Arena][Avst]
  const seriesText = g.series_name || "";
  const safeSeries = truncateWithDot(seriesText, 50);
  const seriesLink = g.link_to_series || "";

  const arenaName = truncateWithDot((g.PreferedName || g.arena_raw || ""), 25);
  const dist = isFinite(g.distance_km) ? Math.round(g.distance_km) : null;

  const leftHTML = seriesLink
    ? `<div class="series-left"><a href="${seriesLink}" target="_blank" rel="noopener"><span class="series-text">${safeSeries}</span></a></div>`
    : `<div class="series-left"><span class="series-text">${safeSeries}</span></div>`;

  const arenaHTML = `<div class="series-arena">${arenaName}</div>`;
  const distHTML  = `<div class="series-dist">${dist!=null?`Avst ${dist} km`:""}</div>`;

  // Nedre rad: [Tid][Hemma][logo][RESULT][logo][Borta]
  const timeText = g.status && g.status.toLowerCase().includes("postpon") ? "Postponed" : (g.time || "");
  const timeHTML = `<div class="game-time"><span class="time-text">${timeText}</span></div>`;

  const homeLogo = logoPathForTeamList(g.home_club_list);
  const awayLogo = logoPathForTeamList(g.away_club_list);

  const res = (g.result||"").trim();
  let resultHTML = `<div class="result-dash">–</div>`;
  if(res){
    if(g.result_link){
      resultHTML = `<div class="result"><a class="link" href="${g.result_link}" target="_blank" rel="noopener">${res}</a></div>`;
    }else{
      resultHTML = `<div class="result"><span class="plain">${res}</span></div>`;
    }
  }
  const homeName = truncateWithDot(g.home_team||"", 30);
  const awayName = truncateWithDot(g.away_team||"", 30);

  return `
  <article class="game">
    <div class="game-top--series">
      ${leftHTML}
      ${arenaHTML}
      ${distHTML}
    </div>
    <div class="game-bottom">
      ${timeHTML}
      <div class="team team-left">
        <span class="team-name home-name">${homeName}</span>
        <div class="team-logo-box">
          ${homeLogo ? `<img class="team-logo" src="${homeLogo}" alt="">` : `<span class="team-logo">?</span>`}
        </div>
      </div>
      ${resultHTML}
      <div class="team team-right">
        <div class="team-logo-box">
          ${awayLogo ? `<img class="team-logo" src="${awayLogo}" alt="">` : `<span class="team-logo">?</span>`}
        </div>
        <span class="team-name away-name">${awayName}</span>
      </div>
    </div>
  </article>
  `;
}

/* --------- Render Place View --------- */
function renderPlace(){
  activeSlot.classList.remove("hidden");

  // gruppera efter arena
  const map = groupByArena(gamesByDate);
  // ta bort arenor helt utan matcher (säkerhet)
  for(const [k,arr] of map.entries()){
    if(!arr || arr.length===0) map.delete(k);
  }
  arenaOrder = placeOrderArenas(map);
  if(arenaOrder.length===0){
    scrollEl.innerHTML = `<div style="padding:16px;color:var(--muted)">Inga matcher.</div>`;
    activeSlot.classList.add("hidden");
    return;
  }

  // Välj aktiv arena: första i listan
  if(!currentArena || !map.has(currentArena)){
    currentArena = arenaOrder[0];
  }

  // Bygg HTML: aktiv arena tas bort från scrollista
  const parts = [];

  // Aktiv header (samma stil som arena-header)
  const arrActive = map.get(currentArena);
  const dist = arrActive && isFinite(arrActive[0].distance_km) ? Math.round(arrActive[0].distance_km) : null;
  slotTitle.textContent = currentArena;
  slotDist.textContent  = dist!=null ? `Avst ${dist} km` : "";

  // Innehåll för aktiv arena (utan egen header, bara matcher)
  const activeMatchesHTML = arrActive.map(g=>renderMatchPlace(g)).join("");

  // Övriga arenor med header + matcher
  const rest = arenaOrder.filter(a=>a!==currentArena);
  const restHTML = rest.map(a=>{
    const arr = map.get(a)||[];
    const d = arr[0] && isFinite(arr[0].distance_km) ? Math.round(arr[0].distance_km) : null;
    const header = `<div class="arena-header" data-arena-header="${a}">
      <div>${a}</div><div class="dist">${d!=null?`Avst ${d} km`:""}</div>
    </div>`;
    const matches = arr.map(g=>renderMatchPlace(g)).join("");
    return header + matches;
  }).join("");

  // Lägg ihop (aktiv arenas matcher först)
  parts.push(activeMatchesHTML);
  parts.push(restHTML);
  scrollEl.innerHTML = parts.join("");

  // Justera shrink/trunc efter render
  postAdjustPlace();
  // Scrolla upp till start (visar första matchen överst)
  scrollEl.scrollTo({top:0,behavior:"auto"});
}

/* --------- Post adjustments Place --------- */
function postAdjustPlace(){
  // Shrink “Postponed”/tid för att passa var(--time-w)
  scrollEl.querySelectorAll(".game .time-text").forEach(el=>{
    shrinkToFit(el, 9);
  });
  // Shrink series text till tillgänglig yta
  scrollEl.querySelectorAll(".game-top--place .series-text").forEach(el=>{
    shrinkToFit(el, 10);
  });
  // Result: shrink vid behov (tvåsiffrigt)
  scrollEl.querySelectorAll(".result a, .result .plain").forEach(el=>{
    shrinkToFit(el, 10);
  });
  // Lagnamn (säkerställ att de inte trycker ut logos/resultat)
  scrollEl.querySelectorAll(".home-name,.away-name").forEach(el=>{
    shrinkToFit(el, 10);
  });

  // Smart trim för alla logobilder
  scrollEl.querySelectorAll(".team-logo").forEach(async img=>{
    if(img.dataset.trimmed==="1") return;
    const src = img.getAttribute("src");
    if(!src || src==="") return;
    const trimmed = await smartTrimLogo(src);
    img.src = trimmed;
    img.dataset.trimmed="1";
  });
}

/* --------- Render Series View --------- */
function renderSeries(){
  activeSlot.classList.add("hidden"); // ingen aktiv arena-slot i serie-vy

  const list = seriesSort(gamesByDate);
  if(list.length===0){
    scrollEl.innerHTML = `<div style="padding:16px;color:var(--muted)">Inga matcher.</div>`;
    return;
  }
  const html = list.map(g=>renderMatchSeries(g)).join("");
  scrollEl.innerHTML = html;

  // Post justeringar
  postAdjustSeries();
  scrollEl.scrollTo({top:0,behavior:"auto"});
}

function postAdjustSeries(){
  // Serie-vy: tid på nedre rad → shrink inom fixed time‐width
  scrollEl.querySelectorAll(".game .time-text").forEach(el=>shrinkToFit(el, 9));
  // Serie-vy: serienamn (vänster halva)
  scrollEl.querySelectorAll(".series-left .series-text").forEach(el=>shrinkToFit(el, 10));
  // Arena-namn max (80% av sin yta via grid + ellipsis + shrink)
  scrollEl.querySelectorAll(".series-arena").forEach(el=>shrinkToFit(el, 10));
  // Lagnamn
  scrollEl.querySelectorAll(".home-name,.away-name").forEach(el=>shrinkToFit(el, 10));
  // Resultbox
  scrollEl.querySelectorAll(".result a, .result .plain").forEach(el=>shrinkToFit(el, 10));
  // Smart trim loggor
  scrollEl.querySelectorAll(".team-logo").forEach(async img=>{
    if(img.dataset.trimmed==="1") return;
    const src = img.getAttribute("src");
    if(!src || src==="") return;
    const trimmed = await smartTrimLogo(src);
    img.src = trimmed;
    img.dataset.trimmed="1";
  });
}

/* --------- Main render switch --------- */
function render(){
  filterByDate();
  updateDateUI();

  // sätt hint
  hintEl.textContent = "Visar matcher nära: Kruniusvägen 1, Billdal";

  if(mode===MODE.PLACE){
    renderPlace();
  }else{
    renderSeries();
  }
}

/* --------- Scroll-stickiness (PLATS) --------- */
function updateStickyOnScroll(){
  if(mode!==MODE.PLACE) return;
  const st = scrollEl.scrollTop;
  const dir = (st > lastScrollTop) ? "down" : "up";
  lastScrollTop = st;

  const headers = Array.from(scrollEl.querySelectorAll(".arena-header"));
  if(headers.length===0) return;

  // Hitta index för nuvarande aktiv arena i (aktiv + headers)
  const arenas = [currentArena, ...headers.map(h=>h.dataset.arenaHeader||h.getAttribute("data-arena-header"))];

  // Hjälpfunktion: delvis synlighet
  function pctVisible(el){
    const r = el.getBoundingClientRect();
    const vhTop = activeSlot.getBoundingClientRect().bottom; // under sloten
    const vhBottom = window.innerHeight;
    const top = Math.max(r.top, vhTop);
    const bottom = Math.min(r.bottom, vhBottom);
    const visible = Math.max(0, bottom - top);
    const total = Math.max(1, r.height);
    return visible / total;
  }

  if(dir==="down"){
    // Byt till nästa arena när sista matchen i currentArena är ~borta (synlig < 5%)
    const lastOfCurrent = scrollEl.querySelector(`.game[data-arena="${CSS.escape(currentArena)}"]:last-of-type`);
    if(lastOfCurrent){
      const p = pctVisible(lastOfCurrent);
      if(p < 0.05){
        // nästa arena-header överst?
        const nextHeader = headers.find(h=>true); // första header i list
        if(nextHeader){
          const nextName = nextHeader.dataset.arenaHeader;
          currentArena = nextName;
          slotTitle.textContent = currentArena;
          // sätt dist
          const firstMatchNext = scrollEl.querySelector(`.game[data-arena="${CSS.escape(currentArena)}"]`);
          if(firstMatchNext){
            const distTxt = firstMatchNext.querySelector(".game-top--place")?.textContent; // inte tillgänglig dist här
          }
          // uppdatera distance via närmaste match i nästa
          const gm = gamesByDate.find(g=>g.PreferedName===currentArena);
          const dkm = gm && isFinite(gm.distance_km) ? Math.round(gm.distance_km) : null;
          slotDist.textContent = dkm!=null ? `Avst ${dkm} km` : "";

          // ta bort headern (den aktiva arenan ska inte visas i listan)
          nextHeader.classList.add("active-hidden");
        }
      }
    }
  }else{
    // UP: Byt när första matchen i föregående arena är 100% synlig
    // Dvs: titta på första header i listan (det är nuvarande “följande” arena)
    const firstHeader = headers[0];
    if(firstHeader){
      const prevName = firstHeader.dataset.arenaHeader;
      // villkor: denna headers första match är 100% synlig
      const firstMatchPrev = scrollEl.querySelector(`.game[data-arena="${CSS.escape(prevName)}"]`);
      if(firstMatchPrev){
        const p = pctVisible(firstMatchPrev);
        if(p >= 1.0){
          // Gör previous till aktiv
          currentArena = prevName;
          slotTitle.textContent = currentArena;
          const gm = gamesByDate.find(g=>g.PreferedName===currentArena);
          const dkm = gm && isFinite(gm.distance_km) ? Math.round(gm.distance_km) : null;
          slotDist.textContent = dkm!=null ? `Avst ${dkm} km` : "";

          // Dölj denna header (aktiva arenan ska inte visas i listan)
          firstHeader.classList.add("active-hidden");
        }
      }
    }
  }
}

/* --------- Events --------- */
scrollEl.addEventListener("scroll", updateStickyOnScroll);

prevDayBtn.addEventListener("click", ()=>{
  const ymd = ymdShift(currentDate,-1);
  if(hasGamesOn(ymd)){ currentDate = ymd; currentArena = null; render(); }
});
nextDayBtn.addEventListener("click", ()=>{
  const ymd = ymdShift(currentDate,+1);
  if(hasGamesOn(ymd)){ currentDate = ymd; currentArena = null; render(); }
});

pillPlace.addEventListener("click", ()=>{
  mode = MODE.PLACE;
  applyPills();
  render();
});
pillSeries.addEventListener("click", ()=>{
  mode = MODE.SERIES;
  applyPills();
  render();
});
pillTime.addEventListener("click", ()=>{
  if(mode!==MODE.PLACE){
    mode = (mode===MODE.SERIES) ? MODE.SERIES_TIME : MODE.SERIES;
    applyPills();
    render();
  }
});

btnHome.addEventListener("click", ()=>{
  // hem: idag + plats-vy
  currentDate = todayYMD();
  mode = MODE.PLACE;
  currentArena = null;
  applyPills();
  render();
});
btnMap.addEventListener("click", ()=>{
  // ingen funktion än
});

/* --------- INIT --------- */
(async function init(){
  await loadData();
  // Sätt datum till “nu” om det finns matcher, annars första datum i filen
  if(!hasGamesOn(currentDate)){
    const dates = [...new Set(allGames.map(g=>g.date))].sort();
    if(dates.length>0){ currentDate = dates[0]; }
  }
  applyPills();
  render();

  if(DEBUG){
    console.log("DEBUG mode on");
    // visa vilka logovägar som används
    document.querySelectorAll(".team-logo").forEach(img=>{
      img.onerror = ()=>{
        if(DEBUG) img.replaceWith(document.createTextNode(`[logo-miss: ${img.getAttribute("src")}]`));
      };
    });
  }
})();
</script>
</body>
</html>

