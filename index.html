<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="mobile-web-app-capable" content="yes" />
<title>LocalSport v19.0</title>
<style>
:root{
  --topbar-h:56px;
  --hint-h:26px;
  --slot-h:42px;
  --bg:#f0f3f8;
  --hair:#e2e8f0;
  --text:#0f172a;
  --muted:#64748b;
  --accent:#16a34a;
  --link:#2563eb;
  --card:#ffffff;
  --result-w:88px; /* fast bredd resultatbox */
}

/* RESET */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,Roboto,Arial,sans-serif;color:var(--text);overscroll-behavior:none;}
.device{width:100%;height:100dvh;display:flex;flex-direction:column;overflow:hidden}

/* TOPBAR */
.topbar{position:sticky;top:0;z-index:500;background:#fff;border-bottom:1px solid var(--hair);}
.topbar-inner{
  display:grid;grid-template-columns:1fr auto 1fr;align-items:center;
  height:var(--topbar-h);padding:6px 8px;gap:8px;
}
.cluster-left,.cluster-right{display:flex;gap:8px;align-items:center;}
.icon-btn{
  width:32px;height:32px;border-radius:10px;border:1px solid var(--hair);
  background:#f8fafc;display:grid;place-items:center;cursor:pointer;overflow:hidden;
}
.icon-btn img{width:100%;height:100%;object-fit:cover;border-radius:10px}
.cluster-center{
  display:flex;align-items:center;justify-content:center;gap:8px;min-width:0;
  /* flytta lite vänster så paketet centreras visuellt mellan karta & sortering */
  transform:translateX(-6px);
}
.date-block{display:flex;flex-direction:column;align-items:center;font-weight:700;font-size:13.5px;line-height:1.1;min-width:88px}
.arrow{width:32px;height:32px;border-radius:10px;border:1px solid var(--hair);display:grid;place-items:center;user-select:none}
.arrow.enabled{background:#dcfce7;color:#065f46;border-color:#86efac;cursor:pointer}
.arrow.disabled{background:#f1f5f9;color:#94a3b8;border-color:#cbd5e1;opacity:.85}

/* SORTERING */
.sort-stack{border:1px solid var(--hair);border-radius:10px;background:#fff;padding:4px 6px;display:flex;flex-direction:column;align-items:center;}
.sort-top{font-size:12px;font-weight:600;margin-bottom:2px}
.sort-bottom{display:flex;gap:4px;flex-wrap:nowrap}
.pill{padding:4px 8px;font-size:11px;border-radius:999px;font-weight:600;border:1px solid var(--hair);cursor:pointer;user-select:none}
.pill.on{background:#dcfce7;border-color:#86efac;color:var(--accent)}
.pill.off{background:#f1f5f9;border-color:#cbd5e1;color:#94a3b8}
.pill.lock{opacity:.6;cursor:not-allowed}

/* HINT */
.hint{position:sticky;top:var(--topbar-h);height:var(--hint-h);background:#fff;border-bottom:1px solid var(--hair);text-align:center;font-size:12px;line-height:var(--hint-h);color:var(--muted);z-index:450}

/* STICKY ARENA SLOT (endast Plats-vy) */
.group-slot{
  position:sticky;top:calc(var(--topbar-h) + var(--hint-h));
  height:var(--slot-h);display:flex;justify-content:space-between;align-items:center;
  padding:10px 12px;font-size:14px;font-weight:700;background:#fff;border-bottom:1px solid var(--hair);z-index:425;
}
.group-title, .group-sub{font-weight:700}
.group-sub{color:var(--muted);}

/* SCROLLAREA */
.scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;background:var(--bg);}

/* ARENA HEADER (i scroll-listan) */
.arena-header{
  padding:10px 12px;background:#fff;border-bottom:1px solid var(--hair);
  font-weight:700;display:flex;justify-content:space-between;align-items:center;
}
.arena-header.active-hidden{visibility:hidden;height:0;padding:0;margin:0;border:none}

/* GAME CARD */
.game{background:var(--card);border-top:1px dashed #e5e7eb;padding:8px 12px;display:grid;gap:6px}

/* Plats-vy — övre rad: Tid + Serie (serie shrink/trunk) */
.row-top{display:flex;align-items:center;gap:8px;min-width:0}
.game-time{font-weight:800;white-space:nowrap}
.series-name{font-weight:600;min-width:0;flex:1 1 auto}
.series-name a{color:var(--link);text-decoration:none}
.series-fit{display:inline-block;max-width:100%;white-space:nowrap;overflow:hidden;text-overflow:clip}

/* Nedre rad: lag + resultatbox centrerad */
.row-bottom{
  display:grid;grid-template-columns:1fr auto var(--result-w) auto 1fr;align-items:center;column-gap:8px;
}
.team{display:flex;align-items:center;gap:6px;font-weight:600;min-width:0}
.team.home{justify-content:flex-end;text-align:right}
.team.away{justify-content:flex-start;text-align:left}
.team-name{max-width:100%;white-space:nowrap;overflow:hidden;text-overflow:clip}
.team-logo{
  width:28px;height:28px; /* fyrkantig, utan ringar */
  object-fit:contain; background:#fff; /* osynlig ram */
}

/* RESULT BOX */
.result{
  display:flex;align-items:center;justify-content:center;
  width:var(--result-w); height:28px; border:1px solid var(--hair); border-radius:8px;
  background:#f8fafc; font-weight:800;
}
.result.has-link a{color:var(--link)}
.result a{display:block;width:100%;text-align:center;text-decoration:none;color:#111827}
.result-text{display:inline-block;transform:translateY(0)} /* baseline align */
.result.shrink{font-size:12px}

/* SERIE-VY — statiskt fönster och två rader */
.mode-series .group-slot{display:none} /* ingen aktiv arena header i serie-vy */
.mode-series .arena-header{display:none} /* inga arenarubriker i serie-vy */
.mode-series .row-top{display:grid;grid-template-columns:auto 1fr auto auto;column-gap:10px;align-items:center}
.mode-series .game-time{color:#0f172a;font-weight:800}
.mode-series .series-name{min-width:0}
.mode-series .arena-name{min-width:0;max-width:80%;text-align:right;white-space:nowrap;overflow:hidden;text-overflow:clip}
.mode-series .arena-fit{display:inline-block;max-width:100%}
.mode-series .dist{white-space:nowrap;color:var(--muted);font-weight:700}
.mode-series .row-bottom{grid-template-columns:1fr auto var(--result-w) auto 1fr;}

/* Truncate/shrink helpers (en punkt) */
.trunc-1::after{content:"."}
.shrink{font-size:12px;color:#b91c1c}

/* Utility */
.divider{height:7px;background:var(--bg);border-top:1px dashed var(--hair)}
.hidden{display:none !important}
</style>
</head>
<body>
<div class="device">

  <!-- TOP BAR -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="cluster-left">
        <button id="btnHome" class="icon-btn" title="Hem">
          <img src="icons/home.jpeg" alt="Hem" />
        </button>
        <button id="btnMap" class="icon-btn" title="Karta">
          <img src="icons/map.jpeg" alt="Karta" />
        </button>
      </div>

      <div class="cluster-center">
        <div id="btnPrev" class="arrow disabled">◀</div>
        <div class="date-block" id="dateBlock"><span>Idag</span><span>Tors</span><span>30 okt</span></div>
        <div id="btnNext" class="arrow disabled">▶</div>
      </div>

      <div class="cluster-right">
        <div class="sort-stack">
          <div class="sort-top">Sortering</div>
          <div class="sort-bottom">
            <span id="pillPlace" class="pill on">Plats</span>
            <span id="pillSeries" class="pill off">Serie</span>
            <span id="pillTime" class="pill off">Tid</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- HINT -->
  <div class="hint" id="hint">Visar matcher nära: Kruniusvägen 1, Billdal</div>

  <!-- AKTIV ARENA HEADER (endast plats-vy) -->
  <div id="groupSlot" class="group-slot">
    <div class="group-title">—</div>
    <div class="group-sub">—</div>
  </div>

  <!-- SCROLL AREA -->
  <main id="scrollArea" class="scroll"></main>
</div>

<script>
/* ==========================================================
   KONSTANTER / DATA-KÄLLOR
========================================================== */
const USER_POS = { lat:57.590214281624824, lon:11.94608216084837 }; // Billdal
const GAMES_CSV = 'games.csv';
const LOGO_MAP_TXT = 'data/Clubs_Organisatons_logos__ClubOrgName_LogoFileName.txt';

const MODE = { PLACE:'place', SERIES:'series', SERIES_TIME:'series_time' };
let mode = MODE.PLACE;

const els = {
  scroll: document.getElementById('scrollArea'),
  slot: document.getElementById('groupSlot'),
  slotTitle: document.querySelector('#groupSlot .group-title'),
  slotSub: document.querySelector('#groupSlot .group-sub'),
  pillPlace: document.getElementById('pillPlace'),
  pillSeries: document.getElementById('pillSeries'),
  pillTime: document.getElementById('pillTime'),
  btnPrev: document.getElementById('btnPrev'),
  btnNext: document.getElementById('btnNext'),
  dateBlock: document.getElementById('dateBlock')
};

let allGames = [];
let dateCursor = null; // yyyy-mm-dd string (dag som visas)
let logoMap = {}; // "Club/Org" -> filename
let currentArena = null;
let arenaOrder = []; // i plats-vy (sorterad efter avstånd)

/* ==========================================================
   HJÄLPARE
========================================================== */
const parseCSV = (text) => {
  // ;-separerad utan citat-hantering (datan följer formatet)
  return text.trim().split(/\r?\n/).map(line => {
    const parts = line.split(';');
    return {
      date: parts[0]?.trim(),
      time: parts[1]?.trim(),
      series_name: parts[2]?.trim(),
      link_to_series: parts[3]?.trim(),
      admin_host: parts[4]?.trim(),
      home_team: parts[5]?.trim(),
      away_team: parts[6]?.trim(),
      result: parts[7]?.trim(),
      result_link: parts[8]?.trim(),
      arena: parts[9]?.trim(),
      status: parts[10]?.trim(),
      iteration_fetched: parts[11]?.trim(),
      iterations_total: parts[12]?.trim(),
      home_club_list: parts[13]?.trim(),
      away_club_list: parts[14]?.trim(),
      arena_nbr: parts[15]?.trim(),
      PreferedName: parts[16]?.trim(),
      Lat: parseFloat(parts[17]),
      Long: parseFloat(parts[18]),
    };
  });
};
const fetchText = (url) => fetch(url).then(r=>{ if(!r.ok) throw new Error(url); return r.text(); });

const deg2rad = d => d*Math.PI/180;
function haversine(a,b){
  const R=6371; // km
  const dLat=deg2rad(b.lat-a.lat), dLon=deg2rad(b.lon-a.lon);
  const s=Math.sin(dLat/2)**2 + Math.cos(deg2rad(a.lat))*Math.cos(deg2rad(b.lat))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(s));
}
function kmFmt(km){ return `Avst ${Math.round(km)} km`; }

/* logo mapping */
function parseLogoMap(text){
  const map = {};
  text.split(/\r?\n/).forEach(line=>{
    line=line.trim(); if(!line) return;
    const idx = line.lastIndexOf(';');
    if(idx<0) return;
    const name = line.slice(0,idx).trim();
    const file = line.slice(idx+1).trim();
    map[name.toLowerCase()] = file;
  });
  return map;
}
function firstClubName(list){
  if(!list) return '';
  return list.split(',')[0].trim();
}
function logoFor(clubName){
  const key = (clubName||'').toLowerCase();
  const file = logoMap[key];
  if(file) return `logos/${file}`;
  // fallback: grå placeholder med initialer
  return null;
}
function initials(team){
  return team.split(/\s+/).map(t=>t[0]).join('').toUpperCase().slice(0,3);
}

/* datum */
function ymd(d){ return d.toISOString().slice(0,10); }
function weekdayShort(d){
  return ['Sön','Mån','Tis','Ons','Tors','Fre','Lör'][d.getDay()];
}
function monthShort(d){
  return ['jan','feb','mar','apr','maj','jun','jul','aug','sep','okt','nov','dec'][d.getMonth()];
}
function setDateHeader(d, isToday){
  els.dateBlock.innerHTML = `<span>${isToday?'Idag':''}</span><span>${weekdayShort(d)}</span><span>${d.getDate()} ${monthShort(d)}</span>`;
}

/* ==========================================================
   SERIE-PRIORITET
========================================================== */
const DISTRICT_ORDER = [
  "Stockholms Ishockeyförbund","Göteborgs Ishockeyförbund","Västergötlands Ishockeyförbund","Smålands Ishockeyförbund",
  "Bohuslän Dals Ishockeyförbund","Skånes Ishockeyförbund","Upplands Ishockeyförbund","Södermanlands Ishockeyförbund",
  "Hälsinglands Ishockeyförbund","Östergötlands Ishockeyförbund","Gästriklands Ishockeyförbund","Norrbottens Ishockeyförbund",
  "Blekinge Ishockeyförbund","Örebro läns Ishockeyförbund","Västmanlands Ishockeyförbund","Dalanas Ishockeyförbund",
  "Jämtland-Härjedalens Ishockeyförbund","Gotlands Ishockeyförbund","Ångermanlands Ishockeyförbund","Västerbottens Ishockeyförbund",
  "Värmlands Ishockeyförbund","Medelpads Ishockeyförbund","Hallands Ishockeyförbund"
].map(s=>s.toLowerCase());

function seriesRank(g){
  const host = (g.admin_host||'').toLowerCase();
  const s = (g.series_name||'').toLowerCase();

  const isSIF = host.includes('svenska ishockeyförbundet') || host === '90' || host.includes('(90)');
  const isRegion = /93|94|95|96/.test(host) || host.includes('region');
  const isDistrict = !isSIF && !isRegion;

  const uMatch = s.match(/u(\d{2})/); // U20, U18, etc
  const uVal = uMatch ? parseInt(uMatch[1],10) : null;
  const uScore = (uVal!==null) ? (100 - uVal) : null; // högre U → högre prio (U20 > U18) => lägre rank-tal = bättre

  if(isSIF){
    if(s.includes('shl')) return 1;
    if(s.includes('hockeyallsvenskan') || s === 'ha') return 2;
    if(s.includes('sdhl')) return 3;
    if(s.includes('hockeyettan')) return 4;
    if(s.startsWith('swe')) return 5; // landslag
    if(uScore!==null) return 10 - uScore; // U20 högre → får mindre tal → högre prio
    return 99;
  }

  if(isRegion){
    // Region-top order
    if(s.includes('hockeytvåan')) return 110;
    if(s.includes('ndhl')) return 111;
    if(s.includes('hockeytrean')) return 112;
    if(s.includes('damtvåan')) return 113;
    if(s.includes('u20') && s.includes('regional')) return 114;
    if(s.includes('hockeyfyran')) return 115;
    if(uScore!==null) return 130 - uVal; // U20 → större uVal → lägre rank
    if(s.includes('tv-pucken') || s.includes('tv pucken') || s.includes('tvpucken')) return 180;
    // region tiebreaker: 93, 95, 96, 94
    let regionTie = 0;
    if(host.includes('93')) regionTie = 0;
    else if(host.includes('95')) regionTie = 1;
    else if(host.includes('96')) regionTie = 2;
    else if(host.includes('94')) regionTie = 3;
    return 199 + regionTie;
  }

  if(isDistrict){
    if(s.includes('hockeyfyran')) return 210;
    if(s.includes('division 5') || s.includes('division5') || s.includes('div 5')) return 211;
    if(uScore!==null) return 230 - uVal;
    // distrikt tie enligt given lista
    const idx = DISTRICT_ORDER.findIndex(d => host.includes(d));
    return 299 + (idx>=0 ? idx : 99);
  }

  return 9999;
}

/* ==========================================================
   RENDERING
========================================================== */
function fitTruncate(text, maxChars){
  if(text.length <= maxChars) return text;
  return text.slice(0, maxChars).trimEnd() + '.';
}
function makeSeriesSpan(seriesName, link, maxChars){
  const txt = fitTruncate(seriesName||'', maxChars);
  const el = document.createElement('span');
  el.className = 'series-fit';
  if(link){
    el.innerHTML = `<a href="${link}" target="_blank" rel="noopener">${txt}</a>`;
  }else{
    el.textContent = txt;
  }
  return el;
}

function makeTeamCell(name, logoURL, side){
  const d = document.createElement('div');
  d.className = 'team ' + side;
  const nameSpan = document.createElement('span');
  nameSpan.className = 'team-name';
  nameSpan.textContent = name;
  const img = document.createElement('img');
  img.className = 'team-logo';
  if(logoURL){
    img.src = logoURL;
    img.alt = name;
  }else{
    // text-placeholder om logo saknas
    const ph = document.createElement('div');
    ph.style.width='28px'; ph.style.height='28px';
    ph.style.display='grid'; ph.style.placeItems='center';
    ph.style.background='#e5e7eb'; ph.style.borderRadius='4px';
    ph.style.fontSize='10px'; ph.style.color='#111827';
    ph.textContent = initials(name);
    d.appendChild(nameSpan);
    d.appendChild(ph);
    return d;
  }
  if(side==='home'){ // hemmanamn före logga
    d.appendChild(nameSpan);
    d.appendChild(img);
  }else{
    d.appendChild(img);
    d.appendChild(nameSpan);
  }
  return d;
}

function makeResultBox(result, link){
  const r = document.createElement('div');
  r.className = 'result';
  const text = (result && result.trim()) ? result.trim() : '–';
  // shrink vid långa resultat (ex "10 - 12")
  const needsShrink = text.length > 5; // grov tumregel
  if(needsShrink) r.classList.add('shrink');
  if(link){
    r.classList.add('has-link');
    r.innerHTML = `<a href="${link}" target="_blank" rel="noopener"><span class="result-text">${text}</span></a>`;
  }else{
    r.innerHTML = `<span class="result-text">${text}</span>`;
  }
  return r;
}

function gameTopRow_PLACE(g){
  const row = document.createElement('div');
  row.className = 'row-top';
  const t = document.createElement('div');
  t.className = 'game-time';
  t.textContent = g.time || '';
  const s = document.createElement('div');
  s.className = 'series-name';
  // device-adaptiv maxlängd (större skärm → fler tecken)
  const vw = Math.max(document.documentElement.clientWidth || 390, 320);
  const maxChars = vw >= 1000 ? 70 : vw >= 768 ? 60 : 50;
  s.appendChild(makeSeriesSpan(g.series_name, g.link_to_series, maxChars));
  row.appendChild(t); row.appendChild(s);
  return row;
}

function gameTopRow_SERIES(g, distKm){
  const row = document.createElement('div');
  row.className = 'row-top';
  // i serie-vy visas: Tid | Serie (vänster) | Arena (mitten/höger begr.) | Avstånd (höger)
  // grid i CSS (.mode-series .row-top)
  const time = document.createElement('div'); time.className='game-time'; time.textContent=g.time||'';
  const s = document.createElement('div'); s.className='series-name';
  const vw = Math.max(document.documentElement.clientWidth || 390, 320);
  const maxSeries = vw >= 1000 ? 70 : vw >= 768 ? 60 : 50; // får plats i vänsterhalvan
  s.appendChild(makeSeriesSpan(g.series_name, g.link_to_series, maxSeries));
  const arena = document.createElement('div'); arena.className='arena-name';
  const aSpan = document.createElement('span'); aSpan.className='arena-fit';
  // Serie-vy: arenanamnet begränsas hårdare (80% redan i CSS). Trunkera efter 25 tecken, sedan shrink vid behov
  aSpan.textContent = fitTruncate(g.PreferedName||g.arena||'', 25);
  arena.appendChild(aSpan);
  const dist = document.createElement('div'); dist.className='dist'; dist.textContent = `${Math.round(distKm)} km`;
  row.append(time, s, arena, dist);
  return row;
}

function gameBottomRow(g, homeLogo, awayLogo){
  const row = document.createElement('div');
  row.className = 'row-bottom';
  const home = makeTeamCell(g.home_team, homeLogo, 'home');
  const leftPad = document.createElement('div'); leftPad.textContent=''; // auto-col
  const res = makeResultBox(g.result, g.result_link);
  const rightPad = document.createElement('div'); rightPad.textContent='';
  const away = makeTeamCell(g.away_team, awayLogo, 'away');
  row.append(home, leftPad, res, rightPad, away);
  return row;
}

function gameCard(g, distKm, isSeriesMode){
  const art = document.createElement('article');
  art.className='game';
  const top = isSeriesMode ? gameTopRow_SERIES(g, distKm) : gameTopRow_PLACE(g);
  const homeLogo = logoFor(firstClubName(g.home_club_list));
  const awayLogo = logoFor(firstClubName(g.away_club_list));
  const bottom = gameBottomRow(g, homeLogo, awayLogo);
  art.append(top, bottom);
  // Postponed → tid ska inte spräcka linjeringen: shrinka själva texten på time om texten är "Postponed"
  if((g.time||'').toLowerCase().includes('postponed')){
    top.querySelector('.game-time').style.fontSize = '12px';
  }
  return art;
}

/* ==========================================================
   RENDER PLATS-VY
========================================================== */
function renderPlaceView(games){
  document.body.classList.remove('mode-series');
  els.slot.classList.remove('hidden');
  els.scroll.innerHTML='';
  // Grupp per arena (PreferedName)
  const byArena = {};
  games.forEach(g=>{
    const key = g.PreferedName || g.arena || 'Okänd Arena';
    (byArena[key] ||= []).push(g);
  });
  // Filtrera bort arenor utan matcher
  let arenas = Object.keys(byArena)
    .filter(a => byArena[a].length>0)
    .map(a=>{
      const lat = byArena[a][0].Lat, lon = byArena[a][0].Long;
      const dist = (isFinite(lat) && isFinite(lon)) ? haversine(USER_POS,{lat,lon}) : 9999;
      return {name:a, dist, games:byArena[a].slice().sort((x,y)=>x.time.localeCompare(y.time))};
    })
    .sort((a,b)=>a.dist-b.dist);
  arenaOrder = arenas.map(a=>a.name);

  // Bygg DOM
  arenas.forEach((A, idx)=>{
    const header = document.createElement('div');
    header.className='arena-header';
    header.dataset.arenaHeader = A.name;
    header.innerHTML = `<div>${A.name}</div><div>${kmFmt(A.dist)}</div>`;
    els.scroll.appendChild(header);

    A.games.forEach(g=>{
      const el = gameCard(g, A.dist, false);
      el.dataset.arena = A.name;
      els.scroll.appendChild(el);
    });

    if(idx<arenas.length-1){
      const div = document.createElement('div');
      div.className='divider';
      els.scroll.appendChild(div);
    }
  });

  // init aktiv arena (första synliga headern)
  const first = arenas[0];
  if(first){
    currentArena = first.name;
    els.slotTitle.textContent = first.name;
    els.slotSub.textContent = kmFmt(first.dist);
  }

  // kopiera slot-stil visuellt som header (redan likt)
  updateStickyArena(true);
}

/* ==========================================================
   RENDER SERIE-VY (statisk)
========================================================== */
function renderSeriesView(games, timePrimary=false){
  document.body.classList.add('mode-series');
  els.slot.classList.add('hidden');
  els.scroll.innerHTML='';
  // sortera med serieprioritet → sen tid (eller tid → serieprio)
  let gs = games.slice();
  if(timePrimary){
    gs.sort((a,b)=> a.time.localeCompare(b.time) || seriesRank(a)-seriesRank(b));
  }else{
    gs.sort((a,b)=> seriesRank(a)-seriesRank(b) || a.time.localeCompare(b.time));
  }
  // render
  gs.forEach(g=>{
    const pos = {lat:g.Lat, lon:g.Long};
    const dist = (isFinite(pos.lat)&&isFinite(pos.lon)) ? haversine(USER_POS,pos) : 9999;
    els.scroll.appendChild(gameCard(g, dist, true));
  });
}

/* ==========================================================
   STICKY / SCROLL-LOGIK (PLATS-VY)
========================================================== */
let lastScrollTop = 0;

function visiblePart(el){
  const r = el.getBoundingClientRect();
  const top = Math.max(r.top, els.scroll.getBoundingClientRect().top);
  const bottom = Math.min(r.bottom, window.innerHeight);
  const vis = Math.max(0, bottom - top);
  return vis / Math.max(1, r.height);
}

function updateStickyArena(forceInit=false){
  if(mode!==MODE.PLACE) return;

  // Dölj endast header för aktiv arena
  arenaOrder.forEach(a=>{
    const hdr = els.scroll.querySelector(`.arena-header[data-arena-header="${a}"]`);
    if(hdr) hdr.classList.toggle('active-hidden', a===currentArena);
  });

  const st = els.scroll.scrollTop;
  const dir = (st > lastScrollTop) ? 'down' : (st < lastScrollTop ? 'up' : 'none');
  lastScrollTop = st;

  if(forceInit) dir='none';

  const stickyBottom = els.slot.getBoundingClientRect().bottom;

  const idx = arenaOrder.indexOf(currentArena);
  if(idx<0) return;

  // helper: hämta arena DOM
  const hdrOf = (name)=>els.scroll.querySelector(`.arena-header[data-arena-header="${name}"]`);
  const gamesOf = (name)=>Array.from(els.scroll.querySelectorAll(`.game[data-arena="${name}"]`));

  if(dir==='down'){
    // Byt när sista matchen i current < 25% synlig
    const curr = arenaOrder[idx];
    const gList = gamesOf(curr);
    if(gList.length){
      const lastGame = gList[gList.length-1];
      const vis = visiblePart(lastGame);
      if(vis < 0.25){
        const next = arenaOrder[idx+1];
        if(next){
          currentArena = next;
          const lat = parseFloat(allByArena[next]?.Lat)||NaN;
          const lon = parseFloat(allByArena[next]?.Long)||NaN;
          const dist = isFinite(lat)&&isFinite(lon) ? haversine(USER_POS,{lat,lon}) : 9999;
          els.slotTitle.textContent = next;
          els.slotSub.textContent = kmFmt(dist);
          // uppdatera hide visas
          arenaOrder.forEach(a=>{
            const hdr = hdrOf(a);
            if(hdr) hdr.classList.toggle('active-hidden', a===currentArena);
          });
        }
      }
    }
  } else if(dir==='up'){
    // Byt när nästa arenas sista match (tidsmässigt) är 100% synlig
    const prev = arenaOrder[idx-1];
    if(prev){
      const prevGames = gamesOf(prev);
      if(prevGames.length){
        // "sista matchen tidsmässigt" är sista i listan
        const lastPrev = prevGames[prevGames.length-1];
        const vis = visiblePart(lastPrev);
        if(vis >= 1.0){
          currentArena = prev;
          const lat = parseFloat(allByArena[prev]?.Lat)||NaN;
          const lon = parseFloat(allByArena[prev]?.Long)||NaN;
          const dist = isFinite(lat)&&isFinite(lon) ? haversine(USER_POS,{lat,lon}) : 9999;
          els.slotTitle.textContent = prev;
          els.slotSub.textContent = kmFmt(dist);
          arenaOrder.forEach(a=>{
            const hdr = hdrOf(a);
            if(hdr) hdr.classList.toggle('active-hidden', a===currentArena);
          });
        }
      }
    }
  }
}
els.scroll.addEventListener('scroll', ()=> updateStickyArena(false));

/* ==========================================================
   INTERAKTION
========================================================== */
function applyPills(){
  els.pillPlace.className = 'pill ' + (mode===MODE.PLACE?'on':'off');
  els.pillSeries.className = 'pill ' + ((mode===MODE.SERIES||mode===MODE.SERIES_TIME)?'on':'off');
  els.pillTime.className = 'pill ' + (mode===MODE.SERIES_TIME?'on':'off');
}

els.pillPlace.onclick = ()=>{ mode=MODE.PLACE; applyPills(); renderDay(); };
els.pillSeries.onclick= ()=>{ mode=MODE.SERIES; applyPills(); renderDay(); };
els.pillTime.onclick  = ()=>{
  if(mode===MODE.PLACE) return; // tid låst i plats-vy
  mode = (mode===MODE.SERIES)?MODE.SERIES_TIME:MODE.SERIES;
  applyPills(); renderDay();
};

document.getElementById('btnHome').onclick = ()=>{
  const today = new Date();
  dateCursor = ymd(today);
  mode = MODE.PLACE; applyPills();
  renderDay();
};

document.getElementById('btnMap').onclick = ()=>{
  // ej implementerat (placeholder)
  alert('Kartläge kommer i en senare version.');
};

/* Datum-navigering (aktivera pil om det finns matcher dagen före/efter) */
function setArrowState(prevOk, nextOk){
  els.btnPrev.className = 'arrow ' + (prevOk?'enabled':'disabled');
  els.btnNext.className = 'arrow ' + (nextOk?'enabled':'disabled');
  els.btnPrev.onclick = prevOk ? ()=>{ shiftDay(-1); } : null;
  els.btnNext.onclick = nextOk ? ()=>{ shiftDay(1); } : null;
}
function shiftDay(delta){
  const d = new Date(dateCursor);
  d.setDate(d.getDate()+delta);
  dateCursor = ymd(d);
  renderDay();
}

/* ==========================================================
   LADDA DATA & RENDER PER DAG
========================================================== */
let allByArena = {}; // namn -> {Lat, Long}

async function loadData(){
  const [csvTxt, mapTxt] = await Promise.all([fetchText(GAMES_CSV), fetchText(LOGO_MAP_TXT)]);
  allGames = parseCSV(csvTxt).filter(g => g.date);
  logoMap = parseLogoMap(mapTxt);

  // default datum = idag om det finns matcher, annars närmast dag med match
  const today = new Date();
  const todayStr = ymd(today);
  const dates = Array.from(new Set(allGames.map(g=>g.date))).sort();
  dateCursor = dates.includes(todayStr)? todayStr : dates[0];

  renderDay();
}

function renderDay(){
  // sätt datumrubrik
  const d = new Date(dateCursor);
  const isToday = (dateCursor === ymd(new Date()));
  setDateHeader(d, isToday);

  // filtrera matcher för dagen
  const dayGames = allGames.filter(g => g.date === dateCursor);
  // beräkna avstånd och PreferredName fix
  dayGames.forEach(g=>{
    // använd PreferedName för arena-namn
    if(!(g.PreferedName && g.PreferedName.length)) g.PreferedName = g.arena || 'Okänd Arena';
    allByArena[g.PreferedName] = { Lat:g.Lat, Long:g.Long };
  });

  // pilar
  const allDays = Array.from(new Set(allGames.map(g=>g.date))).sort();
  const i = allDays.indexOf(dateCursor);
  setArrowState(i>0, i<allDays.length-1);

  if(mode===MODE.PLACE){
    // sortera arenor efter avstånd
    renderPlaceView(dayGames);
  }else{
    // sortera enligt serieprioritet
    renderSeriesView(dayGames, mode===MODE.SERIES_TIME);
  }
}

/* START */
loadData().catch(err=>{
  console.error('Laddfel:', err);
  els.scroll.innerHTML = `<div style="padding:16px">Kunde inte läsa in datafilerna.</div>`;
});
</script>
</body>
</html>

