<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<meta name="mobile-web-app-capable" content="yes"/>
<title>LocalSport v18.4</title>

<style>
/* ---------------- ROOT THEME ---------------- */
:root{
  --topbar-h:56px;
  --hint-h:26px;
  --slot-h:42px;
  --bg:#f0f3f8;
  --hair:#e2e8f0;
  --text:#0f172a;
  --muted:#64748b;
  --accent:#16a34a;
  --link:#2563eb;
  --pill-off:#f1f5f9;
  --pill-on:#dcfce7;
  --card:#ffffff;
  --result-w:86px; /* fast resultatbox-bredd */
}

/* ---------------- RESET / BASE ---------------- */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,Roboto,Arial,sans-serif;color:var(--text);overscroll-behavior:none}
.device{width:100%;height:100dvh;display:flex;flex-direction:column;overflow:hidden}

/* ---------------- TOP BAR ---------------- */
.topbar{position:sticky;top:0;z-index:500;background:#fff;border-bottom:1px solid var(--hair)}
.topbar-inner{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;height:var(--topbar-h);padding:6px}
.cluster-left,.cluster-right{display:flex;gap:8px;align-items:center}
.icon-btn{
  width:36px;height:36px;border-radius:10px;border:1px solid var(--hair);
  background:#f8fafc;display:grid;place-items:center;cursor:pointer;
}
.icon-img{width:20px;height:20px;object-fit:contain}
.cluster-center{display:flex;align-items:center;justify-content:center;gap:8px}
.date-block{display:flex;flex-direction:column;align-items:center;font-weight:700;font-size:13.5px;line-height:1.1;min-width:90px}
.arrow{
  width:32px;height:32px;border-radius:10px;border:1px solid var(--hair);
  background:#fff;display:grid;place-items:center;cursor:pointer;font-weight:800;
}
.arrow.green{color:#16a34a;border-color:#86efac;background:#f0fdf4}
.arrow.gray{color:#94a3b8;background:#f8fafc;border-color:#e2e8f0}
.arrow span{display:block;transform:translateY(-0.5px)} /* optisk centrering */

/* ---------------- SORTERING ---------------- */
.sort-stack{border:1px solid var(--hair);border-radius:10px;background:#fff;padding:4px 6px;display:flex;flex-direction:column;align-items:center}
.sort-top{font-size:12px;font-weight:600;margin-bottom:2px}
.sort-bottom{display:flex;gap:4px}
.pill{padding:4px 8px;font-size:11px;border-radius:999px;font-weight:600;border:1px solid var(--hair);user-select:none;cursor:pointer}
.pill.on{background:var(--pill-on);border-color:#86efac;color:var(--accent)}
.pill.off{background:var(--pill-off);border-color:#cbd5e1;color:#94a3b8}
.pill.lock{opacity:.65;cursor:not-allowed}

/* ---------------- HINT ---------------- */
.hint{
  position:sticky;top:var(--topbar-h);height:var(--hint-h);background:#fff;border-bottom:1px solid var(--hair);
  text-align:center;font-size:12px;line-height:var(--hint-h);color:var(--muted);z-index:450
}

/* ---------------- STICKY ARENA SLOT ---------------- */
.group-slot{
  position:sticky;top:calc(var(--topbar-h) + var(--hint-h));height:var(--slot-h);
  display:flex;justify-content:space-between;align-items:center;padding:10px 12px;font-size:14px;font-weight:700;
  background:#fff;border-bottom:1px dashed var(--hair);z-index:425
}

/* ---------------- SCROLL AREA ---------------- */
.scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;background:var(--bg)}

/* ---------------- ARENA HEADER (i listan) ---------------- */
.arena-header{
  padding:10px 12px;background:#fff;border-bottom:1px dashed var(--hair);font-weight:700;display:flex;justify-content:space-between
}
.arena-header.active-hidden{visibility:hidden;height:0;padding:0;margin:0;border:none}

/* ---------------- GAME CARD ---------------- */
.game{background:var(--card);border-top:1px dashed #e5e7eb;padding:8px 12px;display:grid;gap:6px}

/* Top-rad (Plats-vy) */
.game-top{display:flex;align-items:center;gap:8px;flex-wrap:nowrap}
.game-time{font-weight:700;white-space:nowrap}
.game-series{min-width:0}
.game-series a{
  text-decoration:none;font-weight:600;color:var(--link);
  display:inline-block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  max-width:100%;
}

/* Top-rad (Serie-vy) layout: vänster = serie, höger = arena + avstånd */
.ser-top{display:flex;align-items:center;gap:8px}
.ser-left{flex:1 1 50%;min-width:0}
.ser-right{flex:1 1 50%;min-width:0;display:flex;justify-content:flex-end;gap:10px;align-items:center}
.ser-arena{
  max-width:calc(50vw - 70px); /* “mitthälften”, kommer justeras JS vid olika viewport */
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:600;text-align:right
}
.ser-dist{white-space:nowrap;font-size:12px;color:var(--muted)}

/* Bottom-rad (båda vyer) */
.game-bottom{
  display:grid;grid-template-columns:1fr var(--result-w) 1fr;align-items:center;column-gap:8px
}

/* Hemmalag och Bortalag – tajtare mot resultatboxen och anpassningsbar text */
.team{
  display:inline-flex;align-items:center;gap:6px;font-weight:600;min-width:0;white-space:nowrap
}
.team.home{justify-content:flex-end}   /* hemmalag höger-centrerat mot sin logo */
.team.away{justify-content:flex-start} /* bortalag vänster-centrerat från sin logo */

.team-logo{
  width:28px;height:28px;border-radius:50%;border:1px solid var(--hair);object-fit:cover;background:#eee;flex:0 0 auto
}
/* Notera: vi kommer senare ev. byta till “non-white fit” – ej i denna version */

.team-name{
  display:inline-block;max-width: min(40vw,220px);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:13px
}

/* Resultatbox: fast bredd, auto-shrink text */
.result{
  display:flex;align-items:center;justify-content:center;
  width:var(--result-w);height:28px;border-radius:8px;border:1px solid var(--hair);background:#f1f5f9;
  font-weight:700;overflow:hidden
}
.result a{color:var(--link);text-decoration:none;display:inline-block}
.result .plain{color:#111} /* “–” utan länk */

/* Divider mellan arenor i plats-vy */
.divider{height:7px;background:var(--bg);border-top:1px dashed var(--hair)}

/* ---------------- RESPONSIVE TWEAKS ---------------- */
@media (min-width:768px){
  :root{ --result-w:96px }
  .team-logo{ width:30px; height:30px }
  .team-name{ max-width: min(36vw,280px) }
  .ser-arena{ max-width: calc(50vw - 100px) }
}
@media (min-width:1200px){
  :root{ --result-w:108px }
  .team-logo{ width:32px; height:32px }
  .team-name{ max-width: min(32vw,360px) }
  .ser-arena{ max-width: calc(50vw - 140px) }
}
</style>
</head>
<body>
<div class="device">

  <!-- TOP BAR -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="cluster-left">
        <button id="btnHome" class="icon-btn" title="Hem">
          <img class="icon-img" src="icons/home.png" alt="Hem"/>
        </button>
        <button id="btnMap" class="icon-btn" title="Karta">
          <img class="icon-img" src="icons/map.png" alt="Karta"/>
        </button>
      </div>

      <div class="cluster-center">
        <button id="btnPrev" class="arrow gray" title="Föregående dag"><span>◀</span></button>
        <div class="date-block" id="dateBlock">
          <span>Idag</span><span>Tors</span><span>30 okt</span>
        </div>
        <button id="btnNext" class="arrow gray" title="Nästa dag"><span>▶</span></button>
      </div>

      <div class="cluster-right">
        <div class="sort-stack">
          <div class="sort-top">Sortering</div>
          <div class="sort-bottom">
            <span id="pillPlace" class="pill on">Plats</span>
            <span id="pillSeries" class="pill off">Serie</span>
            <span id="pillTime" class="pill on lock">Tid</span>
          </div>
        </div>
        <button id="btnSettings" class="icon-btn" title="Inställningar">⚙️</button>
      </div>
    </div>
  </header>

  <!-- HINT -->
  <div class="hint" id="hintText">Visar matcher nära: Kruniusvägen 1, Billdal</div>

  <!-- ARENA SLOT (endast i Plats-vy) -->
  <div id="groupSlot" class="group-slot" style="display:flex;">
    <div class="group-title">Kungsbacka Ishall A</div>
    <div class="group-sub">Avst 8 km</div>
  </div>

  <!-- SCROLL AREA -->
  <main id="scrollArea" class="scroll"></main>
</div>

<script>
/* =========================================================
   Hjälpfunktioner: datum, strängar, trunc + autoshrink
========================================================= */
const svDays = ["Sön","Mån","Tis","Ons","Tors","Fre","Lör"];
const svMonths = ["jan","feb","mar","apr","maj","jun","jul","aug","sep","okt","nov","dec"];
function pad2(n){return (n<10?'0':'')+n;}
function fmtDateHuman(d, baseToday){
  // Idag/Imorgon/Igår + veckodag + datum
  const dow = svDays[d.getDay()];
  const textDate = `${d.getDate()} ${svMonths[d.getMonth()]}`;
  let rel = '';
  const today = new Date(baseToday.getFullYear(), baseToday.getMonth(), baseToday.getDate());
  const cmp  = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const diff = Math.round((cmp - today)/86400000);
  if(diff===0) rel='Idag';
  else if(diff===1) rel='Imorgon';
  else if(diff===-1) rel='Igår';
  return {rel, dow, textDate};
}
function parseCSV(text){
  const rows = text.trim().split(/\r?\n/);
  return rows.map(r=>{
    // split on semicolon; do not attempt to handle quoted fields (source is simple)
    return r.split(';').map(s=>s.trim());
  });
}
function kmDist(lat1,lon1,lat2,lon2){
  const toRad=(x)=>x*Math.PI/180;
  const R=6371;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return Math.round(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}
function ellipsis(str, max){
  if(!str) return '';
  if(str.length<=max) return str;
  return str.slice(0, Math.max(0,max-1)) + '…';
}

/* Fit-helpers: minska font-size tills det får plats (en rad), annars ellipsis */
function fitsOneLine(el){
  return el.scrollWidth <= el.clientWidth && el.scrollHeight <= el.clientHeight;
}
function autoFitOneLine(el, minPx=10, step=0.5){
  // krymper font-size i små steg tills det får plats (eller når minPx)
  const orig = parseFloat(getComputedStyle(el).fontSize);
  let size = orig;
  while(!fitsOneLine(el) && size>minPx){
    size -= step;
    el.style.fontSize = size + 'px';
  }
  return size;
}

/* Responsiva maxlängder beroende på viewport */
function getMaxLens(){
  const w = window.innerWidth;
  if(w<768)   return { serie:50, arena:25, team:30 };
  if(w<1200)  return { serie:70, arena:35, team:40 };
  return { serie:120, arena:80, team:80 }; // desktop: tillåter mkt innan trunc; fortfarande 1 rad
}

/* =========================================================
   Data & state
========================================================= */
const USER_LOC = {lat:57.590214281624824, lon:11.94608216084837};
const MODE = { PLACE:"place", SERIES:"series", SERIES_TIME:"series_time" };
let mode = MODE.PLACE;

const els = {
  scroll: document.getElementById('scrollArea'),
  slot: document.getElementById('groupSlot'),
  hint: document.getElementById('hintText'),
  pillPlace: document.getElementById('pillPlace'),
  pillSeries: document.getElementById('pillSeries'),
  pillTime: document.getElementById('pillTime'),
  btnPrev: document.getElementById('btnPrev'),
  btnNext: document.getElementById('btnNext'),
  dateBlock: document.getElementById('dateBlock')
};

let games = [];  // alla matcher från CSV
let clubsMap = new Map(); // namn -> logofil
let dayIndex = 0; // 0 = “idag”
let uniqueDays = []; // sorterade datumsträngar YYYY-MM-DD som finns i CSV
let currentDateStr = ''; // aktuell dag (YYYY-MM-DD)
let currentArena = null;
let arenaOrder = [];
let lastScrollTop = 0;

/* =========================================================
   Ladda data (CSV & logo-map)
========================================================= */
async function loadData(){
  const [csv, mapTxt] = await Promise.all([
    fetch('data/games.csv').then(r=>r.text()),
    fetch('data/Clubs_Organisatons_logos__ClubOrgName_LogoFileName.txt').then(r=>r.text())
  ]);

  // parse map
  mapTxt.trim().split(/\r?\n/).forEach(line=>{
    const idx = line.indexOf(';');
    if(idx>0){
      const name = line.slice(0,idx).trim();
      const file = line.slice(idx+1).trim();
      if(name && file) clubsMap.set(name, file);
    }
  });

  // parse games
  // format:
  // date; time; series_name; link_to_series; admin_host; home_team; away_team; result; result_link; arena;status;iteration_fetched;iterations_total;home_club_list;away_club_list;arena_nbr;PreferedName;Lat;Long
  games = parseCSV(csv).map(cols=>{
    const [
      date,time,series,series_link,admin_host,home_team,away_team,result,result_link,arena,status,iteration_fetched,iterations_total,
      home_list,away_list,arena_nbr,PreferedName,Lat,Long
    ] = cols;

    // club lists
    const homeClubs = (home_list||'').split(',').map(s=>s.trim()).filter(Boolean);
    const awayClubs = (away_list||'').split(',').map(s=>s.trim()).filter(Boolean);

    return {
      date, time, series, series_link, admin_host, home_team, away_team, result,
      result_link, arena, status, iteration_fetched, iterations_total, homeClubs, awayClubs,
      arena_nbr, PreferedName, lat: +Lat || null, lon: +Long || null
    };
  });

  // unika datum som finns
  uniqueDays = [...new Set(games.map(g=>g.date))].sort();
}

/* =========================================================
   Datumkontroller + byten
========================================================= */
function setDateToIndex(idx){
  if(uniqueDays.length===0){
    const d = new Date(); currentDateStr = d.toISOString().slice(0,10);
    updateDateBlock(new Date());
    els.btnPrev.className = 'arrow gray';
    els.btnNext.className = 'arrow gray';
    return;
  }
  dayIndex = Math.max(0, Math.min(uniqueDays.length-1, idx));
  currentDateStr = uniqueDays[dayIndex];
  const [y,m,da] = currentDateStr.split('-').map(Number);
  const dObj = new Date(y, m-1, da);

  updateDateBlock(dObj);

  // pilar grön/grå utifrån om det finns datum före/efter
  els.btnPrev.className = 'arrow ' + (dayIndex>0 ? 'green':'gray');
  els.btnNext.className = 'arrow ' + (dayIndex<uniqueDays.length-1 ? 'green':'gray');

  render();
}
function updateDateBlock(dObj){
  const now = new Date();
  const {rel,dow,textDate} = fmtDateHuman(dObj, now);
  els.dateBlock.innerHTML = `<span>${rel||''}</span><span>${dow}</span><span>${textDate}</span>`;
}

/* =========================================================
   Logo-hämtning (första klubbnamn, exakt match + trim)
========================================================= */
function logoForClubList(clubs){
  if(!clubs || clubs.length===0) return null;
  const first = clubs[0].trim();
  const file = clubsMap.get(first);
  return file ? ('logos/'+file) : null;
}

/* =========================================================
   Rendering helpers (resultat, textfit, trunc)
========================================================= */
function buildResultEl(result, link){
  const box = document.createElement('div');
  box.className = 'result';

  // Länk finns?
  if(link && link !== ''){
    const a = document.createElement('a');
    a.href = link;
    a.textContent = (result && result.trim()) ? result.trim() : '–';
    a.target = '_blank';
    a.rel = 'noopener';
    box.appendChild(a);
  }else{
    const span = document.createElement('span');
    span.className = 'plain';
    span.textContent = (result && result.trim()) ? result.trim() : '–';
    box.appendChild(span);
  }

  // Autoshrink text om stor (ex 10–11)
  requestAnimationFrame(()=>{
    const child = box.firstElementChild;
    // minska font-size tills en rad i boxen
    autoFitOneLine(child, 10, 0.5);
  });

  return box;
}
function makeTeamEl(side, name, clubs, wantLogo=true){
  const wr = document.createElement('div');
  wr.className = 'team '+side;

  // namn
  const nm = document.createElement('span');
  nm.className = 'team-name';
  nm.textContent = name || '';

  // logo
  let img = null;
  if(wantLogo){
    const logoSrc = logoForClubList(clubs);
    img = document.createElement('img');
    img.className = 'team-logo';
    if(logoSrc){ img.src = logoSrc; img.alt = name || 'logo'; }
    else{
      // fallback – grå cirkel med initialer
      img.style.background = '#e5e7eb';
      img.style.display = 'inline-grid';
      img.style.placeItems = 'center';
      img.style.color = '#334155';
      img.style.fontSize = '11px';
      img.style.fontWeight = '700';
      img.style.border = '1px solid #cbd5e1';
      img.alt = 'logo';
      // rendera som <div>-liknande: vi kan lägga en transparent data-uri för att få <img> att visa text via title
      img.src = 'data:image/gif;base64,R0lGODlhAQABAAAAACw=';
      img.title = abbrev(name);
      const overlay = document.createElement('span');
      overlay.textContent = abbrev(name);
      overlay.style.position = 'absolute';
      // (förenklad: vi låter title räcka här – bild överlagring i <img> är krånglig utan wrapper)
    }
  }

  // placera nära resultat-box
  // home: [name][logo]  (högerjusterad mot resultat)
  // away: [logo][name]
  const maxLens = getMaxLens();
  const maxTeam = maxLens.team;

  if(side==='home'){
    // text nära resultat (höger mot logo)
    nm.style.textAlign = 'right';
    nm.textContent = ellipsis(name||'', maxTeam);
    wr.appendChild(nm);
    if(img) wr.appendChild(img);
  }else{
    // logo nära resultat
    if(img) wr.appendChild(img);
    nm.textContent = ellipsis(name||'', maxTeam);
    wr.appendChild(nm);
  }

  // autoshrink name till en rad
  requestAnimationFrame(()=>{
    autoFitOneLine(nm, 10, 0.5);
  });

  return wr;
}
function abbrev(name){
  if(!name) return '?';
  // FHC-stil: ta initialer i versaler
  return name.split(/[\s\-\/]+/).filter(Boolean).map(w=>w[0]).slice(0,3).join('').toUpperCase();
}

/* Serie-namn fit + trunc (Plats-vy & Serie-vy vänster) */
function renderSeriesName(parent, series, link){
  const a = document.createElement('a');
  a.href = link || '#';
  a.textContent = series || '';
  parent.appendChild(a);

  const max = getMaxLens().serie;
  a.textContent = ellipsis(a.textContent, max);
  requestAnimationFrame(()=>autoFitOneLine(a, 10, 0.5));
}

/* Arena-namn fit + trunc (Serie-vy höger) */
function renderArenaRight(parent, arenaName){
  const arena = document.createElement('div');
  arena.className = 'ser-arena';
  arena.textContent = ellipsis(arenaName||'', getMaxLens().arena);
  parent.appendChild(arena);
  requestAnimationFrame(()=>autoFitOneLine(arena, 10, 0.5));
  return arena;
}

/* =========================================================
   Sortering
========================================================= */
function parseMinutes(t){ const [H,M]=t.split(':'); return (+H)*60 + (+M); }

function sortPlaceThenSeries(glist){
  // grupperas per arena (närmast först), inom arena sortera på serie + tid (enkel logik)
  const byArena = new Map();
  glist.forEach(g=>{
    const key = g.PreferedName || g.arena || 'Okänd arena';
    if(!byArena.has(key)) byArena.set(key, []);
    byArena.get(key).push(g);
  });
  const arr = [...byArena.entries()].map(([k, arr])=>{
    const dist = (glist.find(x=>(x.PreferedName||x.arena)===k) && glist.find(x=>(x.PreferedName||x.arena)===k).__dist) || 9999;
    return {arena:k, dist, items:arr};
  });
  arr.sort((a,b)=>a.dist - b.dist);

  arr.forEach(A=>{
    // inom arena: serie (alfa) + tid
    A.items.sort((x,y)=>{
      if(x.series===y.series){
        return parseMinutes(x.time) - parseMinutes(y.time);
      }
      return x.series.localeCompare(y.series);
    });
  });

  return arr;
}
function sortSeriesThenTime(glist){
  // först series namn-prio (enkel: alfa), därefter tid
  // grupper: per series
  const bySer = new Map();
  glist.forEach(g=>{
    const key = g.series || 'Okänd serie';
    if(!bySer.has(key)) bySer.set(key, []);
    bySer.get(key).push(g);
  });
  const arr = [...bySer.entries()].map(([serie, items])=>({serie, items}));
  arr.sort((a,b)=>a.serie.localeCompare(b.serie));
  arr.forEach(S=>{
    S.items.sort((x,y)=>parseMinutes(x.time) - parseMinutes(y.time));
  });
  return arr;
}
function sortTimeThenSeries(glist){
  // tid först, brytband med serie
  const copy = glist.slice().sort((x,y)=>{
    const d = parseMinutes(x.time)-parseMinutes(y.time);
    if(d!==0) return d;
    return (x.series||'').localeCompare(y.series||'');
  });
  // grupperas efter serie för presentation
  const bySer = new Map();
  copy.forEach(g=>{
    const key = g.series || 'Okänd serie';
    if(!bySer.has(key)) bySer.set(key, []);
    bySer.get(key).push(g);
  });
  const arr = [...bySer.entries()].map(([serie, items])=>({serie, items}));
  return arr;
}

/* =========================================================
   Render views
========================================================= */
function applyPills(){
  els.pillPlace.className = (mode===MODE.PLACE) ? 'pill on' : 'pill off';
  els.pillSeries.className = (mode===MODE.SERIES||mode===MODE.SERIES_TIME) ? 'pill on' : 'pill off';
  els.pillTime.className = (mode===MODE.PLACE) ? 'pill on lock' : (mode===MODE.SERIES_TIME ? 'pill on' : 'pill off');

  // visa/dölj sticky slot
  els.slot.style.display = (mode===MODE.PLACE) ? 'flex' : 'none';
}

function render(){
  applyPills();
  const dayGames = games.filter(g=>g.date===currentDateStr);

  // för pilar: finns matcher före/efter
  els.btnPrev.className = 'arrow ' + (dayIndex>0 ? 'green':'gray');
  els.btnNext.className = 'arrow ' + (dayIndex<uniqueDays.length-1 ? 'green':'gray');

  // rensa scroll
  els.scroll.innerHTML = '';

  if(mode===MODE.PLACE){
    renderPlace(dayGames);
  }else{
    renderSeries(dayGames);
  }
}

/* ------- PLATS-VY ------- */
function renderPlace(dayGames){
  // beräkna avstånd
  dayGames.forEach(g=>{
    if(g.lat!=null && g.lon!=null){
      g.__dist = kmDist(USER_LOC.lat, USER_LOC.lon, g.lat, g.lon);
    }else g.__dist = 9999;
  });

  const groups = sortPlaceThenSeries(dayGames);

  arenaOrder = groups.map(g=>g.arena);
  currentArena = arenaOrder[0] || null;
  if(currentArena){
    document.querySelector('.group-title').textContent = currentArena;
    const d = groups.find(x=>x.arena===currentArena)?.dist ?? '';
    document.querySelector('.group-sub').textContent = (d!=='' ? `Avst ${d} km` : '');
  }

  groups.forEach((A, gi)=>{
    // header i listan
    const hdr = document.createElement('div');
    hdr.className = 'arena-header';
    hdr.dataset.arenaHeader = A.arena;
    hdr.innerHTML = `<div>${A.arena}</div><div>${(A.dist!==9999)?`Avst ${A.dist} km`:''}</div>`;
    els.scroll.appendChild(hdr);

    A.items.forEach(g=>{
      const card = document.createElement('article');
      card.className = 'game';
      card.dataset.arena = A.arena;

      // top: time + series (fit + trunc 50/70/desktop)
      const top = document.createElement('div');
      top.className = 'game-top';
      const tm = document.createElement('div');
      tm.className = 'game-time';
      tm.textContent = g.time || '';
      top.appendChild(tm);
      const ser = document.createElement('div');
      ser.className = 'game-series';
      renderSeriesName(ser, g.series, g.series_link);
      top.appendChild(ser);
      card.appendChild(top);

      // bottom: home  | result | away
      const bottom = document.createElement('div');
      bottom.className = 'game-bottom';

      const home = makeTeamEl('home', g.home_team, g.homeClubs, true);
      const res  = buildResultEl(g.result, g.result_link);
      const away = makeTeamEl('away', g.away_team, g.awayClubs, true);

      bottom.appendChild(home);
      bottom.appendChild(res);
      bottom.appendChild(away);
      card.appendChild(bottom);

      els.scroll.appendChild(card);
    });

    if(gi !== groups.length-1){
      const div = document.createElement('div'); div.className='divider';
      els.scroll.appendChild(div);
    }
  });

  // Sticky logik för arena-slot
  setupStickyHandlers();
}

/* ------- SERIE-VY ------- */
function renderSeries(dayGames){
  // stabil viewport – ingen arenaheader i listan
  const list = (mode===MODE.SERIES_TIME) ? sortTimeThenSeries(dayGames) : sortSeriesThenTime(dayGames);

  list.forEach((S, si)=>{
    // gruppseparator (grå remsa)
    const divTop = document.createElement('div');
    divTop.className = 'divider';
    if(si===0) divTop.style.marginTop = '0px';
    els.scroll.appendChild(divTop);

    // (ingen “serie-header-rad” – enligt dina riktlinjer)
    S.items.forEach(g=>{
      const card = document.createElement('article');
      card.className = 'game';

      // top: vänster (tid+serie), höger (arena+distans)
      const top = document.createElement('div');
      top.className = 'ser-top';

      const left = document.createElement('div');
      left.className = 'ser-left';
      const tm = document.createElement('span');
      tm.className = 'game-time';
      tm.textContent = g.time+' ';
      left.appendChild(tm);
      const ser = document.createElement('span');
      ser.className = 'game-series';
      const serA = document.createElement('a');
      serA.href = g.series_link || '#';
      serA.textContent = g.series || '';
      ser.appendChild(serA);
      left.appendChild(ser);
      top.appendChild(left);

      const right = document.createElement('div');
      right.className = 'ser-right';
      // distans (om känt)
      let dist = '';
      if(g.lat!=null && g.lon!=null){
        dist = `${kmDist(USER_LOC.lat, USER_LOC.lon, g.lat, g.lon)} km`;
      }
      const arenaEl = renderArenaRight(right, g.PreferedName || g.arena || '');
      const distEl = document.createElement('div');
      distEl.className = 'ser-dist';
      distEl.textContent = dist ? `Avst ${dist}` : '';
      right.appendChild(distEl);
      top.appendChild(right);
      card.appendChild(top);

      // bottom: hemmalag | resultat | bortalag (samma “nära resultat”-gap)
      const bottom = document.createElement('div');
      bottom.className = 'game-bottom';
      const home = makeTeamEl('home', g.home_team, g.homeClubs, true);
      const res  = buildResultEl(g.result, g.result_link);
      const away = makeTeamEl('away', g.away_team, g.awayClubs, true);
      bottom.appendChild(home);
      bottom.appendChild(res);
      bottom.appendChild(away);
      card.appendChild(bottom);

      els.scroll.appendChild(card);

      // Anpassa vänster/höger i top så allt hålls inom halvorna
      requestAnimationFrame(()=>{
        // serie (vänster) – trunc & fit
        const maxL = getMaxLens().serie;
        serA.textContent = ellipsis(serA.textContent, maxL);
        autoFitOneLine(serA, 10, 0.5);

        // arena (höger) – får ej passera mitten, trunc redan i renderArenaRight
        autoFitOneLine(arenaEl, 10, 0.5);
      });
    });
  });

  // Serie-vy: ingen sticky arena-slot
  els.slot.style.display = 'none';
}

/* =========================================================
   Sticky i Plats-vy (stabil övergång upp/ner)
========================================================= */
function setupStickyHandlers(){
  lastScrollTop = 0;
  const slot = els.slot;
  const stickyBottom = ()=>slot.getBoundingClientRect().bottom;

  function updateSticky(){
    if(mode!==MODE.PLACE) return;
    const st = els.scroll.scrollTop;
    const dir = (st>lastScrollTop)?'down':'up';
    lastScrollTop = st;

    const idx = arenaOrder.indexOf(currentArena);
    if(idx<0) return;

    // DOWN: byt när nästa header är 50% täckt av slot
    if(dir==='down' && idx < arenaOrder.length-1){
      const nextArena = arenaOrder[idx+1];
      const hdr = els.scroll.querySelector(`.arena-header[data-arena-header="${nextArena}"]`);
      if(hdr){
        const r = hdr.getBoundingClientRect();
        const sb = stickyBottom();
        if(r.top < sb && (sb - r.top) >= (r.height * 0.5)){
          currentArena = nextArena;
          document.querySelector('.group-title').textContent = nextArena;
          const distTxt = hdr.lastElementChild?.textContent || '';
          document.querySelector('.group-sub').textContent = distTxt;
        }
      }
    }

    // UP: byt först när nuvarande header är HELT synlig i skroll-fönstret + lite buffert (iOS)
    if(dir==='up' && idx > 0){
      const currArena = arenaOrder[idx];
      const prevArena = arenaOrder[idx-1];
      const currHdr = els.scroll.querySelector(`.arena-header[data-arena-header="${currArena}"]`);
      if(currHdr){
        const r = currHdr.getBoundingClientRect();
        const sb = stickyBottom();
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const extra = isIOS ? 26 : 0;

        if(r.top >= sb + extra){
          currentArena = prevArena;
          document.querySelector('.group-title').textContent = prevArena;
          const prevHdr = els.scroll.querySelector(`.arena-header[data-arena-header="${prevArena}"]`);
          const distTxt = prevHdr?.lastElementChild?.textContent || '';
          document.querySelector('.group-sub').textContent = distTxt;
        }
      }
    }

    // dölj enbart aktiva headern i listan
    arenaOrder.forEach(a=>{
      const hdr = els.scroll.querySelector(`.arena-header[data-arena-header="${a}"]`);
      if(hdr) hdr.classList.toggle('active-hidden', a===currentArena);
    });
  }

  els.scroll.removeEventListener('scroll', updateSticky);
  els.scroll.addEventListener('scroll', updateSticky);
  // init
  requestAnimationFrame(updateSticky);
}

/* =========================================================
   UI handlers: knappar, pills
========================================================= */
els.pillPlace.onclick = ()=>{ mode = MODE.PLACE; applyPills(); render(); };
els.pillSeries.onclick= ()=>{ mode = MODE.SERIES; applyPills(); render(); };
els.pillTime.onclick  = ()=>{
  if(mode===MODE.PLACE) return; // låst i plats-vy
  mode = (mode===MODE.SERIES) ? MODE.SERIES_TIME : MODE.SERIES;
  applyPills(); render();
};
els.btnPrev.onclick = ()=>{ if(dayIndex>0){ setDateToIndex(dayIndex-1);} };
els.btnNext.onclick = ()=>{ if(dayIndex<uniqueDays.length-1){ setDateToIndex(dayIndex+1);} };

/* =========================================================
   Init
========================================================= */
(async function init(){
  await loadData();

  // sätt dag: om dagens datum finns – välj den, annars första
  const todayStr = (new Date()).toISOString().slice(0,10);
  const idx = uniqueDays.indexOf(todayStr);
  setDateToIndex(idx>=0 ? idx : 0);
})();
</script>
</body>
</html>

