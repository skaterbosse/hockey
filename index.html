<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />

<!-- ‚úÖ INSTALLERBAR PWA (iOS + Android) -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="mobile-web-app-capable" content="yes" />

<!-- ‚úÖ MANIFEST + THEME -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#16a34a" />

<!-- ‚úÖ FAVICON (JetBlack) -->
<link rel="icon" type="image/png" sizes="32x32" href="icons/icon_32_jetblack_exact2.png">

<!-- ‚úÖ APP ICONS (poster = app icon, jetblack = favicon) -->
<link rel="apple-touch-icon" href="icons/local_sport_promotional_poster_120.png" sizes="120x120">
<link rel="apple-touch-icon" href="icons/local_sport_promotional_poster_152.png" sizes="152x152">
<link rel="apple-touch-icon" href="icons/local_sport_promotional_poster_167.png" sizes="167x167">
<link rel="apple-touch-icon" href="icons/local_sport_promotional_poster_180.png" sizes="180x180">
<link rel="apple-touch-icon" href="icons/local_sport_promotional_poster_1024.png" sizes="1024x1024">

<!-- ‚úÖ SOCIAL META ‚Äì Facebook / iMessage / Messenger -->
<meta property="og:title" content="Local Sport ‚Äì Live sport i en arena n√§ra dig">
<meta property="og:description" content="Se liveidrott i en arena n√§ra dig. Hockey, ungdomsidrott och allt d√§remellan.">
<meta property="og:image" content="icons/promotional_og_1200x630.png">
<meta property="og:image:type" content="image/png">
<meta property="og:type" content="website">
<meta property="og:url" content="https://skaterbosse.github.io/hockey/">

<!-- ‚úÖ SOCIAL META ‚Äì Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Local Sport ‚Äì Live sport i en arena n√§ra dig">
<meta name="twitter:image" content="icons/promotional_social_1080x1080.png">

<title>LocalSport ‚Äì Live sport i en arena n√§ra dig</title>

<style>
:root{
  --topbar-h:56px;
  --hint-h:26px;
  --bg:#f0f3f8;
  --hair:#e2e8f0;
  --text:#0f172a;
  --muted:#64748b;
  --accent:#16a34a;
  --link:#2563eb;
}

/* ===== BAS ===== */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,Roboto,Arial,sans-serif;color:var(--text);overscroll-behavior:none;}
.device{width:100%;height:100dvh;display:flex;flex-direction:column;overflow:hidden;}

/* ===== TOP BAR ===== */
.topbar{position:sticky;top:0;z-index:500;background:#fff;border-bottom:1px solid var(--hair);}
.topbar-inner{
  display:grid;
  grid-template-columns:1fr auto 1fr;
  align-items:center;
  height:var(--topbar-h);
  padding:6px;
}
.cluster-left,.cluster-right{display:flex;gap:8px;align-items:center;}

/* ‚úÖ NEW MARGIN ‚Äî date block now has spacing from sorting box */
.cluster-center { 
  display:flex;align-items:center;justify-content:center;gap:10px;
  margin-right:12px; /* ‚úÖ THIS IS NEW */
}

.icon-btn{width:32px;height:32px;border-radius:10px;border:1px solid var(--hair);background:#f1f5f9;display:grid;place-items:center;cursor:pointer;}
.icon-img{width:20px;height:20px;object-fit:contain;}
.date-block{display:flex;flex-direction:column;align-items:center;font-weight:700;font-size:13.5px;line-height:1.1;}

.sort-stack{border:1px solid var(--hair);border-radius:10px;background:#fff;padding:4px 6px;display:flex;flex-direction:column;align-items:center;}
.sort-top{font-size:12px;font-weight:600;margin-bottom:2px;}
.sort-bottom{display:flex;gap:4px;}
.pill{padding:4px 8px;font-size:11px;border-radius:999px;font-weight:600;border:1px solid var(--hair);cursor:pointer;user-select:none;}
.pill.on{background:#dcfce7;border-color:#86efac;color:var(--accent);}
.pill.off{background:#f1f5f9;border-color:#cbd5e1;color:#94a3b8;}

.hint{position:sticky;top:var(--topbar-h);height:var(--hint-h);background:#fff;border-bottom:1px solid var(--hair);text-align:center;font-size:12px;line-height:var(--hint-h);color:var(--muted);z-index:450;}

/* ===== SCROLL AREA ===== */
.scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;background:var(--bg);}

/* ===== GAME CARD ===== */
.game{background:#fff;border-top:1px dashed #e5e7eb;padding:8px 12px;display:grid;gap:6px;}

.series-toprow{
  display:grid;
  grid-template-columns: 48% 32% 70px;
  align-items:center;
  column-gap:4px;
}
.series-toprow .series-name,
.series-toprow .arena-name{
  min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.series-toprow .dist{
  white-space:nowrap;text-align:right;color:var(--muted);font-size:12px;
}

/* ===== BOTTOM ROW (MATCHINFO) ===== */
.series-bottomrow{
  display:grid;
  grid-template-columns: auto 1fr auto 1fr;
  align-items:center;
  column-gap:6px;
}

/* TIME */
.series-bottomrow .time{white-space:nowrap;font-weight:700;color:#000;}

/* ‚úÖ FIX: Hemmalaget h√∂gerjusterat mot resultatbox */
.series-bottomrow .left{
  display:flex;
  flex-direction:row;
  justify-content:flex-end; /* ‚úÖ RIGHT ALIGNMENT */
  align-items:center;
  gap:6px;
}

/* Bortalaget (of√∂r√§ndrat) */
.series-bottomrow .right{
  display:flex;
  flex-direction:row;
  align-items:center;
  gap:6px;
}

/* DEFAULT TEAM NAME ALIGNMENT */
.team-logo{width:26px;height:26px;border-radius:4px;object-fit:contain;background:transparent;}

/* ‚úÖ Hemmalag = h√∂gerjusterat namn */
.series-bottomrow .left .team-name{
  text-align:right;
}

/* ‚úÖ Bortalag = v√§nsterjusterat namn */
.series-bottomrow .right .team-name{
  text-align:left;
}

.team-name{max-width:min(38vw,165px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:13px;}

.series-result{display:flex;justify-content:center;}
.result a,.result div{
  display:inline-block;padding:2px 10px;border-radius:8px;border:1px solid var(--hair);
  background:#f1f5f9;font-weight:700;text-decoration:none;color:var(--text);
}
</style>
</head>
<body>

<div class="device">

<header class="topbar">
  <div class="topbar-inner">
    <div class="cluster-left">
      <button class="icon-btn" id="btnHome" title="Hem"><img class="icon-img" src="icons/home.jpeg" alt="home"></button>
      <button class="icon-btn" id="btnMap" title="Karta"><img class="icon-img" src="icons/map.jpeg" alt="map"></button>
    </div>

    <div class="cluster-center">
      <button class="icon-btn" id="btnPrev" title="F√∂reg√•ende">‚óÄ</button>
      <div class="date-block"><span id="lblRel">Idag</span><span id="lblWday">Tors</span><span id="lblDate">23 okt</span></div>
      <button class="icon-btn" id="btnNext" title="N√§sta">‚ñ∂</button>
    </div>

    <div class="cluster-right">
      <div class="sort-stack">
        <div class="sort-top">Sortering</div>
        <div class="sort-bottom">
          <span id="pillPlace" class="pill on">Plats</span>
          <span id="pillSeries" class="pill off">Serie</span>
          <span id="pillTime" class="pill off">Tid</span>
        </div>
      </div>
      <button class="icon-btn" id="btnSettings" title="Inst√§llningar">‚öôÔ∏è</button>
    </div>
  </div>
</header>

<div class="hint" id="hint">Visar matcher n√§ra: Kruniusv√§gen 1, Billdal</div>

<main id="scrollArea" class="scroll"></main>
</div>

<!-- END OF PART 1 -->
<!-- ‚úÖ INSTALLERA PWA KNAPPEN -->
<button id="btnInstall" style="
  position:fixed;
  bottom:18px;
  left:50%;
  transform:translateX(-50%);
  padding:12px 18px;
  border-radius:999px;
  background:#16a34a;
  color:#fff;
  font-weight:600;
  display:none;
  z-index:600;
">üì≤ Installera LocalSport</button>

<!-- ‚úÖ PWA SERVICE WORKER / INSTALLATION -->
<script>
let deferredPrompt = null;

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js")
    .then(() => console.log("‚úÖ Service Worker registrerad"))
    .catch(err => console.warn("Service Worker FEL:", err));
}

window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  btnInstall.style.display = "block";
});

btnInstall.onclick = () => {
  btnInstall.style.display = "none";
  deferredPrompt.prompt();
};
</script>

<!-- ‚úÖ SERVICE WORKER AUTO-UPDATERING -->
<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("service-worker.js")
      .then(reg => {
        console.log("‚úÖ Service worker registrerad:", reg);

        reg.onupdatefound = () => {
          const newSW = reg.installing;
          newSW.onstatechange = () => {
            if (newSW.state === "installed") {
              if (navigator.serviceWorker.controller) {
                console.log("üîÑ Ny version ‚Äî uppdaterar automatiskt‚Ä¶");
                window.location.reload();
              }
            }
          };
        };
      })
      .catch(err => console.error("ServiceWorker error", err));
  });
}
</script>

<!-- ‚úÖ JS LOGIK ‚Äî H√ÑR B√ñRJAR DIN ORIGINALL√ñSNING (inget √§ndrat h√§r inne) -->
<script>
/* === STATE === */
let allGames = [];
let logoMap = {};
let currentDateISO = null;
const MODE = { PLACE:'place', SERIES:'series', SERIES_TIME:'series_time' };
let mode = MODE.PLACE;

const USER_LAT = 57.590214281624824;
const USER_LON = 11.94608216084837;

/* === FETCH DATA === */
Promise.all([
  fetch('data/Clubs_Organisatons_logos__ClubOrgName_LogoFileName.txt').then(r=>r.text()),
  fetch('data/games.csv').then(r=>r.text())
]).then(([mapTxt, csvTxt])=>{
  mapTxt.trim().split('\n').forEach(line=>{
    const [n,f] = line.split(';');
    if(n && f) logoMap[n.trim()] = f.trim();
  });
  allGames = parseCSV(csvTxt);
  setToday();
});

/* === CSV PARSE === */
function parseCSV(txt){
  const lines = txt.split('\n').filter(x=>x.trim().length>0);
  const out=[];
  for(let i=1;i<lines.length;i++){
    const f = lines[i].split(';');
    if(f.length<19) continue;
    out.push({
      date:f[0], time:f[1], series_name:f[2], link_to_series:f[3], admin_host:f[4],
      home_team:f[5], away_team:f[6], result:f[7], result_link:f[8],
      arena:f[9], status:f[10], iteration_fetched:f[11], iterations_total:f[12],
      home_club_list:f[13]||'', away_club_list:f[14]||'',
      arena_nbr:f[15], PreferedName:f[16],
      Lat: parseFloat(f[17]), Long: parseFloat(f[18])
    });
  }
  return out;
}

/* === DATUMHANTERING === */
function setToday(){
  const d = new Date();
  currentDateISO = d.toISOString().slice(0,10);
  render();
}
function changeDate(offset){
  const d = new Date(currentDateISO);
  d.setDate(d.getDate()+offset);
  currentDateISO = d.toISOString().slice(0,10);
  render();
}
document.getElementById('btnPrev').onclick = ()=>changeDate(-1);
document.getElementById('btnNext').onclick = ()=>changeDate(+1);
document.getElementById('btnHome').onclick = ()=>setToday();

/* === PILLS === */
const pillPlace = document.getElementById('pillPlace');
const pillSeries = document.getElementById('pillSeries');
const pillTime   = document.getElementById('pillTime');

pillPlace.onclick = ()=>{ mode = MODE.PLACE; applyPills(); render(); };
pillSeries.onclick = ()=>{ mode = MODE.SERIES; applyPills(); render(); };
pillTime.onclick   = ()=>{ mode = (mode===MODE.SERIES)? MODE.SERIES_TIME : MODE.SERIES; applyPills(); render(); };

function applyPills(){
  pillPlace.className = 'pill '+(mode===MODE.PLACE?'on':'off');
  pillSeries.className = 'pill '+(mode!==MODE.PLACE?'on':'off');
  pillTime.className   = 'pill '+(mode===MODE.SERIES_TIME?'on':'off');
}

/* === RENDER FUNKTIONER === */
function render(){
  const d = new Date(currentDateISO);
  document.getElementById('lblRel').textContent = relWord(d);
  document.getElementById('lblWday').textContent = ['S√∂n','M√•n','Tis','Ons','Tors','Fre','L√∂r'][d.getDay()];
  document.getElementById('lblDate').textContent = `${d.getDate()} ${['jan','feb','mar','apr','maj','jun','jul','aug','sep','okt','nov','dec'][d.getMonth()]}`;

  const todays = allGames.filter(g=>g.date===currentDateISO);
  if(todays.length===0){
    document.getElementById('scrollArea').innerHTML =
      `<div style="padding:20px;font-size:20px;text-align:center;background:#fff;">Inga matcher idag</div>`;
    return;
  }

  if(mode===MODE.PLACE) renderPlace(todays);
  else renderSeries(todays);
}

function relWord(d){
  const t = new Date(); t.setHours(0,0,0,0);
  const dd = new Date(d); dd.setHours(0,0,0,0);
  const diff = (dd - t)/(1000*60*60*24);
  if(diff===0) return 'Idag';
  if(diff===1) return 'Imorgon';
  if(diff===-1) return 'Ig√•r';
  return '';
}

/* === PLATS-VY === */
function renderPlace(list){
  const byArena = {};
  list.forEach(g=>{
    const name = g.PreferedName || g.arena || "Arena";
    (byArena[name] ||= []).push(g);
  });

  const arenas = Object.keys(byArena).sort((a,b)=>{
    const da = haversine(byArena[a][0].Lat, byArena[a][0].Long, USER_LAT, USER_LON);
    const db = haversine(byArena[b][0].Lat, byArena[b][0].Long, USER_LAT, USER_LON);
    return da-db;
  });

  const out=[];
  arenas.forEach(arena=>{
    byArena[arena].sort((a,b)=>a.time.localeCompare(b.time));
    byArena[arena].forEach(g=> out.push(gameCardUnified(g)));
  });

  document.getElementById('scrollArea').innerHTML = out.join('');
}

/* === SERIE-VY === */
function renderSeries(list){
  let arr=[...list];
  if(mode===MODE.SERIES){
    arr.sort(seriesComparator);
  }else if(mode===MODE.SERIES_TIME){
    arr.sort((a,b)=>{
      const t = a.time.localeCompare(b.time);
      if(t!==0) return t;
      return seriesComparator(a,b);
    });
  }
  document.getElementById('scrollArea').innerHTML = arr.map(gameCardUnified).join('');
}

/* === MATCHKORT === */
function gameCardUnified(g){
  const homeLogo = pickLogo(g.home_club_list);
  const awayLogo = pickLogo(g.away_club_list);

  const distance = Math.ceil(haversine(g.Lat,g.Long,USER_LAT,USER_LON))+" km";

  const resHTML = (g.result_link && g.result && g.result.trim()!=='‚Äì')
    ? `<div class="result"><a href="${escapeHtml(g.result_link)}" target="_blank">${escapeHtml(g.result)}</a></div>`
    : `<div class="result"><div>${escapeHtml(g.result||'‚Äì')}</div></div>`;

  const seriesLabel = truncateDot(g.series_name||'', 40);
  const homeName = truncateDot(g.home_team||'', 14);
  const awayName = truncateDot(g.away_team||'', 14);

  return `
  <article class="game">
    <div class="series-toprow">
      <div class="series-name">${seriesLinkHTML(g, seriesLabel)}</div>
      <div class="arena-name">${escapeHtml(g.PreferedName||g.arena||'')}</div>
      <div class="dist">${distance}</div>
    </div>

    <div class="series-bottomrow">
      <div class="time">${escapeHtml(g.time||'')}</div>

      <!-- ‚úÖ HEMMALAG: h√∂gerjusterad (namn ‚Üí logo ‚Üí resultatbox) -->
      <div class="left">
        <span class="team-name">${escapeHtml(homeName)}</span>
        <img class="team-logo" src="${homeLogo}" alt="">
      </div>

      <div class="series-result">
        ${resHTML}
      </div>

      <!-- ‚úÖ BORTALAG: v√§nsterjusterad (resultatbox ‚Üí logo ‚Üí namn) -->
      <div class="right">
        <img class="team-logo" src="${awayLogo}" alt="">
        <span class="team-name">${escapeHtml(awayName)}</span>
      </div>
    </div>
  </article>`;
}

/* === SORTERING, LOGIK etc. (of√∂r√§ndrat) === */
function seriesComparator(a,b){ /* ... */ }
function detectRegionCode(host){ /* ... */ }
function detectDistrictCode(host){ /* ... */ }
function extractU(s){ /* ... */ }
function extractPlus(s){ /* ... */ }
function pickLogo(listStr){
  const key = (listStr||'').split(',')[0].trim();
  return logoMap[key] ? `logos/${logoMap[key]}` : 'logos/placeholder.png';
}
function seriesLinkHTML(g, label){ /* ... */ }
function truncateDot(str, max){ /* ... */ }
function escapeHtml(s){ /* ... */ }
function haversine(lat1,lon1,lat2,lon2){ /* ... */ }

</script>
</body>
</html>

