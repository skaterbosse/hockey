<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Matcher nära mig</title>

<style>
/* ------------------------------
   BASIC LAYOUT
--------------------------------*/
body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: white;
    overflow: hidden;
}

header {
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 10px 0 10px;
    border-bottom: 2px solid #e0e0e0;
}

/* ------------------------------
   TOP HEADER BUTTONS
--------------------------------*/
.icon-btn {
    width: 32px;
    height: 32px;
    background-size: contain;
    background-repeat: no-repeat;
}

#homeBtn {
    background-image: url("icons/home.jpeg");
}

#mapBtn {
    background-image: url("icons/map.jpeg");
}

.sorting-box {
    border: 2px solid #ccc;
    border-radius: 10px;
    padding: 4px 10px;
    display: flex;
    flex-direction: column;
    text-align: center;
}

.sort-row {
    display: flex;
    justify-content: center;
    gap: 6px;
}

.sort-btn {
    font-size: 13px;
    padding: 3px 7px;
    border-radius: 7px;
}

.sort-active {
    background: #32cd32;
    color: white;
}

.sort-inactive {
    background: #cfcfcf;
    color: #333;
}

#dateArea {
    display: flex;
    align-items: center;
    gap: 10px;
}

.arrow {
    font-size: 24px;
    color: #32cd32;
    cursor: pointer;
}

/* ------------------------------
   ARENA HEADER (Plats-vy)
--------------------------------*/
#activeArenaHeader {
    position: sticky;
    top: 60px;
    height: 40px;
    background: white;
    font-weight: bold;
    padding: 8px 12px;
    border-bottom: 2px solid #ddd;
    z-index: 10;
}

#activeArenaHeader .arena-distance {
    float: right;
    font-size: 14px;
}

/* Scroll list container */
#listContainer {
    position: absolute;
    top: 100px;
    bottom: 0;
    left: 0;
    right: 0;
    overflow-y: auto;
}

/* Arena header inside scroll list */
.arenaHeader {
    background: #f0f0f0;
    font-size: 16px;
    font-weight: bold;
    padding: 8px 10px;
    border-bottom: 1px solid #e0e0e0;
}

/* ------------------------------
   MATCH CARD
--------------------------------*/
.match {
    padding: 4px 6px 10px 6px;
    border-bottom: 1px solid #e5e5e5;
}

.topRow {
    font-size: 13px;
    color: black;
    display: flex;
    justify-content: space-between;
}

.bottomRow {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.teamName {
    font-size: 15px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* LOGOS — AUTOSCALE, NO CIRCLE */
.teamLogo {
    height: 32px;
    width: 32px;
    object-fit: contain;
    display: block;
    flex-shrink: 0;
}

/* RESULT BOX — identical in Plats & Serie */
.resultBox {
    border: 1px solid black;
    border-radius: 8px;
    width: 48px;
    text-align: center;
    padding: 3px 2px;
    font-size: 15px;
    font-weight: bold;
}

/* ------------------------------
   SERIE-VIEW STATIC POSITION
--------------------------------*/
#seriesView {
    position: absolute;
    top: 60px;
    bottom: 0;
    left: 0;
    right: 0;
    overflow-y: auto;
    background: white;
}
</style>
</head>

<body>

<header>
    <div id="homeBtn" class="icon-btn"></div>

    <div id="dateArea">
        <div id="prevDate" class="arrow">‹</div>
        <div id="dateLabel">2025-11-03</div>
        <div id="nextDate" class="arrow">›</div>
    </div>

    <div class="sorting-box">
        <div>Sortering</div>
        <div class="sort-row">
            <button id="sortPlace"  class="sort-btn sort-active">Plats</button>
            <button id="sortSeries" class="sort-btn sort-inactive">Serie</button>
            <button id="sortTime"   class="sort-btn sort-inactive">Tid</button>
        </div>
    </div>

    <div id="settingsBtn" class="icon-btn" style="background-image:url('icons/settings.png')"></div>
</header>

<div id="activeArenaHeader"></div>
<div id="listContainer"></div>
<div id="seriesView" style="display:none;"></div>


<script>
/* ================================================================
   ✅ Local date (NO UTC BUG)
================================================================ */
function getLocalISODate() {
    const d = new Date();
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().split("T")[0];
}

let currentDate = getLocalISODate();


/* ================================================================
   READ CSV FILES
================================================================ */
let games = [];
let logos = new Map();

async function loadCSV() {
    async function csv(url) {
        const r = await fetch(url);
        return r.text();
    }

    const logoTxt = await csv("data/Clubs_Organisatons_logos__ClubOrgName_LogoFileName.txt");
    logoTxt.split("\n").forEach(line => {
        const [name, file] = line.split(";").map(v => v?.trim());
        if (name && file) logos.set(name, file);
    });

    const rows = (await csv("data/games.csv")).split("\n");
    games = rows.slice(1).map(r => {
        const p = r.split(";");
        return {
            date: p[0],
            time: p[1],
            series_name: p[2],
            link_to_series: p[3],
            admin_host: p[4],
            home_team: p[5],
            away_team: p[6],
            result: p[7],
            result_link: p[8],
            arena: p[9],
            arenaNbr: p[14],
            homeClubs: p[12]?.split(",") ?? [],
            awayClubs: p[13]?.split(",") ?? [],
            lat: parseFloat(p[16]),
            long: parseFloat(p[17])
        };
    });
}

/* ================================================================
   Haversine distance
================================================================ */
function distance(lat, lon) {
    if (!lat || !lon) return null;
    const R = 6371;
    const lat1 = 57.590214281624824;
    const lon1 = 11.94608216084837;
    const dLat = (lat - lat1) * Math.PI/180;
    const dLon = (lon - lon1) * Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat*Math.PI/180) * Math.sin(dLon/2)**2;
    return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))).toFixed(1);
}

/* ================================================================
   LOGO LOOKUP
================================================================ */
function logoFor(team) {
    if (!team) return null;
    const key = team.trim().split(",")[0];
    return logos.get(key) ? `logos/${logos.get(key)}` : null;
}

/* ================================================================
   UI RENDERING
================================================================ */
function render() {
    document.getElementById("dateLabel").innerText = currentDate;
    const todays = games.filter(g => g.date === currentDate);

    if (todays.length === 0) {
        listContainer.innerHTML = `<div style="padding:20px;font-size:22px;">Inga matcher idag</div>`;
        seriesView.innerHTML = "";
        return;
    }

    if (activeSort === "Plats") renderPlaceView(todays);
    else renderSeriesView(todays);
}

/* ================================================================
   PLATS-VY  (Stable version 1.0)
================================================================ */
let activeArena = null;
let arenaElements = [];

function renderPlaceView(matches) {
    seriesView.style.display = "none";
    listContainer.style.display = "block";

    const groups = {};
    matches.forEach(m => {
        if (!groups[m.arena]) groups[m.arena] = [];
        groups[m.arena].push(m);
    });

    const arenas = Object.keys(groups);
    activeArena = activeArena ?? arenas[0];

    activeArenaHeader.innerHTML = `${activeArena} <span class="arena-distance">${distance(groups[activeArena][0].lat, groups[activeArena][0].long)} km</span>`;

    listContainer.innerHTML = "";
    arenaElements = [];

    arenas.forEach(arena => {
        const header = document.createElement("div");
        header.className = "arenaHeader";
        header.innerText = `${arena}  •  ${distance(groups[arena][0].lat, groups[arena][0].long)} km`;
        listContainer.appendChild(header);
        arenaElements.push({ arena, header });

        groups[arena].forEach(g => {
            const div = document.createElement("div");
            div.className = "match";
            div.innerHTML = `
                <div class="topRow">${g.series_name}</div>
                <div class="bottomRow">
                    <span class="teamName">${g.home_team}</span>
                    <img class="teamLogo" src="${logoFor(g.homeClubs[0])}">
                    <span class="resultBox">${g.result}</span>
                    <img class="teamLogo" src="${logoFor(g.awayClubs[0])}">
                    <span class="teamName">${g.away_team}</span>
                </div>`;
            listContainer.appendChild(div);
        });
    });
}

/* ================================================================
   SERIE-VY  (Stable version 1.0)
================================================================ */
function renderSeriesView(matches) {
    listContainer.style.display = "none";
    seriesView.style.display = "block";

    seriesView.innerHTML = matches.map(g => `
        <div class="match">
            <div class="topRow">${g.series_name}</div>
            <div class="bottomRow">
                <span class="teamName">${g.home_team}</span>
                <img class="teamLogo" src="${logoFor(g.homeClubs[0])}">
                <span class="resultBox">${g.result}</span>
                <img class="teamLogo" src="${logoFor(g.awayClubs[0])}">
                <span class="teamName">${g.away_team}</span>
            </div>
        </div>
    `).join("");
}


/* ================================================================
   SORTERING
================================================================ */
let activeSort = "Plats";

document.getElementById("sortPlace").onclick = () => { activeSort="Plats"; updateSortingButtons(); render(); };
document.getElementById("sortSeries").onclick = () => { activeSort="Serie"; updateSortingButtons(); render(); };
document.getElementById("sortTime").onclick   = () => { activeSort="Tid";   updateSortingButtons(); render(); };

function updateSortingButtons() {
    sortPlace.className  = (activeSort==="Plats") ? "sort-btn sort-active" : "sort-btn sort-inactive";
    sortSeries.className = (activeSort==="Serie") ? "sort-btn sort-active" : "sort-btn sort-inactive";
    sortTime.className   = (activeSort==="Tid")   ? "sort-btn sort-active" : "sort-btn sort-inactive";
}

/* ================================================================
   DATE NAVIGATION
================================================================ */
function shiftDate(offset) {
    const d = new Date(currentDate);
    d.setDate(d.getDate() + offset);
    currentDate = d.toISOString().split("T")[0];
    render();
}

prevDate.onclick = () => shiftDate(-1);
nextDate.onclick = () => shiftDate(1);
homeBtn.onclick = () => { currentDate = getLocalISODate(); render(); };


/* ================================================================
   INIT
================================================================ */
(async function init(){
    await loadCSV();
    render();
})();
</script>

</body>
</html>

