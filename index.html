<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Hockeymatcher</title>

<style>
    body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        overflow: hidden;
        background-color: #111;
        color: white;
    }

    /* ---------- HEADER TOP ----------- */
    #topHeader {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #222;
        padding: 6px 10px;
        font-size: 16px;
        height: 46px;
        box-sizing: border-box;
    }

    #topHeader .left,
    #topHeader .right {
        width: 25%;
        display: flex;
        align-items: center;
    }

    #topHeader .middle {
        width: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .iconButton {
        background: none;
        border: none;
        padding: 0;
        margin: 0 6px;
    }

    #dateContainer {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        min-width: 140px;
        font-size: 15px;
    }

    #dateText {
        white-space: nowrap;
        font-size: 15px;
        font-weight: bold;
        width: auto;
    }

    .sortBox {
        border: 1px solid #999;
        padding: 3px 6px;
        border-radius: 6px;
        display: inline-block;
        text-align: center;
    }

    .sortButton {
        border: 1px solid gray;
        border-radius: 12px;
        background-color: #444;
        color: white;
        padding: 2px 8px;
        font-size: 13px;
        margin: 2px;
    }

    .sortButton.active {
        background-color: #00b300;
        border-color: #00ff00;
        font-weight: bold;
    }

    /* ---------- ARENA HEADER (STATIC) ----------- */
    #activeArenaHeader {
        width: 100%;
        padding: 4px 10px;
        font-size: 18px;
        font-weight: bold;
        background-color: #444;
        color: white;
        position: sticky;
        top: 46px;
        z-index: 5;
        display: none;
    }

    /* ---------- MAIN SCROLL AREA ----------- */
    #mainScrollArea {
        position: absolute;
        top: 82px;
        bottom: 0;
        width: 100%;
        overflow-y: scroll;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 200px;
    }

    /* ---------- ARENA HEADERS INSIDE SCROLL ----------- */
    .arenaHeader {
        background-color: #333;
        padding: 5px 10px;
        font-weight: bold;
        font-size: 18px;
        border-bottom: 1px solid #444;
        position: relative;
    }

    /* ---------- MATCH LIST ----------- */
    .match {
        border-bottom: 1px solid #333;
        padding: 4px 6px;
    }

    .matchTopRow {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        color: #999;
    }

    .matchBottomRow {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 14px;
        margin-top: 4px;
    }

    .teamInfo {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .teamName {
        max-width: 34vw;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: center;
    }

    .teamLogo {
        width: 36px;
        height: 36px;
        object-fit: contain;
        background-color: transparent;
    }

    .resultBox {
        min-width: 48px;
        max-width: 48px;
        height: 28px;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 6px;
        background-color: #eee;
        color: black;
        font-weight: bold;
    }
</style>
</head>

<body>

<!-- TOP HEADER -->
<div id="topHeader">
    <div class="left">
        <button class="iconButton" onclick="goHome()">
            <img src="icons/home.jpeg" width="22" />
        </button>
        <button class="iconButton" onclick="goMapView()">
            <img src="icons/map.jpeg" width="22" />
        </button>
    </div>

    <div class="middle" id="dateContainer">
        <img src="icons/arrow_left_green.png" width="16" id="prevDate" />
        <span id="dateText">Laddar...</span>
        <img src="icons/arrow_right_green.png" width="16" id="nextDate" />
    </div>

    <div class="right">
        <div class="sortBox">
            Sortering<br>
            <button id="sortLocation" class="sortButton active" onclick="setSort('location')">Plats</button>
            <button id="sortSeries" class="sortButton" onclick="setSort('series')">Serie</button>
            <button id="sortTime" class="sortButton" onclick="setSort('time')">Tid</button>
        </div>
    </div>
</div>

<div id="activeArenaHeader"></div>

<div id="mainScrollArea"></div>
<script>
/* ------------------------------------------------------------
   GLOBALA VARIABLER
-------------------------------------------------------------*/
let games = [];                 // alla matcher från CSV
let groupedByArena = {};        // arena -> lista av matcher
let sortedArenaKeys = [];       // sorterad lista av arenor
let activeArena = null;         // nuvarande aktiv arena
let sortMode = "location";      // location / series / time
let today = new Date();         // används om datum saknas i CSV
let userPos = { lat: 57.590214281624824, lon: 11.94608216084837 }; // fallback

/* ------------------------------------------------------------
   CSV-LOADER
-------------------------------------------------------------*/
async function loadGames() {
    const response = await fetch("data/games.csv");
    const text = await response.text();

    games = text
        .split("\n")
        .slice(1)
        .map(line => line.split(";"))
        .filter(col => col.length >= 19)
        .map(col => ({
            date: col[0],
            time: col[1],
            series: col[2],
            seriesLink: col[3],
            adminHost: col[4],
            homeTeam: col[5],
            awayTeam: col[6],
            result: col[7],
            resultLink: col[8],
            arenaName: col[9],
            status: col[10],
            homeClubList: col[13],
            awayClubList: col[14],
            arenaNbr: col[15],
            preferredName: col[16],
            lat: parseFloat(col[17]),
            lon: parseFloat(col[18])
        }));
}

/* ------------------------------------------------------------
   DISTANS (HAVERSINE)
-------------------------------------------------------------*/
function distanceInKm(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) ** 2 +
              Math.cos(lat1 * Math.PI/180) *
              Math.cos(lat2 * Math.PI/180) *
              Math.sin(dLon/2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

/* ------------------------------------------------------------
   LOAD CLUB LOGOS LOOKUP
-------------------------------------------------------------*/
let clubLogoMap = {};

async function loadClubLogoMap() {
    const response = await fetch("data/Clubs_Organisatons_logos__ClubOrgName_LogoFileName.txt");
    const text = await response.text();

    clubLogoMap = {};
    text.split("\n").forEach(line => {
        const [club, logo] = line.split(";");
        if (club && logo) {
            clubLogoMap[club.trim()] = "logos/" + logo.trim();
        }
    });
}

function getLogoForTeam(clubListStr) {
    if (!clubListStr) return null;
    const firstClub = clubListStr.split(",")[0].trim();
    return clubLogoMap[firstClub] || null;
}

/* ------------------------------------------------------------
   SORTERING AV MATCHER
-------------------------------------------------------------*/
function sortGames() {
    if (sortMode === "location") {
        sortedArenaKeys = Object.keys(groupedByArena).sort(
            (a, b) => groupedByArena[a].distance - groupedByArena[b].distance
        );
        return;
    }

    if (sortMode === "time") {
        games.sort((a, b) => a.time.localeCompare(b.time));
        sortedArenaKeys = ["ALL"];
        groupedByArena["ALL"] = games;
        return;
    }

    if (sortMode === "series") {
        games.sort((a, b) => a.series.localeCompare(b.series));
        sortedArenaKeys = ["ALL"];
        groupedByArena["ALL"] = games;
    }
}

/* ------------------------------------------------------------
   GRUPPERA MATCHER PER ARENA
-------------------------------------------------------------*/
function groupGamesByArena() {
    groupedByArena = {};

    games.forEach(g => {
        const key = g.preferredName || g.arenaName || "Okänd Arena";
        if (!groupedByArena[key]) groupedByArena[key] = [];

        const dist = distanceInKm(userPos.lat, userPos.lon, g.lat, g.lon);
        groupedByArena[key].push({ ...g, distance: dist });
    });

    Object.keys(groupedByArena).forEach(k => {
        groupedByArena[k].distance = Math.min(...groupedByArena[k].map(x => x.distance));
    });
}

/* ------------------------------------------------------------
   RENDER MATCHLISTAN (Stable ver 1.0)
-------------------------------------------------------------*/
function renderView() {
    const container = document.getElementById("mainScrollArea");
    container.innerHTML = "";

    sortedArenaKeys.forEach(arena => {
        if (arena !== "ALL") {
            const header = document.createElement("div");
            header.className = "arenaHeader";
            header.textContent = arena;
            container.appendChild(header);
        }

        groupedByArena[arena].forEach(match => {
            const div = document.createElement("div");
            div.className = "match";

            const homeLogo = getLogoForTeam(match.homeClubList);
            const awayLogo = getLogoForTeam(match.awayClubList);

            div.innerHTML = `
                <div class="matchTopRow">
                  <span>${match.time}</span>
                  <span>${match.series}</span>
                </div>

                <div class="matchBottomRow">
                    <div class="teamInfo">
                        <span class="teamName">${match.homeTeam}</span>
                        <img class="teamLogo" src="${homeLogo || ''}">
                    </div>

                    <div class="resultBox">${match.result || "-"}</div>

                    <div class="teamInfo">
                        <img class="teamLogo" src="${awayLogo || ''}">
                        <span class="teamName">${match.awayTeam}</span>
                    </div>
                </div>
            `;
            container.appendChild(div);
        });
    });
}
</script>
<script>
/* ------------------------------------------------------------
   SCROLL LOGIK — förbättrad enligt dina specifikationer
-------------------------------------------------------------*/

let isAutoScrolling = false;

function setActiveArena(newArenaKey, direction) {
    if (newArenaKey === activeArena) return;

    activeArena = newArenaKey;

    const activeHeader = document.getElementById("activeArenaHeader");
    if (activeHeader) activeHeader.textContent = activeArena;

    if (direction === "down") {
        autoScrollToFirstMatch(newArenaKey);
    } else if (direction === "up") {
        autoScrollToLastMatch(newArenaKey);
    }
}

function autoScrollToFirstMatch(arenaKey) {
    const element = document.querySelector(`[data-arena="${arenaKey}"][data-match-index="0"]`);
    if (!element) return;

    isAutoScrolling = true;
    element.scrollIntoView({ behavior: "smooth", block: "start" });

    setTimeout(() => { isAutoScrolling = false; }, 350);
}

function autoScrollToLastMatch(arenaKey) {
    const matches = document.querySelectorAll(`[data-arena="${arenaKey}"]`);
    if (!matches.length) return;

    const last = matches[matches.length - 1];
    isAutoScrolling = true;

    last.scrollIntoView({ behavior: "smooth", block: "start" });

    setTimeout(() => { isAutoScrolling = false; }, 350);
}

/* ------------------------------------------------------------
   SCROLL HANDLER
-------------------------------------------------------------*/
function handleScroll() {
    if (isAutoScrolling || sortMode !== "location") return;

    const allHeaders = [...document.querySelectorAll(".arenaHeader")];
    const scrollTop = mainScrollArea.scrollTop;
    const viewHeight = mainScrollArea.offsetHeight;

    // hittar aktiv arena header
    let currentIndex = allHeaders.findIndex(h => h.textContent === activeArena);

    if (currentIndex < 0) return;

    const activeHeader = allHeaders[currentIndex];
    const nextHeader = allHeaders[currentIndex + 1];
    const prevHeader = allHeaders[currentIndex - 1];

    /* ---------- NEDÅT ---------- */
    if (nextHeader) {
        const rect = nextHeader.getBoundingClientRect();
        const containerRect = mainScrollArea.getBoundingClientRect();
        const visibleHeight = rect.bottom - containerRect.top;

        if (visibleHeight < rect.height / 2) {
            const nextArenaName = nextHeader.textContent;
            setActiveArena(nextArenaName, "down");
            return;
        }
    }

    /* ---------- UPPÅT ---------- */
    if (prevHeader) {
        const rect = activeHeader.getBoundingClientRect();
        const containerRect = mainScrollArea.getBoundingClientRect();

        if (rect.top > containerRect.top) {
            const prevArenaName = prevHeader.textContent;
            setActiveArena(prevArenaName, "up");
            return;
        }
    }
}

/* ------------------------------------------------------------
   START (load CSV -> group -> sort -> render)
-------------------------------------------------------------*/
async function start() {
    await loadClubLogoMap();
    await loadGames();
    groupGamesByArena();
    sortGames();
    renderView();

    activeArena = sortedArenaKeys[0];
    document.getElementById("activeArenaHeader").textContent = activeArena;

    mainScrollArea.addEventListener("scroll", handleScroll);
}

window.onload = start;
</script>
</body>
</html>

