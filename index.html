<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />

<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="mobile-web-app-capable" content="yes" />

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#16a34a" />

<link rel="icon" type="image/png" sizes="32x32"  href="icons/icon_32_jetblack_exact2.png">
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon_192_jetblack_exact2.png">
<link rel="icon" type="image/png" sizes="512x512" href="icons/icon_512_jetblack_exact2.png">

<link rel="apple-touch-icon" href="icons/local_sport_promotional_poster_120.png"  sizes="120x120">
<link rel="apple-touch-icon" href="icons/local_sport_promotional_poster_152.png"  sizes="152x152">
<link rel="apple-touch-icon" href="icons/local_sport_promotional_poster_167.png"  sizes="167x167">
<link rel="apple-touch-icon" href="icons/local_sport_promotional_poster_180.png"  sizes="180x180">
<link rel="apple-touch-icon" href="icons/local_sport_promotional_poster_1024.png" sizes="1024x1024">

<meta property="og:title" content="Local Sport ‚Äì Live sport i en arena n√§ra dig">
<meta property="og:description" content="Se liveidrott i en arena n√§ra dig. Hockey, ungdomsidrott och allt d√§remellan.">
<meta property="og:image" content="icons/promotional_og_1200x630.png">
<meta property="og:image:type" content="image/png">
<meta property="og:type" content="website">
<meta property="og:url" content="https://skaterbosse.github.io/hockey/">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Local Sport ‚Äì Live sport i en arena n√§ra dig">
<meta name="twitter:image" content="icons/promotional_social_1080x1080.png">

<title>LocalSport ‚Äì Live sport i en arena n√§ra dig</title>

<style>
:root{
  --topbar-h:56px;
  --hint-h:26px;
  --bg:#f0f3f8;
  --hair:#e2e8f0;
  --text:#0f172a;
  --muted:#64748b;
  --accent:#16a34a;
  --link:#2563eb;
}

/* üåô Dark mode-variabler */
body.dark {
  --bg:#0b0f18;
  --hair:#1f2633;
  --text:#e6edf7;
  --muted:#9fb0c6;
  --link:#60a5fa;
}
body.dark .topbar,
body.dark .hint,
body.dark .game {
  background:#121826;
  border-color:#1f2633;
}
body.dark .result a,
body.dark .result div {
  background:#0f172a;
  border-color:#1f2633;
  color:#e6edf7;
}
body.dark .sort-stack{
  background:#0b0f18;
  border-color:#e5e7eb;
}

*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,Roboto,Arial,sans-serif;color:var(--text);overscroll-behavior:none;}
.device{width:100%;height:100dvh;display:flex;flex-direction:column;overflow:hidden;}
.topbar{position:sticky;top:0;z-index:500;background:#fff;border-bottom:1px solid var(--hair);}
.topbar-inner{
  display:grid;
  grid-template-columns:1fr auto 1fr;
  align-items:center;
  height:var(--topbar-h);
  padding:6px;
}
.cluster-left,.cluster-right{display:flex;gap:8px;align-items:center;}
.icon-btn{width:32px;height:32px;border-radius:10px;border:1px solid var(--hair);background:#f1f5f9;display:grid;place-items:center;cursor:pointer;}
.icon-img{width:20px;height:20px;object-fit:contain;}
.cluster-center{
  display:flex;align-items:center;justify-content:center;gap:8px;
  margin-left:-12px;
  margin-right:12px;
}
.date-block{display:flex;flex-direction:column;align-items:center;font-weight:700;font-size:13.5px;line-height:1.1;}
.sort-stack{border:1px solid var(--hair);border-radius:10px;background:#fff;padding:4px 6px;display:flex;flex-direction:column;align-items:center;}
.sort-top{font-size:12px;font-weight:600;margin-bottom:2px;}
.sort-bottom{display:flex;gap:4px;}
.pill{padding:4px 8px;font-size:11px;border-radius:999px;font-weight:600;border:1px solid var(--hair);cursor:pointer;user-select:none;}
.pill.on{background:#dcfce7;border-color:#86efac;color:var(--accent);}
.pill.off{background:#f1f5f9;border-color:#cbd5e1;color:#94a3b8;}
.hint{position:sticky;top:var(--topbar-h);height:var(--hint-h);background:#fff;border-bottom:1px solid var(--hair);text-align:center;font-size:12px;line-height:var(--hint-h);color:var(--muted);z-index:450;}
.scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;background:var(--bg);}
.game{
  background:#fff;
  border-top:1.5px solid #d4d4d8; /* tydligare linje mellan matcher */
  padding:8px 12px;
  display:grid;
  gap:6px;
}
body.dark .game{
  border-top:1.5px solid #1f2937;
}
.series-toprow{
  display:grid;
  grid-template-columns: 48% 32% 70px;
  align-items:center;
  column-gap:4px;
}
.series-toprow .series-name,
.series-toprow .arena-name{
  min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.series-toprow .dist{
  white-space:nowrap;text-align:right;color:var(--muted);font-size:12px;
}
.series-bottomrow{
  display:grid;
  grid-template-columns: auto 1fr auto 1fr;
  align-items:center;
  column-gap:6px;
}
.series-bottomrow .time{white-space:nowrap;font-weight:700;color:#000;}
body.dark .series-bottomrow .time{color:var(--text);}
.series-bottomrow .left{display:flex;align-items:center;gap:6px;justify-content:flex-end;}
.series-bottomrow .right{display:flex;align-items:center;gap:6px;}
.team-logo{width:26px;height:26px;border-radius:4px;object-fit:contain;background:transparent;}
.team-name{max-width:min(38vw,165px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:13px;}
.series-result{display:flex;justify-content:center;}
.result a,.result div{
  display:inline-block;
  padding:2px 10px;
  border-radius:8px;
  border:1px solid var(--hair);
  background:#f1f5f9;
  font-weight:700;
  text-decoration:none;
  color:var(--text);
}

/* G√∂r serienamn-l√§nkar tydliga */
.series-name a{
  color:var(--link);
  text-decoration:none;
}
.series-name a:hover{
  text-decoration:underline;
}

/* ‚öôÔ∏è Settingspanel */
#settingsPanel {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  backdrop-filter:blur(6px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}
#settingsCard {
  background:white;
  padding:18px;
  border-radius:14px;
  width:90%;
  max-width:380px;
  max-height:85vh;
  overflow-y:auto;
}
.settings-section{margin-bottom:16px;}
.settings-section h3{margin-bottom:8px;font-size:15px;}
.settings-row{display:flex;justify-content:space-between;margin-bottom:6px;}
#seriesTree details{margin-bottom:6px;}
#seriesTree summary{cursor:pointer;}
#seriesTree label{display:block;font-size:13px;margin-left:10px;margin-bottom:3px;}

/* üîπ LocalSport-logga √∂verst, fyller bredd, max ca 1.5√ó toppbarens h√∂jd */
#localsport-header {
  width:100%;
  background:#000;
  display:flex;
  justify-content:center;
  align-items:center;
  border-bottom:1px solid #111;
}
#localsport-header img {
  width:100%;
  max-height:calc(var(--topbar-h) * 1.5); /* ca 1.5√ó toppheadern */
  object-fit:contain;
}
</style>
</head>

<body>
<div class="device">

  <!-- üîπ Local Sport-logga h√∂gst upp, inte scrollande, ovanf√∂r toppbaren -->
  <div id="localsport-header">
    <img src="icons/local_sport_full_logo.svg" alt="Local Sport">
  </div>

<header class="topbar">
    <div class="topbar-inner">
      <div class="cluster-left">
        <button class="icon-btn" id="btnHome" title="Hem"><img class="icon-img" src="icons/home.jpeg" alt="home"></button>
        <button class="icon-btn" id="btnMap" title="Karta"><img class="icon-img" src="icons/map.jpeg" alt="map"></button>
      </div>
      <div class="cluster-center">
        <button class="icon-btn" id="btnPrev" title="F√∂reg√•ende">‚óÄ</button>
        <div class="date-block"><span id="lblRel">Idag</span><span id="lblWday">Tors</span><span id="lblDate">23 okt</span></div>
        <button class="icon-btn" id="btnNext" title="N√§sta">‚ñ∂</button>
      </div>
      <div class="cluster-right">
        <div class="sort-stack">
          <div class="sort-top">Sortering</div>
          <div class="sort-bottom">
            <span id="pillPlace" class="pill on">Plats</span>
            <span id="pillSeries" class="pill off">Serie</span>
            <span id="pillTime" class="pill off">Tid</span>
          </div>
        </div>
        <button class="icon-btn" id="btnSettings" title="Inst√§llningar">‚öôÔ∏è</button>
      </div>
    </div>
  </header>

  <div class="hint" id="hint">Visar matcher n√§ra: Kruniusv√§gen 1, Billdal</div>
  <main id="scrollArea" class="scroll"></main>
</div>

<button id="btnInstall" style="position:fixed;bottom:18px;left:50%;transform:translateX(-50%);padding:12px 18px;border-radius:999px;background:#16a34a;color:#fff;font-weight:600;display:none;z-index:600;">üì≤ Installera LocalSport</button>

<!-- ‚öôÔ∏è SETTINGS PANEL -->
<div id="settingsPanel">
  <div id="settingsCard">
    <h2>‚öôÔ∏è Inst√§llningar</h2>

    <div class="settings-section">
      <h3>Tema</h3>
      <label class="settings-row">
        <span>M√∂rkt l√§ge</span>
        <input type="checkbox" id="toggleDarkMode">
      </label>
    </div>

    <div class="settings-section">
      <h3>Max avst√•nd till arena (plats-vy)</h3>
      <select id="maxDistance">
        <option value="30000">30 km</option>
        <option value="70000">70 km</option>
        <option value="150000">150 km</option>
        <option value="300000">300 km</option>
        <option value="9999999">obegr√§nsat</option>
      </select>
    </div>

    <div class="settings-section">
      <h3>Favoritserier</h3>
      <div id="seriesTree"></div>
    </div>

    <button id="settingsClose" style="margin-top:16px;width:100%;padding:10px;background:#16a34a;color:#fff;border:none;border-radius:8px;">St√§ng</button>
  </div>
</div>

<script>
let deferredPrompt=null;
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js")
    .then(()=>console.log("‚úÖ SW registrerad"))
    .catch(err=>console.warn("SW FEL:",err));
}
window.addEventListener("beforeinstallprompt",e=>{
  e.preventDefault();
  deferredPrompt=e;
  btnInstall.style.display="block";
});
btnInstall.onclick=()=>{
  btnInstall.style.display="none";
  if(deferredPrompt){ deferredPrompt.prompt(); }
};
</script>

<!-- ‚öôÔ∏è SETTINGS SCRIPT (inkl. serie-tr√§d + persistens) -->
<script>
const settingsPanel=document.getElementById("settingsPanel");
const settingsButton=document.getElementById("btnSettings");
const settingsClose=document.getElementById("settingsClose");
const toggleDarkMode=document.getElementById("toggleDarkMode");
const maxDistance=document.getElementById("maxDistance");
const seriesTreeContainer=document.getElementById("seriesTree");

const SERIES_KEY_PREFIX="fav_series:";

// === SETTINGS LOAD/SAVE ===
function loadSettings(){
  const dark=JSON.parse(localStorage.getItem("darkMode"));
  document.body.classList.toggle("dark",!!dark);
  toggleDarkMode.checked=!!dark;

  const md=localStorage.getItem("maxDistance") || "9999999";
  maxDistance.value=md;
}
function saveSettings(){
  localStorage.setItem("darkMode",toggleDarkMode.checked);
  localStorage.setItem("maxDistance",maxDistance.value);
}

// Direkt-feedback p√• dark mode
toggleDarkMode.addEventListener("change",()=>{
  document.body.classList.toggle("dark",toggleDarkMode.checked);
  localStorage.setItem("darkMode",toggleDarkMode.checked);
});

// √ñppna/st√§ng panel
settingsButton.onclick=()=>{settingsPanel.style.display="flex";};
settingsClose.onclick=()=>{
  saveSettings();
  settingsPanel.style.display="none";
  // applicera filtrering direkt
  if(typeof render==="function") render();
};

// === Seriefilter ‚Äì persisterat ===
function isSeriesAllowed(seriesName){
  const key=SERIES_KEY_PREFIX+(seriesName||"");
  const val=localStorage.getItem(key);
  if(val===null) return true; // default: allt p√•slaget
  return val==="1";
}

function setSeriesAllowed(seriesName,on){
  const key=SERIES_KEY_PREFIX+(seriesName||"");
  localStorage.setItem(key,on?"1":"0");
}

// Klassificera region enligt din struktur
function classifyRegion(host){
  const h=(host||"").toLowerCase();
  if(/svenska ishockeyf√∂rbundet/.test(h) || /\b90\b/.test(h)) return "Nationell";
  if(/region syd/.test(h)) return "Region Syd";
  if(/region √∂st/.test(h) || /region ost/.test(h)) return "Region √ñst";
  if(/region norr/.test(h)) return "Region Norr";
  if(/region v√§st/.test(h) || /region vast/.test(h)) return "Region V√§st";

  if(/g√∂teborgs ishockeyf√∂rbund|blekinge ishockeyf√∂rbund|bohusl√§n dals ishockeyf√∂rbund|hallands ishockeyf√∂rbund|sk√•nes ishockeyf√∂rbund|sm√•lands ishockeyf√∂rbund|√∂sterg√∂tlands ishockeyf√∂rbund|v√§sterg√∂tlands ishockeyf√∂rbund/.test(h))
    return "Region Syd";
  if(/stockholms ishockeyf√∂rbund|upplands ishockeyf√∂rbund|gotlands ishockeyf√∂rbund|s√∂dermanlands ishockeyf√∂rbund/.test(h))
    return "Region √ñst";
  if(/v√§sterbottens ishockeyf√∂rbund|√•ngermanlands ishockeyf√∂rbund|norrbottens ishockeyf√∂rbund|j√§mtland-h√§rjedalens ishockeyf√∂rbund|medelpads ishockeyf√∂rbund/.test(h))
    return "Region Norr";
  if(/v√§rmlands ishockeyf√∂rbund|√∂rebro l√§ns ishockeyf√∂rbund|v√§stmanlands ishockeyf√∂rbund|h√§lsinglands ishockeyf√∂rbund|dalanas ishockeyf√∂rbund|g√§striklands ishockeyf√∂rbund/.test(h))
    return "Region V√§st";
  return "√ñvrigt";
}

// Klassificera seriegrupp, inkl. s√§rbehandling U20/U18 Regional vs Div 1
function classifyGroup(seriesLower){
  const s=seriesLower;

  if(/u20/.test(s) && /regional/.test(s)) return "U20 Regional";
  if(/u20/.test(s) && /(division\s*1|\bdiv\s*1\b|\bdiv1\b)/.test(s)) return "U20 Division 1";
  if(/u18/.test(s) && /regional/.test(s)) return "U18 Regional";
  if(/u18/.test(s) && /(division\s*1|\bdiv\s*1\b|\bdiv1\b)/.test(s)) return "U18 Division 1";

  if(/^shl\b/.test(s)) return "SHL";
  if(/^(ha\b|hockeyallsvenskan)/.test(s)) return "HockeyAllsvenskan";
  if(/^sdhl\b/.test(s)) return "SDHL";
  if(/hockeyettan/.test(s)) return "Hockeyettan";
  if(/hockeytv√•an|hockeytvaan|hockeytwoan/.test(s)) return "Hockeytv√•an";
  if(/hockeytrean/.test(s)) return "Hockeytrean";
  if(/hockeyfyran/.test(s)) return "Hockeyfyran";

  return "√ñvriga serier";
}

// Prio: slutspel/kval > topp > forts/v√•r > grundserie
function seriesPrioScore(name){
  const s=(name||"").toLowerCase();
  if(/play[- ]?off|play[- ]?in|slutspel|final|kval/.test(s)) return 0;
  if(/topp|top\s*\d+|superelit/.test(s)) return 1;
  if(/forts√§ttningsserie|forts\.|forts√§ttning|v√•rserie|v√•r\s/.test(s)) return 2;
  return 3;
}

// Bygger upp serie-tr√§det fr√•n allGames
function buildSeriesTreeFromGames(allGames){
  const tree={}; // region -> group -> Set(serienamn)

  for(const g of allGames||[]){
    const seriesName=(g.series_name||"").trim();
    if(!seriesName) continue;
    const host=g.admin_host||"";
    const region=classifyRegion(host);
    const group=classifyGroup(seriesName.toLowerCase());

    if(!tree[region]) tree[region]={};
    if(!tree[region][group]) tree[region][group]=new Set();
    tree[region][group].add(seriesName);
  }

  const regionOrder=["Nationell","Region Syd","Region √ñst","Region Norr","Region V√§st","√ñvrigt"];
  const finalTree={};

  regionOrder.forEach(r=>{
    if(tree[r]){
      finalTree[r]={};
      const groupNames=Object.keys(tree[r]).sort();
      for(const gName of groupNames){
        const arr=Array.from(tree[r][gName]);
        arr.sort((a,b)=>{
          const pa=seriesPrioScore(a), pb=seriesPrioScore(b);
          if(pa!==pb) return pa-pb;
          return a.localeCompare(b,"sv");
        });
        finalTree[r][gName]=arr;
      }
    }
  });

  renderSeriesTree(finalTree);
}

// Renderar serie-tr√§det till DOM
function renderSeriesTree(tree){
  const html=[];
  for(const region of Object.keys(tree)){
    html.push(`<details open><summary><strong>${region}</strong></summary>`);
    const groups=tree[region];
    for(const groupName of Object.keys(groups)){
      const seriesList=groups[groupName];
      html.push(`<details><summary>${groupName}</summary>`);
      seriesList.forEach(s=>{
        const checked=isSeriesAllowed(s) ? "checked" : "";
        const safeLabel=s.replace(/"/g,"&quot;");
        html.push(
          `<label><input type="checkbox" data-serie="${safeLabel}" ${checked}> ${safeLabel}</label>`
        );
      });
      html.push(`</details>`);
    }
    html.push(`</details>`);
  }
  seriesTreeContainer.innerHTML=html.join("");

  seriesTreeContainer.querySelectorAll("input[type=checkbox]").forEach(cb=>{
    cb.onchange=()=>{
      const serieName=cb.getAttribute("data-serie") || "";
      setSeriesAllowed(serieName,cb.checked);
      if(typeof render==="function") render();
    };
  });
}

loadSettings();
</script>

<script>
/* === STATE === */
let allGames = [];
let logoMap = {};
let currentDateISO = null;
const MODE = { PLACE:'place', SERIES:'series', SERIES_TIME:'series_time' };
let mode = MODE.PLACE;

const USER_LAT = 57.590214281624824;
const USER_LON = 11.94608216084837;

/* === FETCH DATA === */
Promise.all([
  fetch('data/Clubs_Organisatons_logos__ClubOrgName_LogoFileName.txt').then(r=>r.text()),
  fetch('data/games.csv').then(r=>r.text())
]).then(([mapTxt, csvTxt])=>{
  mapTxt.trim().split('\n').forEach(line=>{
    const [n,f] = line.split(';');
    if(n && f) logoMap[n.trim()] = f.trim();
  });
  allGames = parseCSV(csvTxt);

  // Bygg serie-tr√§d dynamiskt fr√•n games
  if(typeof buildSeriesTreeFromGames==="function"){
    buildSeriesTreeFromGames(allGames);
  }

  setToday();
});

/* === CSV PARSE === */
function parseCSV(txt){
  const lines = txt.split('\n').filter(x=>x.trim().length>0);
  const out=[];
  for(let i=1;i<lines.length;i++){
    const f = lines[i].split(';');
    if(f.length<19) continue;
    out.push({
      date:f[0], time:f[1], series_name:f[2], link_to_series:f[3], admin_host:f[4],
      home_team:f[5], away_team:f[6], result:f[7], result_link:f[8],
      arena:f[9], status:f[10], iteration_fetched:f[11], iterations_total:f[12],
      home_club_list:f[13]||'', away_club_list:f[14]||'',
      arena_nbr:f[15], PreferedName:f[16],
      Lat: parseFloat(f[17]), Long: parseFloat(f[18])
    });
  }
  return out;
}

/* === DATUM === */
function setToday(){
  const d = new Date();
  currentDateISO = d.toISOString().slice(0,10);
  render();
}
function changeDate(offset){
  const d = new Date(currentDateISO);
  d.setDate(d.getDate()+offset);
  currentDateISO = d.toISOString().slice(0,10);
  render();
}
document.getElementById('btnPrev').onclick = ()=>changeDate(-1);
document.getElementById('btnNext').onclick = ()=>changeDate(+1);
document.getElementById('btnHome').onclick = ()=>setToday();

/* === PILLS === */
const pillPlace = document.getElementById('pillPlace');
const pillSeries = document.getElementById('pillSeries');
const pillTime   = document.getElementById('pillTime');

pillPlace.onclick = ()=>{ mode = MODE.PLACE; applyPills(); render(); };
pillSeries.onclick = ()=>{ mode = MODE.SERIES; applyPills(); render(); };
pillTime.onclick   = ()=>{ mode = (mode===MODE.SERIES)? MODE.SERIES_TIME : MODE.SERIES; applyPills(); render(); };

function applyPills(){
  pillPlace.className = 'pill '+(mode===MODE.PLACE?'on':'off');
  pillSeries.className = 'pill '+(mode!==MODE.PLACE?'on':'off');
  pillTime.className   = 'pill '+(mode===MODE.SERIES_TIME?'on':'off');
}

/* === RENDER === */
function render(){
  const d = new Date(currentDateISO);
  document.getElementById('lblRel').textContent = relWord(d);
  document.getElementById('lblWday').textContent = ['S√∂n','M√•n','Tis','Ons','Tors','Fre','L√∂r'][d.getDay()];
  document.getElementById('lblDate').textContent = `${d.getDate()} ${['jan','feb','mar','apr','maj','jun','jul','aug','sep','okt','nov','dec'][d.getMonth()]}`;

  const todays = allGames.filter(g=>g.date===currentDateISO);
  if(todays.length===0){
    document.getElementById('scrollArea').innerHTML = `<div style="padding:20px;font-size:20px;text-align:center;background:#fff;">Inga matcher idag</div>`;
    return;
  }

  if(mode===MODE.PLACE) renderPlace(todays);
  else renderSeries(todays);
}

function relWord(d){
  const t = new Date(); t.setHours(0,0,0,0);
  const dd = new Date(d); dd.setHours(0,0,0,0);
  const diff = (dd - t)/(1000*60*60*24);
  if(diff===0) return 'Idag';
  if(diff===1) return 'Imorgon';
  if(diff===-1) return 'Ig√•r';
  return '';
}

/* === PLATS-VY (enhetlig layout; sorteras p√• avst√•nd + maxDist-filter) === */
function renderPlace(list){
  const byArena = {};
  list.forEach(g=>{
    const name = g.PreferedName || g.arena || "Arena";
    (byArena[name] ||= []).push(g);
  });

  const maxDistMeters = parseInt(localStorage.getItem("maxDistance") || "9999999",10);

  // filtrera bort arenor utanf√∂r max-avst√•nd
  const arenas = Object.keys(byArena)
    .filter(arenaName=>{
      const g0 = byArena[arenaName][0];
      if(!g0 || isNaN(g0.Lat) || isNaN(g0.Long)) return true; // beh√•ll om vi saknar koordinater
      const distKm = haversine(g0.Lat,g0.Long,USER_LAT,USER_LON);
      return (distKm*1000) <= maxDistMeters;
    })
    .sort((a,b)=>{
      const da = haversine(byArena[a][0].Lat, byArena[a][0].Long, USER_LAT,USER_LON);
      const db = haversine(byArena[b][0].Lat, byArena[b][0].Long, USER_LAT,USER_LON);
      return da-db;
    });

  if(arenas.length===0){
    document.getElementById('scrollArea').innerHTML =
      `<div style="padding:20px;font-size:16px;text-align:center;background:#fff;">Inga matcher inom valt maxavst√•nd</div>`;
    return;
  }

  const out=[];
  arenas.forEach(arena=>{
    byArena[arena].sort((a,b)=>a.time.localeCompare(b.time));
    byArena[arena].forEach(g=> out.push(gameCardUnified(g)));
  });

  document.getElementById('scrollArea').innerHTML = out.join('');
}

/* === SERIE-VY (respekt f√∂r favoritserier) === */
function renderSeries(list){
  const base=list;
  const filtered = base.filter(g=>isSeriesAllowed(g.series_name||""));

  if(filtered.length===0){
    document.getElementById('scrollArea').innerHTML =
      `<div style="padding:20px;font-size:16px;text-align:center;background:#fff;">Inga matcher idag med valda seriefilter</div>`;
    return;
  }

  let arr=[...filtered];
  if(mode===MODE.SERIES){
    arr.sort(seriesComparator); // prio ‚Üí alfabetiskt
  }else if(mode===MODE.SERIES_TIME){
    arr.sort((a,b)=>{
      const t = a.time.localeCompare(b.time);
      if(t!==0) return t;
      return seriesComparator(a,b);
    });
  }
  document.getElementById('scrollArea').innerHTML = arr.map(gameCardUnified).join('');
}

/* === GEMENSAM MATCHKORT-BYGGARE === */
function gameCardUnified(g){
  const homeLogo = pickLogo(g.home_club_list);
  const awayLogo = pickLogo(g.away_club_list);

  const distance = Math.ceil(haversine(g.Lat,g.Long,USER_LAT,USER_LON))+" km";

  const resHTML = (g.result_link && g.result && g.result.trim()!=='‚Äì')
    ? `<div class="result"><a href="${escapeHtml(g.result_link)}" target="_blank">${escapeHtml(g.result)}</a></div>`
    : `<div class="result"><div>${escapeHtml(g.result||'‚Äì')}</div></div>`;

  const seriesLabel = truncateDot(g.series_name||'', 40);
  const homeName = truncateDot(g.home_team||'', 14);
  const awayName = truncateDot(g.away_team||'', 14);

  return `
  <article class="game">
    <div class="series-toprow">
      <div class="series-name">${seriesLinkHTML(g, seriesLabel)}</div>
      <div class="arena-name">${escapeHtml(g.PreferedName||g.arena||'')}</div>
      <div class="dist">${distance}</div>
    </div>

    <div class="series-bottomrow">
      <div class="time">${escapeHtml(g.time||'')}</div>
    
      <div class="left">
        <span class="team-name" style="text-align:right;">${escapeHtml(homeName)}</span>
        <img class="team-logo" src="${homeLogo}" alt="">
      </div>
    
      <div class="series-result">
        ${resHTML}
      </div>
    
      <div class="right">
        <img class="team-logo" src="${awayLogo}" alt="">
        <span class="team-name" style="text-align:left;">${escapeHtml(awayName)}</span>
      </div>
    </div>
  </article>`;
}

/* === SERIE-PRIO & SORT === */
function seriesComparator(a,b){
  const ka = seriesSortKey(a), kb = seriesSortKey(b);
  for(let i=0;i<Math.max(ka.length,kb.length);i++){
    const va = ka[i], vb = kb[i];
    if(va<vb) return -1;
    if(va>vb) return 1;
  }
  return 0;
}

function seriesSortKey(g){
  const host = (g.admin_host||'').toLowerCase();
  const sname = (g.series_name||'');
  const s = sname.toLowerCase();

  const U = extractU(s);
  const PLUS = extractPlus(s);

  const isSIF = host.includes('90') || /svenska\s+ishockeyf√∂rbundet/i.test(host);
  const regionCode = detectRegionCode(host);
  const isRegion = regionCode>0;
  const districtCode = detectDistrictCode(host);
  const isDistrict = (!isSIF && !isRegion) && /f√∂rbund/i.test(host);

  const globalPlusPenalty = PLUS>0 ? 1 : 0;

  let groupRank;
  if(isSIF) groupRank = 1;
  else if(isRegion) groupRank = 2;
  else if(isDistrict) groupRank = 3;
  else groupRank = 4;

  const SIF_top = 1, SIF_mid=2, SIF_lowU=3, SIF_rest=4;
  const REG_top = 1, REG_mid=2, REG_low=3, REG_rest=4;
  const DIS_top = 1, DIS_mid=2, DIS_low=3;

  let subRank=999, detailA=0, detailB=0;

  if(isSIF){
    if(/^shl\b/.test(s)) { subRank=SIF_top; detailA=1; }
    else if(/^(ha|hockeyallsvenskan)/.test(s)) { subRank=SIF_top; detailA=2; }
    else if(/^sdhl\b/.test(s)) { subRank=SIF_top; detailA=3; }
    else if(/hockeyettan/.test(s)) { subRank=SIF_top; detailA=4; }
    else if(/\bswe\b/.test(s)) { subRank=SIF_mid; }
    else if(U>0){ subRank=SIF_lowU; detailA = -U; }
    else { subRank=SIF_rest; }
    return [groupRank, subRank, globalPlusPenalty, detailA, sname.toLowerCase()];
  }

  if(isRegion){
    if(/hockeytv√•an|hockeytvaan|hockeytwoan/.test(s)) { subRank=REG_top; detailA=1; }
    else if(/\bndhl\b/.test(s)) { subRank=REG_top; detailA=2; }
    else if(/hockeytrean/.test(s)) { subRank=REG_top; detailA=3; }
    else if(/damtv√•an|damtvaan|damtwoan/.test(s)) { subRank=REG_top; detailA=5; }
    else if(/\bu20\s*regional\b/.test(s)) { subRank=REG_top; detailA=4; }
    else if(/hockeyfyran/.test(s)) { subRank=REG_top; detailA=6; }
    else if(U>0){ subRank=REG_mid; detailA = -U; }
    else if(/tv[- ]?pucken|distriktslag|blekinge|stockholm|g√∂teborg|sk√•ne|v√§stmanland|sm√•land|h√§lsingland|g√§strikland|v√§rmland|v√§sterbotten|√•ngermanland|medelpad|norrbotten|gotland|halland|√∂sterg√∂tland|√∂rebro/.test(s)){
      subRank=REG_low;
    }
    else { subRank=REG_rest; }

    const regionOrder = [93,95,96,94];
    const regIdx = regionOrder.indexOf(regionCode);
    detailB = (regIdx===-1? 999 : regIdx);

    return [groupRank, subRank, globalPlusPenalty, detailA, detailB, sname.toLowerCase()];
  }

  if(isDistrict){
    if(/hockeyfyran|division\s*4|\bdiv\s*4\b|\bdiv4\b/i.test(s)) { subRank=DIS_top; detailA=1; }
    else if(/division\s*5|\bdiv\s*5\b|\bdiv5\b/i.test(s)) { subRank=DIS_top; detailA=2; }
    else if(U>0){ subRank=DIS_mid; detailA = -U; }
    else { subRank=DIS_low; }

    const distIdx = districtCode>0 ? districtCode : 999;
    return [groupRank, subRank, globalPlusPenalty, detailA, distIdx, sname.toLowerCase()];
  }

  return [5,(PLUS>0? 2:1),globalPlusPenalty,-U,sname.toLowerCase()];
}

/* Hj√§lp: regionkod fr√•n admin_host */
function detectRegionCode(host){
  const m = host.match(/\b(93|94|95|96)\b/);
  if(m) return parseInt(m[1],10);
  if(/syd/.test(host)) return 93;
  if(/√∂st/.test(host)) return 95;
  if(/norr/.test(host)) return 96;
  if(/v√§st/.test(host)) return 94;
  return 0;
}

/* Hj√§lp: distriktskoder enligt given ordning (1..23) */
function detectDistrictCode(host){
  const map = [
    ["blekinge ishockeyf√∂rbund",1],
    ["bohusl√§n dals ishockeyf√∂rbund",2],
    ["dalanas ishockeyf√∂rbund",3],
    ["gotlands ishockeyf√∂rbund",4],
    ["g√§striklands ishockeyf√∂rbund",5],
    ["g√∂teborgs ishockeyf√∂rbund",6],
    ["hallands ishockeyf√∂rbund",7],
    ["h√§lsinglands ishockeyf√∂rbund",8],
    ["j√§mtland-h√§rjedalens ishockeyf√∂rbund",9],
    ["medelpads ishockeyf√∂rbund",10],
    ["norrbottens ishockeyf√∂rbund",11],
    ["√∂rebro l√§ns ishockeyf√∂rbund",12],
    ["sk√•nes ishockeyf√∂rbund",13],
    ["sm√•lands ishockeyf√∂rbund",14],
    ["stockholms ishockeyf√∂rbund",15],
    ["s√∂dermanlands ishockeyf√∂rbund",16],
    ["upplands ishockeyf√∂rbund",17],
    ["v√§rmlands ishockeyf√∂rbund",18],
    ["v√§sterbottens ishockeyf√∂rbund",19],
    ["v√§sterg√∂tlands ishockeyf√∂rbund",20],
    ["v√§stmanlands ishockeyf√∂rbund",21],
    ["√•ngermanlands ishockeyf√∂rbund",22],
    ["√∂sterg√∂tlands ishockeyf√∂rbund",23],
  ];
  const h = (host||"").toLowerCase();
  for(const [k,v] of map){
    if(h.includes(k)) return v;
  }
  return 0;
}

function extractU(s){
  const m = s.match(/\bu(\d{2})\b/i);
  return m ? parseInt(m[1],10) : 0;
}
function extractPlus(s){
  const m = s.match(/\+(\d{2})\b/);
  const n = m ? parseInt(m[1],10) : 0;
  return (n>=30)? n : 0;
}

/* === LOGO === */
function pickLogo(listStr){
  const key = (listStr||'').split(',')[0].trim();
  return logoMap[key] ? `logos/${logoMap[key]}` : 'logos/placeholder.png';
}

/* === HELPERS === */
function seriesLinkHTML(g, label){
  const link=(g.link_to_series||'').trim();
  const safeLabel = escapeHtml(label || (g.series_name||''));
  return link ? `<a href="${escapeHtml(link)}" target="_blank">${safeLabel}</a>` : safeLabel;
}
function truncateDot(str, max){
  const s = String(str||'');
  if(s.length<=max) return s;
  return s.slice(0, max-1) + '.';
}
function escapeHtml(s){return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function haversine(lat1,lon1,lat2,lon2){
  const R=6371,toRad=x=>x*Math.PI/180;
  const dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
</script>

</body>
</html>

