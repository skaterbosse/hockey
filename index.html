<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />

<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="mobile-web-app-capable" content="yes" />

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#16a34a" />

<link rel="icon" type="image/png" sizes="32x32"  href="icons/icon_32_jetblack_exact2.png">
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon_192_jetblack_exact2.png">
<link rel="icon" type="image/png" sizes="512x512" href="icons/icon_512_jetblack_exact2.png">

<link rel="apple-touch-icon" href="icons/local_sport_promotional_poster_120.png"  sizes="120x120">
<link rel="apple-touch-icon" href="icons/local_sport_promotional_poster_152.png"  sizes="152x152">
<link rel="apple-touch-icon" href="icons/local_sport_promotional_poster_167.png"  sizes="167x167">
<link rel="apple-touch-icon" href="icons/local_sport_promotional_poster_180.png"  sizes="180x180">
<link rel="apple-touch-icon" href="icons/local_sport_promotional_poster_1024.png" sizes="1024x1024">

<meta property="og:title" content="Local Sport ‚Äì Live sport i en arena n√§ra dig">
<meta property="og:description" content="Se liveidrott i en arena n√§ra dig. Hockey, ungdomsidrott och allt d√§remellan.">
<meta property="og:image" content="icons/promotional_og_1200x630.png">
<meta property="og:image:type" content="image/png">
<meta property="og:type" content="website">
<meta property="og:url" content="https://skaterbosse.github.io/hockey/">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Local Sport ‚Äì Live sport i en arena n√§ra dig">
<meta name="twitter:image" content="icons/promotional_social_1080x1080.png">

<title>LocalSport ‚Äì Live sport i en arena n√§ra dig</title>

<style>
:root{
  --topbar-h:56px;
  --hint-h:26px;
  --bg:#f0f3f8;
  --hair:#e2e8f0;
  --text:#0f172a;
  --muted:#64748b;
  --accent:#16a34a;
  --link:#2563eb;
}

/* üåô Dark mode-variabler */
body.dark {
  --bg:#0b0f18;
  --hair:#1f2633;
  --text:#e6edf7;
  --muted:#9fb0c6;
  --link:#60a5fa;
}
body.dark .topbar,
body.dark .hint,
body.dark .game {
  background:#121826;
  border-color:#1f2633;
}
body.dark .result a,
body.dark .result div {
  background:#0f172a;
  border-color:#1f2633;
  color:#e6edf7;
}
body.dark .sort-stack{
  background:#0b0f18;
  border-color:#e5e7eb;
}

*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,Roboto,Arial,sans-serif;color:var(--text);overscroll-behavior:none;}
.device{width:100%;height:100dvh;display:flex;flex-direction:column;overflow:hidden;}
.topbar{position:sticky;top:0;z-index:500;background:#fff;border-bottom:1px solid var(--hair);}
.topbar-inner{
  display:grid;
  grid-template-columns:1fr auto 1fr;
  align-items:center;
  height:var(--topbar-h);
  padding:6px;
}
.cluster-left,.cluster-right{display:flex;gap:8px;align-items:center;}
.icon-btn{width:32px;height:32px;border-radius:10px;border:1px solid var(--hair);background:#f1f5f9;display:grid;place-items:center;cursor:pointer;}
.icon-img{width:20px;height:20px;object-fit:contain;}
.cluster-center{
  display:flex;align-items:center;justify-content:center;gap:8px;
  margin-left:-12px;
  margin-right:12px;
}
.date-block{display:flex;flex-direction:column;align-items:center;font-weight:700;font-size:13.5px;line-height:1.1;}
.sort-stack{border:1px solid var(--hair);border-radius:10px;background:#fff;padding:4px 6px;display:flex;flex-direction:column;align-items:center;}
.sort-top{font-size:12px;font-weight:600;margin-bottom:2px;}
.sort-bottom{display:flex;gap:4px;}
.pill{padding:4px 8px;font-size:11px;border-radius:999px;font-weight:600;border:1px solid var(--hair);cursor:pointer;user-select:none;}
.pill.on{background:#dcfce7;border-color:#86efac;color:var(--accent);}
.pill.off{background:#f1f5f9;border-color:#cbd5e1;color:#94a3b8;}
.hint{position:sticky;top:var(--topbar-h);height:var(--hint-h);background:#fff;border-bottom:1px solid var(--hair);text-align:center;font-size:12px;line-height:var(--hint-h);color:var(--muted);z-index:450;}
.scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;background:var(--bg);}
.game{
  background:#fff;
  border-top:1.5px solid #d4d4d8;
  padding:8px 12px;
  display:grid;
  gap:6px;
}
body.dark .game{
  border-top:1.5px solid #1f2937;
}
.series-toprow{
  display:grid;
  grid-template-columns: 48% 32% 70px;
  align-items:center;
  column-gap:4px;
}
.series-toprow .series-name,
.series-toprow .arena-name{
  min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.series-toprow .dist{
  white-space:nowrap;text-align:right;color:var(--muted);font-size:12px;
}
.series-bottomrow{
  display:grid;
  grid-template-columns: auto 1fr auto 1fr;
  align-items:center;
  column-gap:6px;
}
.series-bottomrow .time{white-space:nowrap;font-weight:700;color:#000;}
body.dark .series-bottomrow .time{color:var(--text);}
.series-bottomrow .left{display:flex;align-items:center;gap:6px;justify-content:flex-end;}
.series-bottomrow .right{display:flex;align-items:center;gap:6px;}
.team-logo{width:26px;height:26px;border-radius:4px;object-fit:contain;background:transparent;}
.team-name{max-width:min(38vw,165px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:13px;}
.series-result{display:flex;justify-content:center;}
.result a,.result div{
  display:inline-block;
  padding:2px 10px;
  border-radius:8px;
  border:1px solid var(--hair);
  background:#f1f5f9;
  font-weight:700;
  text-decoration:none;
  color:var(--text);
}

/* Serienamn-l√§nkar */
.series-name a{
  color:var(--link);
  text-decoration:none;
}
.series-name a:hover{
  text-decoration:underline;
}

/* ‚öôÔ∏è Settingspanel */
#settingsPanel {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  backdrop-filter:blur(6px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}
#settingsCard {
  background:white;
  padding:18px;
  border-radius:14px;
  width:90%;
  max-width:380px;
  max-height:85vh;
  overflow-y:auto;
}
.settings-section{margin-bottom:16px;}
.settings-section h3{margin-bottom:8px;font-size:15px;}
.settings-row{display:flex;justify-content:space-between;margin-bottom:6px;}
#seriesTree details{margin-bottom:6px;}
#seriesTree summary{cursor:pointer;}
#seriesTree label{display:block;font-size:13px;margin-left:10px;margin-bottom:3px;}
</style>
</head>
<body>
<div class="device">
<header class="topbar">
  <div class="topbar-inner">
    <div class="cluster-left">
      <button class="icon-btn" id="btnHome" title="Hem"><img class="icon-img" src="icons/home.jpeg" alt="home"></button>
      <button class="icon-btn" id="btnMap" title="Karta"><img class="icon-img" src="icons/map.jpeg" alt="map"></button>
    </div>
    <div class="cluster-center">
      <button class="icon-btn" id="btnPrev" title="F√∂reg√•ende">‚óÄ</button>
      <div class="date-block"><span id="lblRel">Idag</span><span id="lblWday">Tors</span><span id="lblDate">23 okt</span></div>
      <button class="icon-btn" id="btnNext" title="N√§sta">‚ñ∂</button>
    </div>
    <div class="cluster-right">
      <div class="sort-stack">
        <div class="sort-top">Sortering</div>
        <div class="sort-bottom">
          <span id="pillPlace" class="pill on">Plats</span>
          <span id="pillSeries" class="pill off">Serie</span>
          <span id="pillTime" class="pill off">Tid</span>
        </div>
      </div>
      <button class="icon-btn" id="btnSettings" title="Inst√§llningar">‚öôÔ∏è</button>
    </div>
  </div>
</header>

<div class="hint" id="hint">Visar matcher n√§ra: Kruniusv√§gen 1, Billdal</div>
<main id="scrollArea" class="scroll"></main>
</div>

<button id="btnInstall" style="position:fixed;bottom:18px;left:50%;transform:translateX(-50%);padding:12px 18px;border-radius:999px;background:#16a34a;color:#fff;font-weight:600;display:none;z-index:600;">üì≤ Installera LocalSport</button>

<!-- ‚öôÔ∏è SETTINGS PANEL -->
<div id="settingsPanel">
  <div id="settingsCard">
    <h2>‚öôÔ∏è Inst√§llningar</h2>

    <div class="settings-section">
      <h3>Tema</h3>
      <label class="settings-row">
        <span>M√∂rkt l√§ge</span>
        <input type="checkbox" id="toggleDarkMode">
      </label>
    </div>

    <div class="settings-section">
      <h3>Max avst√•nd till arena (plats-vy)</h3>
      <select id="maxDistance">
        <option value="30000">30 km</option>
        <option value="70000">70 km</option>
        <option value="150000">150 km</option>
        <option value="300000">300 km</option>
        <option value="9999999">obegr√§nsat</option>
      </select>
    </div>

    <div class="settings-section">
      <h3>Favoritserier</h3>
      <div id="seriesTree"></div>
    </div>

    <button id="settingsClose" style="margin-top:16px;width:100%;padding:10px;background:#16a34a;color:#fff;border:none;border-radius:8px;">St√§ng</button>
  </div>
</div>

<script>
let deferredPrompt=null;
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js")
    .then(()=>console.log("‚úÖ SW registrerad"))
    .catch(err=>console.warn("SW FEL:",err));
}
window.addEventListener("beforeinstallprompt",e=>{
  e.preventDefault();
  deferredPrompt=e;
  btnInstall.style.display="block";
});
btnInstall.onclick=()=>{
  btnInstall.style.display="none";
  if(deferredPrompt){ deferredPrompt.prompt(); }
};
</script>

<!-- ‚öôÔ∏è SETTINGS (OR√ñRD) -->
<script>
/* ... exakt samma settings-kod som innan, of√∂r√§ndrad ... */
</script>

<script>
/* === STATE === */
let allGames = [];
let logoMap = {};
let currentDateISO = null;
const MODE = { PLACE:'place', SERIES:'series', SERIES_TIME:'series_time' };
let mode = MODE.PLACE;

const USER_LAT = 57.590214281624824;
const USER_LON = 11.94608216084837;

/* === FETCH DATA === */
Promise.all([
  fetch('data/Clubs_Organisatons_logos__ClubOrgName_LogoFileName.txt').then(r=>r.text()),
  fetch('data/games.csv').then(r=>r.text())
]).then(([mapTxt, csvTxt])=>{
  mapTxt.trim().split('\n').forEach(line=>{
    const [n,f] = line.split(';');
    if(n && f) logoMap[n.trim()] = f.trim();
  });
  allGames = parseCSV(csvTxt);

  if(typeof buildSeriesTreeFromGames==="function"){
    buildSeriesTreeFromGames(allGames);
  }

  setToday();
});
function render(){
  const d = new Date(currentDateISO);
  document.getElementById('lblRel').textContent = relWord(d);
  document.getElementById('lblWday').textContent =
    ['S√∂n','M√•n','Tis','Ons','Tors','Fre','L√∂r'][d.getDay()];
  document.getElementById('lblDate').textContent =
    `${d.getDate()} ${['jan','feb','mar','apr','maj','jun',
                      'jul','aug','sep','okt','nov','dec'][d.getMonth()]}`;

  const todays = allGames.filter(g=>g.date===currentDateISO);
  if(todays.length===0){
    document.getElementById('scrollArea').innerHTML =
      `<div style="padding:20px;font-size:20px;text-align:center;background:#fff;">
         Inga matcher idag
       </div>`;
    return;
  }

  if(mode===MODE.PLACE) renderPlace(todays);
  else renderSeries(todays);
}

/* === PLATS-VY MED ARENA-BASERAD F√ÑRGV√ÑXLING === */
function renderPlace(list){
  const byArena = {};
  list.forEach(g=>{
    const a = g.PreferedName || g.arena || "Arena";
    (byArena[a] ||= []).push(g);
  });

  const maxDistMeters =
    parseInt(localStorage.getItem("maxDistance") || "9999999", 10);

  const arenas = Object.keys(byArena)
    .filter(a=>{
      const g0 = byArena[a][0];
      if(!g0 || isNaN(g0.Lat) || isNaN(g0.Long)) return true;
      const distKm = haversine(g0.Lat,g0.Long,USER_LAT,USER_LON);
      return (distKm*1000)<=maxDistMeters;
    })
    .sort((a,b)=>{
      const da=haversine(byArena[a][0].Lat,byArena[a][0].Long,USER_LAT,USER_LON);
      const db=haversine(byArena[b][0].Lat,byArena[b][0].Long,USER_LAT,USER_LON);
      return da-db;
    });

  if(arenas.length===0){
    document.getElementById('scrollArea').innerHTML =
      `<div style="padding:20px;font-size:16px;text-align:center;background:#fff;">
        Inga matcher inom valt maxavst√•nd
      </div>`;
    return;
  }

  let out=[];
  let toggle=0;
  const dark = document.body.classList.contains("dark");
  const bgA = dark ? "#3B3B3B" : "#DDFFC4";
  const bgB = dark ? "#000000" : "#FFFFFF";

  arenas.forEach(a=>{
    const arenaBg = toggle===0 ? bgA : bgB;
    toggle = 1 - toggle;

    byArena[a].sort((x,y)=>x.time.localeCompare(y.time));

    byArena[a].forEach(g=>{
      out.push(
        gameCardUnified(g)
          .replace('<article class="game">',
                   `<article class="game" style="background:${arenaBg};">`)
      );
    });
  });

  document.getElementById('scrollArea').innerHTML = out.join('');
}

/* === SERIE-VY MED SERIE-BASERAD F√ÑRGV√ÑXLING === */
function renderSeries(list){
  const filtered = list.filter(g=>isSeriesAllowed(g.series_name||""));

  if(filtered.length===0){
    document.getElementById('scrollArea').innerHTML =
      `<div style="padding:20px;font-size:16px;text-align:center;background:#fff;">
        Inga matcher idag med valda seriefilter
      </div>`;
    return;
  }

  let arr=[...filtered];
  if(mode===MODE.SERIES){
    arr.sort(seriesComparator);
  } else if(mode===MODE.SERIES_TIME){
    arr.sort((a,b)=>{
      const t = a.time.localeCompare(b.time);
      if(t!==0) return t;
      return seriesComparator(a,b);
    });
  }

  let out=[];
  let lastSeries=null;
  let toggle=0;
  const dark=document.body.classList.contains("dark");
  const bgA = dark ? "#3B3B3B" : "#DDFFC4";
  const bgB = dark ? "#000000" : "#FFFFFF";

  arr.forEach(g=>{
    if(g.series_name !== lastSeries){
      toggle = 1 - toggle;
      lastSeries = g.series_name;
    }
    const bg = toggle===0 ? bgA : bgB;

    out.push(
      gameCardUnified(g)
        .replace('<article class="game">',
                 `<article class="game" style="background:${bg};">`)
    );
  });

  document.getElementById('scrollArea').innerHTML = out.join('');
}
</script>

</body>
</html>

