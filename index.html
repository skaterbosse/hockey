<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="mobile-web-app-capable" content="yes" />
<title>LocalSport v18.3 ‚Ä¢ Index (CSV)</title>

<style>
:root {
  --topbar-h:56px;
  --hint-h:26px;
  --slot-h:42px;
  --bg:#f0f3f8;
  --hair:#e2e8f0;
  --text:#0f172a;
  --muted:#64748b;
  --accent:#16a34a;
  --link:#2563eb;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,Roboto,Arial,sans-serif;color:var(--text);overscroll-behavior:none;}
.device{width:100%;height:100dvh;display:flex;flex-direction:column;overflow:hidden;}

/* Top bar */
.topbar{position:sticky;top:0;z-index:500;background:#fff;border-bottom:1px solid var(--hair);}
.topbar-inner{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;height:var(--topbar-h);padding:6px;}
.cluster-left,.cluster-right{display:flex;gap:8px;align-items:center;}
.icon-btn{width:32px;height:32px;border-radius:10px;border:1px solid var(--hair);background:#f1f5f9;display:grid;place-items:center;cursor:pointer;}
.cluster-center{display:flex;align-items:center;justify-content:center;gap:8px;}
.date-block{display:flex;flex-direction:column;align-items:center;font-weight:700;font-size:13.5px;line-height:1.1;}

/* Sort */
.sort-stack{border:1px solid var(--hair);border-radius:10px;background:#fff;padding:4px 6px;display:flex;flex-direction:column;align-items:center;}
.sort-top{font-size:12px;font-weight:600;margin-bottom:2px;}
.sort-bottom{display:flex;gap:4px;}
.pill{padding:4px 8px;font-size:11px;border-radius:999px;font-weight:600;border:1px solid var(--hair);cursor:pointer;user-select:none;}
.pill.on{background:#dcfce7;border-color:#86efac;color:var(--accent);}
.pill.off{background:#f1f5f9;border-color:#cbd5e1;color:#94a3b8;}
.pill.lock{opacity:.6;cursor:not-allowed;}

/* Hint */
.hint{position:sticky;top:var(--topbar-h);height:var(--hint-h);background:#fff;border-bottom:1px solid var(--hair);text-align:center;font-size:12px;line-height:var(--hint-h);color:var(--muted);z-index:450;}

/* Sticky arena slot */
.group-slot{position:sticky;top:calc(var(--topbar-h) + var(--hint-h));height:var(--slot-h);display:flex;justify-content:space-between;align-items:center;padding:10px 12px;font-size:14px;font-weight:700;background:#fff;border-bottom:1px dashed var(--hair);z-index:425;}

/* Scroll */
.scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;background:var(--bg);touch-action:pan-y;}
/* Prevent horizontal ‚Äúfloaty‚Äù feel on iPhone */
.scroll, body { overscroll-behavior-y: contain; }

/* Headers in scroll */
.arena-header{padding:10px 12px;background:#fff;border-bottom:1px dashed var(--hair);font-weight:700;display:flex;justify-content:space-between;}
.arena-header.active-hidden{visibility:hidden;height:0;padding:0;margin:0;border:none;}

/* Games */
.game{background:#fff;border-top:1px dashed #e5e7eb;padding:8px 12px;display:grid;gap:6px;}
.game-top{display:flex;align-items:center;gap:8px;flex-wrap:nowrap;}
.game-time{font-weight:700;white-space:nowrap;}
.game-series a{text-decoration:none;font-weight:600;color:var(--link);white-space:nowrap;}
.game-mid{flex:1 1 auto;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:700;}
.game-right{white-space:nowrap;font-size:12px;color:var(--muted);}

.game-bottom{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:24px;}
.game-bottom .result{justify-self:center;} /* always perfectly centered */

.team{display:inline-flex;align-items:center;font-weight:600;}
.team.home{justify-content:flex-end;text-align:right;}
.team.home .team-name{order:1;margin-right:6px;max-width:min(38vw,165px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:13px;}
.team.home .team-logo{order:2;}
.team.away{justify-content:flex-start;text-align:left;}
.team.away .team-logo{order:1;}
.team.away .team-name{order:2;margin-left:6px;max-width:min(38vw,165px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:13px;}
.team-logo{width:26px;height:26px;border-radius:50%;border:1px solid var(--hair);object-fit:cover;background:#eee;}

/* Fallback logo */
.logo-fallback{width:26px;height:26px;border-radius:50%;border:1px solid var(--hair);display:flex;align-items:center;justify-content:center;background:#e5e7eb;color:#334155;font-weight:800;font-size:10px;letter-spacing:.5px;}

/* Result */
.result a{display:inline-block;padding:2px 10px;border-radius:8px;border:1px solid var(--link);background:#fff;text-decoration:none;font-weight:700;color:var(--link);}
.result.no-link{font-weight:700;padding:2px 10px;color:var(--text);}

/* Dividers */
.divider{height:7px;background:var(--bg);border-top:1px dashed var(--hair);}
.series-divider{height:7px;background:var(--bg);border-top:1px dashed var(--hair);}
</style>
</head>

<body>
<div class="device">

  <header class="topbar">
    <div class="topbar-inner">
      <div class="cluster-left">
        <button id="btnHome" class="icon-btn" title="Hem">üè†</button>
        <button class="icon-btn" title="Karta">üó∫Ô∏è</button>
      </div>

      <div class="cluster-center">
        <button class="icon-btn" id="btnPrev" title="F√∂reg√•ende dag">‚óÄ</button>
        <div class="date-block"><span id="lblToday"></span><span id="lblWeekday"></span><span id="lblDate"></span></div>
        <button class="icon-btn" id="btnNext" title="N√§sta dag">‚ñ∂</button>
      </div>

      <div class="cluster-right">
        <div class="sort-stack">
          <div class="sort-top">Sortering</div>
          <div class="sort-bottom">
            <span id="pillPlace" class="pill on">Plats</span>
            <span id="pillSeries" class="pill off">Serie</span>
            <span id="pillTime" class="pill on lock">Tid</span>
          </div>
        </div>
        <button class="icon-btn" title="Inst√§llningar">‚öôÔ∏è</button>
      </div>
    </div>
  </header>

  <div class="hint">Visar matcher n√§ra: Kruniusv√§gen 1, Billdal</div>

  <div id="groupSlot" class="group-slot" aria-live="polite">
    <div class="group-title">Arenan</div>
    <div class="group-sub">Avst ‚Äì km</div>
  </div>

  <main id="scrollArea" class="scroll" role="feed" aria-busy="true"></main>

</div>

<script>
/* ================== KONFIG ================== */
const USER_POS = { lat:57.590214281624824, lon:11.94608216084837 }; // Billdal
const DATA_PATH = {
  games: './data/games.csv',
  logosMap: './data/Clubs_Organisatons_logos__ClubOrgName_LogoFileName.txt'
};
const MODE = { PLACE:'place', SERIES:'series', SERIES_TIME:'series_time' };

/* ================== DOM ================== */
const pillPlace=document.getElementById('pillPlace');
const pillSeries=document.getElementById('pillSeries');
const pillTime=document.getElementById('pillTime');
const scroll=document.getElementById('scrollArea');
const slot=document.getElementById('groupSlot');
const lblToday=document.getElementById('lblToday');
const lblWeekday=document.getElementById('lblWeekday');
const lblDate=document.getElementById('lblDate');
const btnPrev=document.getElementById('btnPrev');
const btnNext=document.getElementById('btnNext');
const btnHome=document.getElementById('btnHome');

/* ================== STATE ================== */
let mode = MODE.PLACE;
let gamesAll = [];              // alla matcher (alla datum)
let games = [];                 // filtrerat p√• currentDate
let logoMap = {};               // { 'Fr√∂lunda HC': '/logos/FHC.png', ... }
let currentArena = null;
let arenaOrder = [];
let lastScrollTop = 0;

const svWeek = ['S√∂n','M√•n','Tis','Ons','Tors','Fre','L√∂r'];
const svMonth = ['jan','feb','mar','apr','maj','jun','jul','aug','sep','okt','nov','dec'];

let today = new Date();               // browserns lokala datum
let currentDate = new Date(today);    // start = idag

/* ================== HELPERS ================== */
function pad(n){ return n<10 ? '0'+n : ''+n; }
function dateToYYYYMMDD(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function humanDate(d){
  const wd = svWeek[d.getDay()];
  const mon = svMonth[d.getMonth()];
  return { wd, mon, day: d.getDate() };
}
function updateDateHeader(){
  const { wd, mon, day } = humanDate(currentDate);
  const isToday = dateToYYYYMMDD(currentDate) === dateToYYYYMMDD(today);
  lblToday.textContent = isToday ? 'Idag' : '';
  lblWeekday.textContent = wd;
  lblDate.textContent = `${day} ${mon}`;
}

function kmRound(v){ return Math.round(v); }
function toRad(d){ return d*Math.PI/180; }
function haversine(lat1,lon1,lat2,lon2){
  const R=6371;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
function parseTime(t){
  const [H,M] = (t||'').trim().split(':').map(Number);
  return (isFinite(H)?H:0)*60 + (isFinite(M)?M:0);
}
function seriesPriority(s){
  const n = (s||'').toLowerCase();
  if(n.includes('shl')) return 1;
  if(n.includes('ha') || n.includes('allsv')) return 2;
  if(n.includes('sdhl')) return 3;
  if(n.includes('hockeyettan')) return 4;
  if(n.includes('hockeytv√•an')||n.includes('tv√•an')) return 10;
  if(n.includes('ndhl')||n.includes('trean')||n.includes('damtv√•an')||n.includes('fyran')) return 20;
  if(n.includes('j20')||n.includes('u20')) return 30;
  if(n.includes('j18')||n.includes('u18')) return 31;
  if(n.includes('tr√§ning')) return 90;
  return 50;
}
function fullMatchUrl(path){
  if(!path) return '';
  return path.startsWith('http') ? path : ('https://stats.swehockey.se'+path);
}

/* Fallback-initialer, t.ex. "Fr√∂lunda Hockey Club" => "FHC" */
function initials(name){
  if(!name) return '?';
  const words = name.replace(/\s+/g,' ').trim().split(' ');
  const letters = words.slice(0,3).map(w=>w[0]).join('');
  return letters.toUpperCase();
}

/* Logos: direkt team-namn ‚Üí fil, annars testa club-list (komma-separerad) */
function logoFor(name, clubList){
  if(logoMap[name]) return logoMap[name];
  const parts = (clubList||'').split(',').map(s=>s.trim()).filter(Boolean);
  for(const p of parts){
    if(logoMap[p]) return logoMap[p];
  }
  return null;
}

/* ================== LADDA DATA ================== */
async function fetchText(url){
  const res = await fetch(url, { cache:'no-store' });
  if(!res.ok) throw new Error('HTTP '+res.status+' for '+url);
  return await res.text();
}

function parseGamesCSV(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l && !l.startsWith('#'));
  const out = [];
  for(const line of lines){
    // semikolon-separerat
    const cols = line.split(';');
    if(cols.length < 19) continue;
    const obj = {
      date: cols[0],
      time: cols[1],
      series_name: cols[2],
      link_to_series: cols[3],
      admin_host: cols[4],
      home_team: cols[5],
      away_team: cols[6],
      result: (cols[7]||'‚Äì').trim() || '‚Äì',
      result_link: cols[8],
      arena_raw: cols[9],
      status: cols[10],
      iteration_fetched: cols[11],
      iterations_total: cols[12],
      home_club_list: cols[13],
      away_club_list: cols[14],
      arena_nbr: cols[15],
      PreferedName: cols[16],
      Lat: parseFloat(cols[17]),
      Long: parseFloat(cols[18])
    };
    obj.arena = obj.PreferedName || obj.arena_raw || '';
    if(Number.isFinite(obj.Lat) && Number.isFinite(obj.Long)){
      obj.distance_km = haversine(USER_POS.lat, USER_POS.lon, obj.Lat, obj.Long);
    }else{
      obj.distance_km = Number.POSITIVE_INFINITY;
    }
    out.push(obj);
  }
  return out;
}

function parseLogosMap(text){
  // Format: "Klubb/Organisation;LogoFil.png" per rad
  const map = {};
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l && !l.startsWith('#'));
  for(const line of lines){
    const [name, file] = line.split(';').map(s=>s.trim());
    if(name && file){
      const path = file.startsWith('/') ? file : ('/logos/'+file);
      map[name] = path;
    }
  }
  return map;
}

/* ================== UI RENDER HELPERS ================== */
function applyPills(){
  pillPlace.className=(mode===MODE.PLACE)?'pill on':'pill off';
  pillSeries.className=(mode===MODE.SERIES||mode===MODE.SERIES_TIME)?'pill on':'pill off';
  pillTime.className=(mode===MODE.PLACE)?'pill on lock':(mode===MODE.SERIES_TIME?'pill on':'pill off');
}

function teamNode(name, clubList, isHome){
  const wrapper = document.createElement('div');
  wrapper.className = 'team ' + (isHome?'home':'away');
  const path = logoFor(name, clubList);

  if(isHome){
    const nameSpan = document.createElement('span');
    nameSpan.className='team-name';
    nameSpan.textContent = name;
    wrapper.appendChild(nameSpan);
    if(path){
      const img = document.createElement('img');
      img.className='team-logo';
      img.src = path;
      img.alt = name;
      wrapper.appendChild(img);
    }else{
      const fb = document.createElement('div');
      fb.className='logo-fallback';
      fb.textContent = initials(name);
      wrapper.appendChild(fb);
    }
  }else{
    if(path){
      const img = document.createElement('img');
      img.className='team-logo';
      img.src = path;
      img.alt = name;
      wrapper.appendChild(img);
    }else{
      const fb = document.createElement('div');
      fb.className='logo-fallback';
      fb.textContent = initials(name);
      wrapper.appendChild(fb);
    }
    const nameSpan = document.createElement('span');
    nameSpan.className='team-name';
    nameSpan.textContent = name;
    wrapper.appendChild(nameSpan);
  }
  return wrapper;
}

function gameCard(g, seriesMode=false){
  const art = document.createElement('article');
  art.className='game';
  art.dataset.arena = g.arena;

  // top row
  const top=document.createElement('div'); top.className='game-top';
  if(seriesMode){
    const seriesAnchor = g.link_to_series ? `<a href="${g.link_to_series}" target="_blank" rel="noopener">${g.series_name}</a>` : `${g.series_name}`;
    top.innerHTML =
      `<div class="game-time">${g.time}</div>`+
      `<div class="game-series">${seriesAnchor}</div>`+
      `<div class="game-mid">${g.arena}</div>`+
      `<div class="game-right">Avst ${kmRound(g.distance_km)} km</div>`;
  }else{
    const seriesAnchor = g.link_to_series ? `<a href="${g.link_to_series}" target="_blank" rel="noopener">${g.series_name}</a>` : `${g.series_name}`;
    top.innerHTML =
      `<div class="game-time">${g.time}</div>`+
      `<div class="game-series">${seriesAnchor}</div>`;
  }

  // bottom row
  const bottom=document.createElement('div'); bottom.className='game-bottom';
  const home = teamNode(g.home_team, g.home_club_list, true);

  const res = document.createElement('div'); res.className='result';
  const hasLink = !!g.result_link && g.result && g.result.trim() !== '‚Äì';
  if(hasLink){
    const a=document.createElement('a');
    a.href = fullMatchUrl(g.result_link);
    a.target = '_blank';
    a.rel = 'noopener';
    a.textContent = g.result;
    res.appendChild(a);
  }else{
    res.classList.add('no-link');
    res.textContent = g.result || '‚Äì';
  }

  const away = teamNode(g.away_team, g.away_club_list, false);

  bottom.appendChild(home);
  bottom.appendChild(res);
  bottom.appendChild(away);

  art.appendChild(top);
  art.appendChild(bottom);
  return art;
}

/* ================== DATABEHANDLING ================== */
function filterGamesForCurrentDate(){
  const sel = dateToYYYYMMDD(currentDate);
  games = gamesAll.filter(g => (g.date || '').trim() === sel);
}

/* ================== RENDER MODES ================== */
function renderPlace(){
  scroll.innerHTML='';
  scroll.setAttribute('aria-busy','true');
  slot.style.display='flex';

  // group by arena
  const byArena = new Map();
  games.forEach(g=>{
    if(!byArena.has(g.arena)) byArena.set(g.arena, []);
    byArena.get(g.arena).push(g);
  });

  // sort arenas by distance (first game's distance used as proxy)
  const arenas = [...byArena.keys()].sort((a,b)=>{
    const da = (byArena.get(a)[0]?.distance_km ?? Infinity);
    const db = (byArena.get(b)[0]?.distance_km ?? Infinity);
    return da - db;
  });

  arenaOrder = arenas;
  currentArena = arenaOrder[0] || null;

  if(currentArena){
    const d = byArena.get(currentArena)[0]?.distance_km ?? Infinity;
    slot.querySelector('.group-title').textContent = currentArena;
    slot.querySelector('.group-sub').textContent = `Avst ${kmRound(d)} km`;
  }else{
    slot.querySelector('.group-title').textContent = 'Inga arenor';
    slot.querySelector('.group-sub').textContent = '‚Äî';
  }

  arenas.forEach((name, idx)=>{
    if(idx>0){
      const div = document.createElement('div'); div.className='divider'; scroll.appendChild(div);
    }
    const hdr = document.createElement('div');
    hdr.className='arena-header';
    hdr.dataset.arenaHeader=name;
    const d = byArena.get(name)[0]?.distance_km ?? Infinity;
    hdr.innerHTML = `<div>${name}</div><div>Avst ${kmRound(d)} km</div>`;
    if(idx===0) hdr.classList.add('active-hidden');
    scroll.appendChild(hdr);

    byArena.get(name)
      .sort((a,b)=> parseTime(a.time)-parseTime(b.time))
      .forEach(g=> scroll.appendChild(gameCard(g,false)));
  });

  lastScrollTop = scroll.scrollTop;
  updateStickyArena(true);
  scroll.removeAttribute('aria-busy');
}

function renderSeries(seriesTime=false){
  scroll.innerHTML='';
  scroll.setAttribute('aria-busy','true');
  slot.style.display='none';

  const list = [...games];

  if(seriesTime){
    // time -> series(prio)
    list.sort((a,b)=> parseTime(a.time)-parseTime(b.time) ||
                     seriesPriority(a.series_name)-seriesPriority(b.series_name) ||
                     a.series_name.localeCompare(b.series_name,'sv'));
  }else{
    // series(prio) -> time
    list.sort((a,b)=> seriesPriority(a.series_name)-seriesPriority(b.series_name) ||
                     parseTime(a.time)-parseTime(b.time) ||
                     a.series_name.localeCompare(b.series_name,'sv'));
  }

  if(seriesTime){
    list.forEach(g=> scroll.appendChild(gameCard(g, true)));
  }else{
    // divider n√§r serie byts
    let prev=null;
    list.forEach(g=>{
      if(prev && prev.series_name !== g.series_name){
        const d = document.createElement('div'); d.className='series-divider'; scroll.appendChild(d);
      }
      scroll.appendChild(gameCard(g,true));
      prev=g;
    });
  }
  scroll.removeAttribute('aria-busy');
}

/* ================== STICKY LOGIK (PLATS) ================== */
function updateStickyArena(force=false){
  if(mode!==MODE.PLACE || !arenaOrder.length) return;
  const st = scroll.scrollTop;
  const dir = (st>lastScrollTop)?'down':(st<lastScrollTop?'up':'none');
  lastScrollTop=st;

  const stickyBottom = slot.getBoundingClientRect().bottom;
  const idx = arenaOrder.indexOf(currentArena);

  // Ned√•t: byt n√§r n√§sta header √§r t√§ckt ‚â• 50%
  if(dir==='down' && idx>=0 && idx<arenaOrder.length-1){
    const nh=document.querySelector(`.arena-header[data-arena-header="${arenaOrder[idx+1]}"]`);
    if(nh){
      const r=nh.getBoundingClientRect();
      const covered = Math.max(0, stickyBottom - r.top);
      if(covered >= r.height*0.5){
        currentArena = arenaOrder[idx+1];
      }
    }
  }
  // Upp√•t: byt n√§r nuvarande header √§r helt synlig (iOS extra marginal)
  if(dir==='up' && idx>0){
    const currHdr=document.querySelector(`.arena-header[data-arena-header="${arenaOrder[idx]}"]`);
    if(currHdr){
      const r=currHdr.getBoundingClientRect();
      const isIOS=/iPhone|iPad|iPod/i.test(navigator.userAgent);
      const extra=isIOS?26:0;
      if(r.top >= stickyBottom + extra){
        currentArena = arenaOrder[idx-1];
      }
    }
  }

  if(force || currentArena){
    slot.querySelector('.group-title').textContent = currentArena || '‚Äî';
    const firstGame = games.find(g=>g.arena===currentArena);
    const d = firstGame? kmRound(firstGame.distance_km) : '‚Äî';
    slot.querySelector('.group-sub').textContent = currentArena ? `Avst ${d} km` : '‚Äî';
    arenaOrder.forEach(name=>{
      const h=document.querySelector(`.arena-header[data-arena-header="${name}"]`);
      if(h) h.classList.toggle('active-hidden', name===currentArena);
    });
  }
}

/* ================== EVENTS ================== */
pillPlace.onclick = ()=>{ mode=MODE.PLACE; applyPills(); renderPlace(); };
pillSeries.onclick= ()=>{ mode=MODE.SERIES; applyPills(); renderSeries(false); };
pillTime.onclick  = ()=>{
  if(mode===MODE.PLACE) return; // l√•st i plats-vy
  mode = (mode===MODE.SERIES) ? MODE.SERIES_TIME : MODE.SERIES;
  applyPills();
  renderSeries(mode===MODE.SERIES_TIME);
};
scroll.addEventListener('scroll', ()=> updateStickyArena(false));

btnPrev.onclick = ()=>{ currentDate.setDate(currentDate.getDate()-1); onDateChanged(); };
btnNext.onclick = ()=>{ currentDate.setDate(currentDate.getDate()+1); onDateChanged(); };
btnHome.onclick = ()=>{ currentDate = new Date(today); mode=MODE.PLACE; applyPills(); onDateChanged(); };

/* ================== DATE & RENDER PIPELINE ================== */
function onDateChanged(){
  updateDateHeader();
  filterGamesForCurrentDate();
  if(mode===MODE.PLACE) renderPlace();
  else renderSeries(mode===MODE.SERIES_TIME);
}

/* ================== INIT ================== */
(async function init(){
  updateDateHeader();
  applyPills();
  try{
    // Logos
    const mapText = await fetch(DATA_PATH.logosMap, {cache:'no-store'}).then(r=>r.text());
    logoMap = parseLogosMap(mapText);
  }catch(e){
    console.warn('Kunde inte l√§sa logos-map:', e);
    logoMap = {};
  }
  try{
    // Games (alla datum)
    const csvText = await fetch(DATA_PATH.games, {cache:'no-store'}).then(r=>r.text());
    gamesAll = parseGamesCSV(csvText);
  }catch(e){
    console.error('Kunde inte l√§sa games.csv:', e);
    gamesAll = [];
  }
  filterGamesForCurrentDate();
  renderPlace();
})();
</script>

</body>
</html>

