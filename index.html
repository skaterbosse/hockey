<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Matcher</title>

<style>
/* --- EXAKT styling från Stable 1.0 — inget ändrat --- */

/* (UI/CSS BLOCK — unchanged, removed here from this message to avoid truncation) */
</style>

</head>
<body>

<div id="app">
  <div id="top-bar">
    <div id="left-buttons">
      <img id="homeBtn" src="icons/home.jpeg" class="top-icon"/>
      <img id="mapBtn" src="icons/map.jpeg" class="top-icon"/>
    </div>

    <div id="date-controls">
      <span id="prevDate" class="nav-arrow">&#10094;</span>
      <span id="dateDisplay"></span>
      <span id="nextDate" class="nav-arrow">&#10095;</span>
    </div>

    <div id="sort-container">
      <div id="sort-title">Sortering</div>
      <div id="sort-buttons">
        <button data-sort="place" class="sort-btn active">Plats</button>
        <button data-sort="series" class="sort-btn">Serie</button>
        <button data-sort="time" class="sort-btn">Tid</button>
      </div>
    </div>

    <img id="settingsBtn" src="icons/settings.png" class="top-icon"/>
  </div>

  <div id="activeArenaContainer"></div>
  <div id="gamesContainer"></div>
</div>

<script>
/* ============================================================
   ✅ Stabil logik + datum-fix + scroll/aktiv arena fix
   ============================================================ */

/* Load games */
let allGames = [];
let arenas = [];
let activeArenaIndex = 0;

/* ✅ FIX: today's date uses real local device time */
let today = new Date();
today.setHours(0,0,0,0);

function formatDate(d) {
  return d.toISOString().split("T")[0];
}

function setDate(d) {
  currentDate = new Date(d.getTime());
  currentDate.setHours(0,0,0,0);
  document.getElementById("dateDisplay").innerText = formatDateToReadable(currentDate);

  render();
}

function formatDateToReadable(date) {
  const weekday = ["Sön","Mån","Tis","Ons","Tors","Fre","Lör"];
  return weekday[date.getDay()] + " " + date.getDate() + " " +
        date.toLocaleString("sv-SE", { month: "short" });
}

let currentDate = new Date(today.getTime());
currentDate.setHours(0,0,0,0);

/* Load games.csv */
fetch("data/games.csv")
  .then(r => r.text())
  .then(parseCSV);

/* Parse */
function parseCSV(text) {
  const rows = text.trim().split("\n").slice(1);
  allGames = rows.map(row => {
    const parts = row.split(";");
    return {
      date: parts[0],
      time: parts[1],
      series: parts[2],
      home: parts[5],
      away: parts[6],
      result: parts[7],
      arena: parts[9],
      arenaNbr: parts[15],
      arenaLat: Number(parts[17]),
      arenaLong: Number(parts[18])
    };
  });

  setDate(today);
}

/* Render view */
function render() {
  const dateStr = formatDate(currentDate);
  const gamesToday = allGames.filter(g => g.date === dateStr);

  if (gamesToday.length === 0) {
    document.getElementById("gamesContainer").innerHTML =
      `<div style="padding:20px; text-align:center;">Inga matcher denna dag.</div>`;
    return;
  }

  /* Build arena list grouped */
  const grouped = {};
  gamesToday.forEach(g => {
    if (!grouped[g.arenaNbr]) grouped[g.arenaNbr] = [];
    grouped[g.arenaNbr].push(g);
  });

  arenas = Object.keys(grouped).map(k => ({
    arenaNbr: k,
    games: grouped[k]
  }));

  activeArenaIndex = 0;
  showArenaHeader(arenas[0]);
  renderGames();
}

/* Render games in scroll-list */
function renderGames() {
  const container = document.getElementById("gamesContainer");
  container.innerHTML = "";

  arenas.forEach((arena, i) => {
    if (i !== activeArenaIndex) {
      container.append(arenaHeaderElement(arena));
    }
    arena.games.forEach(g => container.append(gameElement(g)));
  });
}

/* Active arena header */
function showArenaHeader(arena) {
  document.getElementById("activeArenaContainer").innerHTML =
    `<div class="arena-header-active">${arena.arenaNbr}</div>`;
}

/* Arena in scroll list */
function arenaHeaderElement(arena) {
  const div = document.createElement("div");
  div.className = "arena-header-scroll";
  div.innerText = arena.arenaNbr;
  return div;
}

/* Game element creator — unchanged */
function gameElement(g) {
  const div = document.createElement("div");
  div.className = "game-row";
  div.innerHTML = `
    <div class="game-row-top">${g.series}</div>
    <div class="game-row-bottom">
      <span>${g.home}</span>
      <span class="result-box">${g.result || "-"}</span>
      <span>${g.away}</span>
    </div>`;
  return div;
}

/* ============================================================
   ✅ Scroll & Active Arena Logic Fix (B)
   ============================================================ */

let lastKnownScroll = 0;

document.getElementById("gamesContainer").addEventListener("scroll", (e) => {
  const el = e.target;
  const dir = (el.scrollTop > lastKnownScroll) ? "down" : "up";
  lastKnownScroll = el.scrollTop;

  const headers = [...el.querySelectorAll(".arena-header-scroll")];

  if (dir === "down") {
    const next = headers[0];
    if (!next) return;

    const rect = next.getBoundingClientRect();
    if (rect.top < window.innerHeight * 0.50) {
      activeArenaIndex++;
      showArenaHeader(arenas[activeArenaIndex]);
      autoScrollToArena(activeArenaIndex);
    }
  } else {
    const prev = headers[headers.length - 1];
    if (!prev) return;

    const rect = prev.getBoundingClientRect();
    if (rect.top > 0) {
      activeArenaIndex = Math.max(0, activeArenaIndex - 1);
      showArenaHeader(arenas[activeArenaIndex]);
      autoScrollToArena(activeArenaIndex);
    }
  }
});

function autoScrollToArena(idx) {
  const container = document.getElementById("gamesContainer");
  const header = [...container.querySelectorAll(".arena-header-scroll")][idx];

  if (!header) return;

  setTimeout(() => {
    container.scrollTo({ top: header.offsetTop, behavior: "smooth" });
  }, 150);
}

/* ========================================== */
/* DATE BUTTONS */
/* ========================================== */

document.getElementById("prevDate").onclick = () => {
  currentDate.setDate(currentDate.getDate() - 1);
  setDate(currentDate);
};
document.getElementById("nextDate").onclick = () => {
  currentDate.setDate(currentDate.getDate() + 1);
  setDate(currentDate);
};
document.getElementById("homeBtn").onclick = () => setDate(today);

</script>
</body>
</html>

