<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="mobile-web-app-capable" content="yes" />
<title>LocalSport</title>

<style>
:root{
  --topbar-h:56px;
  --hint-h:26px;
  --slot-h:42px;
  --bg:#f0f3f8;
  --hair:#e2e8f0;
  --text:#0f172a;
  --muted:#64748b;
  --accent:#16a34a;
  --link:#2563eb;
}

/* Base */
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,Roboto,Arial,sans-serif;color:var(--text);overscroll-behavior:none;}
.device{width:100%;height:100dvh;display:flex;flex-direction:column;overflow:hidden;}

/* Top bar */
.topbar{position:sticky;top:0;z-index:500;background:#fff;border-bottom:1px solid var(--hair);}
.topbar-inner{
  display:grid;
  grid-template-columns:1fr auto 1fr;
  align-items:center;
  height:var(--topbar-h);
  padding:6px;
}
.cluster-left,.cluster-right{display:flex;gap:8px;align-items:center;}
.cluster-center{
  display:flex;align-items:center;justify-content:center;gap:8px;
  transform:translateX(-8px); /* flytta lite vänster så paketet centreras visuellt mellan kartikon och sortering */
}
.icon-btn{width:32px;height:32px;border-radius:8px;border:1px solid var(--hair);background:#f1f5f9;display:grid;place-items:center;cursor:pointer;}
.icon-img{width:18px;height:18px;object-fit:contain;}

.nav-btn{width:32px;height:32px;border-radius:8px;border:1px solid var(--hair);background:#f1f5f9;display:grid;place-items:center;cursor:pointer;font-size:16px;font-weight:700;line-height:1;}
.nav-btn.active{color:var(--accent);}
.nav-btn.inactive{color:#94a3b8;opacity:.7;cursor:not-allowed;}

.date-block{display:flex;flex-direction:column;align-items:center;font-weight:700;font-size:13.5px;line-height:1.1;}

/* Sortering */
.sort-stack{border:1px solid var(--hair);border-radius:10px;background:#fff;padding:4px 6px;display:flex;flex-direction:column;align-items:center;}
.sort-top{font-size:12px;font-weight:600;margin-bottom:2px;}
.sort-bottom{display:flex;gap:4px;}
.pill{padding:4px 8px;font-size:11px;border-radius:999px;font-weight:600;border:1px solid var(--hair);cursor:pointer;user-select:none;}
.pill.on{background:#dcfce7;border-color:#86efac;color:var(--accent);}
.pill.off{background:#f1f5f9;border-color:#cbd5e1;color:#94a3b8;}
.pill.lock{opacity:.6;cursor:not-allowed;}

/* Hint */
.hint{position:sticky;top:var(--topbar-h);height:var(--hint-h);background:#fff;border-bottom:1px solid var(--hair);text-align:center;font-size:12px;line-height:var(--hint-h);color:var(--muted);z-index:450;}

/* Sticky arena slot — exakt samma stil som arena-header i listan */
.group-slot{
  position:sticky;top:calc(var(--topbar-h) + var(--hint-h));
  height:var(--slot-h);
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 12px;font-size:14px;font-weight:700;background:#fff;z-index:425;
}

/* Scroll */
.scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;background:var(--bg);}

/* Arena header (i scroll-listan) */
.arena-header{padding:10px 12px;background:#fff;font-weight:700;display:flex;justify-content:space-between;border-top:1px solid var(--hair);}
.arena-header:first-child{border-top:none;}
.arena-header.active-hidden{visibility:hidden;height:0;padding:0;margin:0;border:none;}

/* Game card */
.game{background:#fff;border-top:1px solid var(--hair);padding:6px 10px;display:grid;gap:4px;}
.game-top{display:flex;align-items:center;gap:8px;justify-content:space-between;}
.game-bottom{display:grid;grid-template-columns:60px 1fr auto auto auto 1fr;align-items:center;column-gap:6px;} /* fast tid 60px */

/* text atoms */
.time{font-size:12px;font-weight:700;color:#0f172a;white-space:nowrap;overflow:hidden;}
.series{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:clip;}
.series a{text-decoration:none;color:var(--link);}
.series.nolink{color:#0f172a;}
.top-left{min-width:0;flex:1;}
.top-mid{min-width:0;text-align:center;flex:1;}
.top-right{white-space:nowrap;color:var(--muted);font-size:12px;}

/* Teams */
.team-name{white-space:nowrap;overflow:hidden;text-overflow:clip;font-size:13px;font-weight:600;}
.team-name.home{text-align:right;padding-right:4px;}
.team-name.away{text-align:left;padding-left:4px;}

/* Logos */
.team-logo{width:28px;height:28px;object-fit:contain;display:block;background:none;}
.logo-fallback{width:28px;height:28px;display:grid;place-items:center;font-size:11px;font-weight:700;color:#475569;background:#e2e8f0;border-radius:4px;}

/* Result box – smal fast bredd, jämn paddning */
.result-box{width:52px;min-width:52px;max-width:52px;padding:1px 4px;border-radius:8px;border:1px solid var(--hair);background:#f1f5f9;text-align:center;font-weight:700;white-space:nowrap;}
.result-box .link{color:var(--link);text-decoration:none;display:inline-block;max-width:100%;overflow:hidden;}
.result-box .nolink{color:#0f172a;display:inline-block;max-width:100%;overflow:hidden;}

/* helpers: truncation with single '.' */
.trunc-one{white-space:nowrap;overflow:hidden;}
.debug-shrunk{ /* off by default; kept if you ever want to wire up debug=1 */ }

/* larger screens – lite större box/logga */
@media (min-width:768px){
  .game-bottom{grid-template-columns:64px 1fr auto auto auto 1fr;}
  .result-box{width:56px;min-width:56px;max-width:56px;}
  .team-logo{width:30px;height:30px;}
}
</style>
</head>
<body>
<div class="device">

<header class="topbar">
  <div class="topbar-inner">
    <div class="cluster-left">
      <button class="icon-btn" id="goHome" title="Start"><img class="icon-img" src="icons/home.jpeg" alt="Home"></button>
      <button class="icon-btn" id="openMap" title="Karta"><img class="icon-img" src="icons/map.jpeg" alt="Map"></button>
    </div>

    <div class="cluster-center">
      <button class="nav-btn inactive" id="prevDate" title="Föregående">◀</button>
      <div class="date-block" id="dateLabel"></div>
      <button class="nav-btn inactive" id="nextDate" title="Nästa">▶</button>
    </div>

    <div class="cluster-right">
      <div class="sort-stack">
        <div class="sort-top">Sortering</div>
        <div class="sort-bottom">
          <span id="pillPlace" class="pill on">Plats</span>
          <span id="pillSeries" class="pill off">Serie</span>
          <span id="pillTime" class="pill on lock">Tid</span>
        </div>
      </div>
      <button class="icon-btn" title="Inställningar">⚙️</button>
    </div>
  </div>
</header>

<div class="hint" id="hintField">Visar matcher nära: Kruniusvägen 1, Billdal</div>

<!-- sticky, identisk med lista -->
<div id="groupSlot" class="group-slot"><div class="group-title">—</div><div class="group-sub">—</div></div>

<main id="scrollArea" class="scroll"></main>

<script>
/* ================== STATE & CONFIG ================== */
const MODE={PLACE:"place",SERIES:"series",SERIES_TIME:"series_time"};
let mode=MODE.PLACE;
let ALL_GAMES=[], LOGO_MAP={};
let currentDate=new Date().toISOString().slice(0,10);

// user fixed position (Billdal)
const USER_POS={lat:57.590214281624824, lon:11.94608216084837};

// elements
const dateLabel=document.getElementById("dateLabel");
const prevBtn=document.getElementById("prevDate");
const nextBtn=document.getElementById("nextDate");
const pillPlace=document.getElementById("pillPlace");
const pillSeries=document.getElementById("pillSeries");
const pillTime=document.getElementById("pillTime");
const goHome=document.getElementById("goHome");
const openMap=document.getElementById("openMap");
const scrollArea=document.getElementById("scrollArea");
const groupSlot=document.getElementById("groupSlot");

/* ================== HELPERS ================== */
function fmtDateParts(iso){
  const d=new Date(iso+"T00:00:00");
  const today=new Date().toISOString().slice(0,10);
  const isToday=(iso===today);
  const w=d.toLocaleDateString("sv-SE",{weekday:"short"});
  const day=d.toLocaleDateString("sv-SE",{day:"numeric"});
  const mon=d.toLocaleDateString("sv-SE",{month:"short"});
  return { line1:isToday?"Idag":"", line2:w.charAt(0).toUpperCase()+w.slice(1), line3:`${day} ${mon}` };
}
function updateDateLabel(){
  const p=fmtDateParts(currentDate);
  dateLabel.innerHTML=`${p.line1?`<span>${p.line1}</span>`:""}<span>${p.line2}</span><span>${p.line3}</span>`;
}
function datePlus(iso,delta){const d=new Date(iso); d.setDate(d.getDate()+delta); return d.toISOString().slice(0,10);}
function hasGamesOn(iso){return ALL_GAMES.some(g=>g.date===iso);}
function updateNavButtons(){
  const prev=datePlus(currentDate,-1), next=datePlus(currentDate,1);
  if(hasGamesOn(prev)){prevBtn.classList.add("active");prevBtn.classList.remove("inactive");} else {prevBtn.classList.remove("active");prevBtn.classList.add("inactive");}
  if(hasGamesOn(next)){nextBtn.classList.add("active");nextBtn.classList.remove("inactive");} else {nextBtn.classList.remove("active");nextBtn.classList.add("inactive");}
}

function km2(a,b){
  const R=6371;
  const dLat=(b.lat-a.lat)*Math.PI/180;
  const dLon=(b.lon-a.lon)*Math.PI/180;
  const la=a.lat*Math.PI/180, lb=b.lat*Math.PI/180;
  const x=Math.sin(dLat/2)**2 + Math.sin(dLon/2)**2*Math.cos(la)*Math.cos(lb);
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}
function distKm(lat,long){
  if(!lat||!long) return null;
  const d=km2(USER_POS,{lat:parseFloat(lat),lon:parseFloat(long)});
  return Math.round(d);
}
function applyTruncate(text,max){
  if(!text) return "";
  if(text.length<=max) return text;
  return text.slice(0,max)+".";
}
function shrinkToFit(el,minPx=10,step=0.5){
  el.style.fontSize="";
  let size=parseFloat(getComputedStyle(el).fontSize);
  for(let i=0;i<40;i++){
    if(el.scrollWidth<=el.clientWidth) break;
    size-=step; if(size<minPx){size=minPx;break;}
    el.style.fontSize=size+"px";
  }
}
function shrinkTextToWidth(el, targetPx){
  el.style.display="inline-block";
  el.style.maxWidth=targetPx+"px";
  shrinkToFit(el,9,0.5);
}

/* ================== DATA LOAD ================== */
Promise.all([
  fetch("data/Clubs_Organisatons_logos__ClubOrgName_LogoFileName.txt").then(r=>r.text()),
  fetch("data/games.csv").then(r=>r.text())
]).then(([logosTxt,gamesCsv])=>{
  logosTxt.split("\n").forEach(line=>{
    if(!line.trim()) return;
    const [club,file]=line.split(";");
    if(club&&file) LOGO_MAP[club.trim()]="logos/"+file.trim();
  });

  gamesCsv.split("\n").forEach(row=>{
    if(!row.trim()) return;
    const c=row.split(";");
    if(c.length<19) return;
    ALL_GAMES.push({
      date:c[0], time:c[1], series_name:c[2], link_to_series:c[3], admin_host:c[4],
      home_team:c[5], away_team:c[6], result:c[7], result_link:c[8],
      arena:c[9], status:c[10], iteration_fetched:c[11], iterations_total:c[12],
      home_club_list:c[13], away_club_list:c[14], arena_nbr:c[15],
      preferedName:c[16], lat:c[17], long:c[18]
    });
  });
  render();
});

/* ================== SORT PILLS & NAV ================== */
function applyPills(){
  pillPlace.className=(mode===MODE.PLACE)?"pill on":"pill off";
  pillSeries.className=(mode===MODE.SERIES||mode===MODE.SERIES_TIME)?"pill on":"pill off";
  pillTime.className=(mode===MODE.PLACE)?"pill on lock":(mode===MODE.SERIES_TIME?"pill on":"pill off");
}
pillPlace.onclick=()=>{mode=MODE.PLACE;applyPills();render();};
pillSeries.onclick=()=>{mode=MODE.SERIES;applyPills();render();};
pillTime.onclick=()=>{if(mode!==MODE.PLACE){mode=(mode===MODE.SERIES)?MODE.SERIES_TIME:MODE.SERIES;applyPills();render();}};
goHome.onclick=()=>{currentDate=new Date().toISOString().slice(0,10);mode=MODE.PLACE;applyPills();render();};
openMap.onclick=()=>{};
prevBtn.onclick=()=>{currentDate=datePlus(currentDate,-1);render();};
nextBtn.onclick=()=>{currentDate=datePlus(currentDate, 1);render();};

/* ================== RENDER ROOT ================== */
function render(){
  updateDateLabel();
  applyPills();
  updateNavButtons();

  const games=ALL_GAMES.filter(g=>g.date===currentDate);
  scrollArea.innerHTML="";

  if(!games.length){
    groupSlot.querySelector(".group-title").textContent="—";
    groupSlot.querySelector(".group-sub").textContent="—";
    scrollArea.innerHTML=`<div style="padding:16px;background:#fff;border-top:1px solid var(--hair);">Inga matcher denna dag.</div>`;
    return;
  }

  if(mode===MODE.PLACE) renderPlaceView(games);
  else renderSeriesView(games);
}

/* ================== PLACE VIEW ================== */
function renderPlaceView(games){
  const byArena={};
  games.forEach(g=>{
    const a=(g.preferedName||g.arena||"Okänd arena").trim();
    (byArena[a] ||= []).push(g);
  });

  // sort arenas by distance (closest first). Take lat/long from first game in the group
  const arenas=Object.keys(byArena).map(name=>{
    const any=byArena[name][0];
    const d=distKm(any.lat, any.long);
    return {name,d,lat:any.lat,long:any.long};
  }).sort((a,b)=> (a.d??1e9)-(b.d??1e9));

  // sticky slot initial (only arenas with games)
  if(arenas.length){
    const a=arenas[0];
    groupSlot.querySelector(".group-title").textContent=a.name;
    groupSlot.querySelector(".group-sub").textContent = (a.d!=null)?`Avst ${a.d} km`:"Avst —";
  }

  // build list: header + games (time order)
  arenas.forEach(a=>{
    const hdr=document.createElement("div");
    hdr.className="arena-header";
    hdr.dataset.arenaHeader=a.name;
    hdr.innerHTML=`<div>${a.name}</div><div class="top-right">${a.d!=null ? `Avst ${a.d} km` : 'Avst —'}</div>`;
    scrollArea.appendChild(hdr);

    byArena[a.name].sort((x,y)=>x.time.localeCompare(y.time)).forEach(g=>{
      scrollArea.appendChild(buildGameCard(g,false, a.d));
    });
  });

  // sticky behavior: switch when active arena has no games >=25% visible
  applyPlaceSticky(arenas.map(a=>a.name));
}

function applyPlaceSticky(arenaNames){
  let current=arenaNames[0]||null;
  const VIEW_TOP = ()=> groupSlot.getBoundingClientRect().bottom;
  const VIEW_BOTTOM = ()=> window.innerHeight;

  function arenaGamesVisibleRatio(name){
    const games=[...scrollArea.querySelectorAll(`article.game[data-arena="${CSS.escape(name)}"]`)];
    let maxRatio=0;
    const top=VIEW_TOP(), bottom=VIEW_BOTTOM();
    games.forEach(el=>{
      const r=el.getBoundingClientRect();
      const vis=Math.max(0, Math.min(bottom,r.bottom) - Math.max(top,r.top));
      const ratio=vis/Math.max(1,(r.height));
      if(ratio>maxRatio) maxRatio=ratio;
    });
    return maxRatio; // 0..1
  }

  function onScroll(){
    // hide only active header
    arenaNames.forEach(n=>{
      const hdr=scrollArea.querySelector(`.arena-header[data-arena-header="${CSS.escape(n)}"]`);
      if(hdr) hdr.classList.toggle("active-hidden", n===current);
    });

    const idx=arenaNames.indexOf(current);
    if(idx<0) return;

    // if current has no sufficiently visible games → advance to next if any (down) or prev (up)
    const currRatio=arenaGamesVisibleRatio(current);

    // decide direction by looking at next header position vs sticky bottom
    const sb=VIEW_TOP();
    let dir="down";
    if(idx>0){
      const prevHdr=scrollArea.querySelector(`.arena-header[data-arena-header="${CSS.escape(arenaNames[idx-1])}"]`);
      if(prevHdr && prevHdr.getBoundingClientRect().top>=sb) dir="up";
    }

    if(currRatio < 0.25){ // less than 25% visible → switch
      if(dir==="down" && idx<arenaNames.length-1) current=arenaNames[idx+1];
      else if(dir==="up" && idx>0) current=arenaNames[idx-1];
    }else{
      // also allow forward switch when next header is ≥50% covered
      if(idx<arenaNames.length-1){
        const nextHdr=scrollArea.querySelector(`.arena-header[data-arena-header="${CSS.escape(arenaNames[idx+1])}"]`);
        const r=nextHdr.getBoundingClientRect();
        if(r.top<sb && (sb-r.top)>=r.height*0.5) current=arenaNames[idx+1];
      }
    }

    // update sticky label
    const activeHdr=scrollArea.querySelector(`.arena-header[data-arena-header="${CSS.escape(current)}"]`);
    const right=activeHdr?.querySelector(".top-right")?.textContent || "Avst —";
    groupSlot.querySelector(".group-title").textContent=current||"—";
    groupSlot.querySelector(".group-sub").textContent=right;
  }

  scrollArea.removeEventListener("scroll", onScroll);
  scrollArea.addEventListener("scroll", onScroll, {passive:true});
  onScroll();
}

/* ================== SERIES VIEW ================== */
function renderSeriesView(games){
  // sort: series then time (or time then series)
  const sorted=[...games].sort((a,b)=>{
    if(mode===MODE.SERIES_TIME) return a.time.localeCompare(b.time) || a.series_name.localeCompare(b.series_name);
    return a.series_name.localeCompare(b.series_name) || a.time.localeCompare(b.time);
  });

  // sticky slot not used
  groupSlot.querySelector(".group-title").textContent="—";
  groupSlot.querySelector(".group-sub").textContent="—";

  sorted.forEach(g=>{
    const d = distKm(g.lat,g.long);
    scrollArea.appendChild(buildGameCard(g,true,d));
  });
}

/* ================== CARD BUILDER ================== */
function firstClubName(list){ if(!list) return null; return list.split(",")[0]?.trim()||null; }
function mapLogo(list){ const c=firstClubName(list); return c? LOGO_MAP[c]||null : null; }

const LOGO_CACHE={};
function loadAndTrimLogo(url){
  if(!url) return Promise.resolve(null);
  if(LOGO_CACHE[url]) return Promise.resolve(LOGO_CACHE[url]);
  return new Promise(res=>{
    const img=new Image(); img.crossOrigin="anonymous";
    img.onload=()=>{
      const w=img.width,h=img.height;
      const cv=document.createElement("canvas"), cx=cv.getContext("2d");
      cv.width=w; cv.height=h; cx.drawImage(img,0,0);
      const id=cx.getImageData(0,0,w,h); const d=id.data;
      let minX=w,minY=h,maxX=0,maxY=0,found=false;
      const isBg=(r,g,b,a)=> (a===0) || (r>245&&g>245&&b>245&&a>240);
      for(let y=0;y<h;y++){
        for(let x=0;x<w;x++){
          const i=(y*w+x)*4, r=d[i],g=d[i+1],b=d[i+2],a=d[i+3];
          if(!isBg(r,g,b,a)){found=true; if(x<minX)minX=x; if(y<minY)minY=y; if(x>maxX)maxX=x; if(y>maxY)maxY=y;}
        }
      }
      if(!found){ LOGO_CACHE[url]=url; return res(url); }
      const tw=maxX-minX+1, th=maxY-minY+1;
      const out=document.createElement("canvas"); out.width=tw; out.height=th;
      out.getContext("2d").drawImage(cv,minX,minY,tw,th,0,0,tw,th);
      const dataUrl=out.toDataURL("image/png");
      LOGO_CACHE[url]=dataUrl; res(dataUrl);
    };
    img.onerror=()=>res(null);
    img.src=url;
  });
}

function buildGameCard(g, isSeries, distOverrideKm){
  const card=document.createElement("article"); card.className="game";

  /* --------- TOP ROW --------- */
  const top=document.createElement("div"); top.className="game-top";
  if(isSeries){
    const left=document.createElement("div");
    left.className="top-left series trunc-one";
    const serText=applyTruncate(g.series_name||"",30);
    if(g.link_to_series){ left.innerHTML=`<a href="${g.link_to_series}" target="_blank" rel="noopener">${serText}</a>`; }
    else { left.classList.add("nolink"); left.textContent=serText; }
    top.appendChild(left);

    const mid=document.createElement("div");
    mid.className="top-mid trunc-one";
    const arenaName=applyTruncate((g.preferedName||g.arena||"Okänd arena").trim(),25);
    mid.textContent=arenaName;
    top.appendChild(mid);

    const right=document.createElement("div"); right.className="top-right";
    const d = (distOverrideKm!=null?distOverrideKm:distKm(g.lat,g.long));
    right.textContent = (d!=null)?`Avst ${d} km`:"Avst —";
    top.appendChild(right);
  }else{
    const leftWrap=document.createElement("div");
    leftWrap.style.display="flex"; leftWrap.style.gap="8px"; leftWrap.style.alignItems="center"; leftWrap.style.minWidth="0";

    const ser=document.createElement("div"); ser.className="series trunc-one";
    const serText=applyTruncate(g.series_name||"",50);
    if(g.link_to_series){ ser.innerHTML=`<a href="${g.link_to_series}" target="_blank" rel="noopener">${serText}</a>`; }
    else { ser.classList.add("nolink"); ser.textContent=serText; }
    leftWrap.appendChild(ser);

    const spacer=document.createElement("div"); spacer.style.flex="1";
    top.appendChild(leftWrap); top.appendChild(spacer);
  }
  card.appendChild(top);

  /* --------- BOTTOM ROW --------- */
  const bot=document.createElement("div"); bot.className="game-bottom";

  // TIME (fixed width, shrink including "Postponed")
  const t=document.createElement("div"); t.className="time";
  t.textContent = (g.status && g.status.toLowerCase().includes("postponed")) ? "Postponed" : (g.time||"");
  bot.appendChild(t);

  // HOME NAME
  const homeName=document.createElement("div"); homeName.className="team-name home trunc-one";
  homeName.textContent=applyTruncate(g.home_team||"",30);
  bot.appendChild(homeName);

  // HOME LOGO
  const hLogoUrl=mapLogo(g.home_club_list);
  const hImg=document.createElement("img"); hImg.className="team-logo";
  if(hLogoUrl){ loadAndTrimLogo(hLogoUrl).then(u=>{ if(u) hImg.src=u; else hImg.replaceWith(makeLogoFallback(g.home_team)); }); }
  else { hImg.replaceWith(makeLogoFallback(g.home_team)); }
  bot.appendChild(hImg);

  // RESULT BOX
  const res=document.createElement("div"); res.className="result-box";
  const val=(g.result && g.result.trim())?g.result.trim():"–";
  if(g.result_link && g.result_link.trim() && val!=="–"){ res.innerHTML=`<a class="link">${val}</a>`; res.querySelector("a").href=g.result_link; res.querySelector("a").target="_blank"; res.querySelector("a").rel="noopener"; }
  else { res.innerHTML=`<span class="nolink">${val}</span>`; }
  bot.appendChild(res);

  // AWAY LOGO
  const aLogoUrl=mapLogo(g.away_club_list);
  const aImg=document.createElement("img"); aImg.className="team-logo";
  if(aLogoUrl){ loadAndTrimLogo(aLogoUrl).then(u=>{ if(u) aImg.src=u; else aImg.replaceWith(makeLogoFallback(g.away_team)); }); }
  else { aImg.replaceWith(makeLogoFallback(g.away_team)); }
  bot.appendChild(aImg);

  // AWAY NAME
  const awayName=document.createElement("div"); awayName.className="team-name away trunc-one";
  awayName.textContent=applyTruncate(g.away_team||"",30);
  bot.appendChild(awayName);

  card.appendChild(bot);

  // fit phase after DOM
  requestAnimationFrame(()=>{
    if(isSeries){
      shrinkToFit(top.querySelector(".top-left"));
      shrinkToFit(top.querySelector(".top-mid"));
    }else{
      shrinkToFit(top.querySelector(".series"));
    }
    shrinkToFit(homeName); shrinkToFit(awayName);
    // shrink time width to fixed 60px area (or 64px on md)
    const timeCell=t;
    const timeWidth=parseFloat(getComputedStyle(bot).gridTemplateColumns.split(" ")[0]); // "60px"
    shrinkTextToWidth(timeCell, timeWidth-6);

    // result text shrink inside fixed box
    const resText=res.querySelector("a")||res.querySelector(".nolink");
    shrinkToFit(resText,9,0.8);
  });

  // annotate arena for sticky calculation
  card.dataset.arena = (g.preferedName||g.arena||"Okänd arena").trim();

  return card;
}

function makeLogoFallback(name){
  const el=document.createElement("div"); el.className="logo-fallback";
  const initials=(name||"").split(/\s+/).filter(Boolean).slice(0,3).map(w=>w[0].toUpperCase()).join("")||"—";
  el.textContent=initials; return el;
}
</script>
</div>
</body>
</html>

