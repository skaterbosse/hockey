<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Hockeymatcher</title>

<style>
/* ==============================
   -- GLOBAL STYLING
   ============================== */

:root {
  --bg: white;
  --accent-green: #2ecc71;
  --accent-gray: #999;
  --accent-blue: #007aff;
  --text-dark: #222;
  --arena-header-bg: #f5f5f5;
  --border-radius: 7px;
  --result-bg: #000;       /* Same in both views */
  --result-text: white;
  --header-height: 68px;
}

body {
  margin: 0;
  padding: 0;
  background: var(--bg);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
               Helvetica, Arial, sans-serif;
}

/* ==============================
   -- TOP HEADER
   ============================== */

#topHeader {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: var(--header-height);
  background: white;
  border-bottom: 1px solid #ddd;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 4px 10px;
  z-index: 2000;
}

.header-btn {
  height: 26px;
  width: 26px;
  object-fit: contain;
}

#dateBox {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.date-arrow {
  width: 24px;
  height: 24px;
  cursor: pointer;
  filter: hue-rotate(100deg) saturate(2); /* Gives the light-green */
}

#dateLabel {
  text-align: center;
  font-size: 15px;
  min-width: 95px;
}

/* Sorteringsbox */
#sortBox {
  border: 1px solid #bbb;
  border-radius: 8px;
  padding: 3px 6px;
  display: inline-flex;
  flex-direction: column;
  align-items: center;
}

.sort-btn-row {
  display: flex;
  gap: 4px;
}

.sort-btn {
  padding: 3px 10px;
  border-radius: 6px;
  font-size: 13px;
  background: var(--accent-gray);
  color: white;
  border: none;
}

.sort-btn.active {
  background: var(--accent-green);
}

/* ==============================
   -- SCROLL AREA
   ============================== */

#mainContent {
  position: absolute;
  top: var(--header-height);
  left: 0;
  right: 0;
  bottom: 0;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding-bottom: 200px;
}

/* ==============================
   -- ARENA HEADERS (Plats-vy)
   ============================== */

.arena-header,
#activeArenaSticky {
  padding: 6px 10px;
  background: var(--arena-header-bg);
  border-bottom: 1px solid #ccc;
  display: flex;
  justify-content: space-between;
  font-weight: 600;
}
#activeArenaSticky {
  position: sticky;
  top: var(--header-height);
  z-index: 1900;
  display: none;
}

/* ==============================
   -- MATCH ROWS (identical style for both views)
   ============================== */

.match-two-row {
  padding: 6px 10px;
  border-bottom: 1px solid #eee;
}

.match-row-top {
  display: flex;
  justify-content: space-between;
  font-size: 13px;
}

.match-row-bottom {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 15px;
}

/* ========= RESULT BOX (same style for both views) ========= */

.result-box {
  background: var(--result-bg);
  color: var(--result-text);
  padding: 2px 12px;
  border-radius: 6px;
  font-weight: 700;
  font-size: 16px;
  min-width: 58px;    /* fits "0-0" */
  text-align: center;
  white-space: nowrap;
}

/* ==============================
   -- LOGOS
   ============================== */

.team-logo {
  height: 34px;
  width: 34px;
  object-fit: contain;
  background: transparent !important;
}
</style>
</head>

<body>
<div id="topHeader">
  <img id="homeBtn" class="header-btn" src="icons/home.jpeg">

  <div id="dateBox">
    <img id="prevDate" class="date-arrow" src="icons/arrow_left_green.png">
    <div id="dateLabel">Loading…</div>
    <img id="nextDate" class="date-arrow" src="icons/arrow_right_green.png">
  </div>

  <div id="sortBox">
    <div>Sortering</div>
    <div class="sort-btn-row">
      <button id="sortPlace" class="sort-btn">Plats</button>
      <button id="sortSeries" class="sort-btn">Serie</button>
      <button id="sortTime"   class="sort-btn">Tid</button>
    </div>
  </div>
</div>

<div id="activeArenaSticky"></div>
<div id="mainContent"></div>

<script>
/* ===========================================================
   == CORE DATA + CSV IMPORT ==
   =========================================================== */

let allGames = [];
let clubLogoMap = {};
const defaultLat = 57.590214281624824;
const defaultLong = 11.94608216084837;

/*** Load logos mapping ***/
fetch("data/Clubs_Organisatons_logos__ClubOrgName_LogoFileName.txt")
  .then(r => r.text())
  .then(txt => {
    txt.trim().split("\n").forEach(row => {
      let [name, file] = row.split(";");
      clubLogoMap[name.trim()] = file.trim();
    });
  });

/*** Load games.csv ***/
fetch("data/games.csv")
  .then(r => r.text())
  .then(parseCSV)
  .then(games => {
    allGames = games;
    setToday();
  });

function parseCSV(text) {
  return text.split("\n").slice(1).map(row => {
    let f = row.split(";");
    return {
      date: f[0], time: f[1], series: f[2],
      seriesLink: f[3], adminHost: f[4],
      home: f[5], away: f[6],
      result: f[7], resultLink: f[8],
      arenaRaw: f[9], status: f[10],
      homeClubs: f[13], awayClubs: f[14],
      arenaNbr: f[15], arenaName: f[16],
      lat: +f[17], long: +f[18]
    };
  });
}

/* ===========================================================
   == SORTERING ==
   =========================================================== */

let sortMode = "place";  
document.getElementById("sortPlace").onclick  = () => { sortMode="place";  render(); };
document.getElementById("sortSeries").onclick = () => { sortMode="series"; render(); };
document.getElementById("sortTime").onclick   = () => { sortMode="time";   render(); };

/* ===========================================================
   == DATE HANDLING ==
   =========================================================== */

let currentDate = null;
const dateLabel = document.getElementById("dateLabel");

function setToday() {
  const d = new Date();
  currentDate = d.toISOString().slice(0,10);
  render();
}

function changeDate(offset) {
  let d = new Date(currentDate);
  d.setDate(d.getDate() + offset);
  currentDate = d.toISOString().slice(0,10);
  render();
}

document.getElementById("prevDate").onclick = () => changeDate(-1);
document.getElementById("nextDate").onclick = () => changeDate(+1);
document.getElementById("homeBtn").onclick = setToday;

/* ===========================================================
   == RENDER / BUILD VIEW
   =========================================================== */

const mainContent = document.getElementById("mainContent");
const sticky = document.getElementById("activeArenaSticky");

function render() {
  const filtered = allGames.filter(g => g.date === currentDate);

  updateDateLabel();
  updateSortButtons();

  if (filtered.length === 0) {
    mainContent.innerHTML = `<div style="padding:20px;font-size:24px;text-align:center;">Inga matcher idag</div>`;
    sticky.style.display = "none";
    return;
  }

  if (sortMode === "place")
       renderPlace(filtered);
  else renderSeries(filtered);
}

/* ===========================================================
   == PLATS-VY
   =========================================================== */

function renderPlace(games) {

  sticky.style.display = "block";
  mainContent.innerHTML = "";
  mainContent.onscroll = handleScrollArenaSwap;

  /** group by arena */
  let arenas = {};
  games.forEach(g => {
    if (!arenas[g.arenaName]) arenas[g.arenaName] = [];
    arenas[g.arenaName].push(g);
  });

  const arenaNames = Object.keys(arenas).sort((a,b)=> distanceSort(a,b));

  let firstArenaShown = false;

  arenaNames.forEach((arena,i) => {
    if (!firstArenaShown) {
      sticky.innerHTML = buildArenaHeader(arena, arenas[arena]);
      firstArenaShown = true;
    } else {
      mainContent.innerHTML += buildArenaHeader(arena, arenas[arena]);
    }

    arenas[arena].forEach(g => {
      mainContent.innerHTML += buildMatchRowTwo(g, "place");
    });
  });
}


/* ===========================================================
   == SERIE-VY (STATIC WINDOW)
   =========================================================== */

function renderSeries(games) {

  sticky.style.display = "none";
  mainContent.onscroll = null;
  mainContent.innerHTML = "";

  let sorted = [...games];
  sorted.sort(seriesSortThenTime);

  sorted.forEach(g => {
    mainContent.innerHTML += buildMatchRowTwo(g, "series");
  });
}

/* ===========================================================
   == BUILD UI elements
   =========================================================== */

function buildArenaHeader(arenaName, list) {
  let avg = calcArenaDistance(list[0].lat, list[0].long).toFixed(1) + " km";
  return `
  <div class="arena-header" data-arena="${arenaName}">
      <span>${arenaName}</span>
      <span>${avg}</span>
  </div>`;
}

function buildMatchRowTwo(g, view) {

  let logoHome = pickLogo(g.homeClubs);
  let logoAway = pickLogo(g.awayClubs);

  let resultCell = (g.resultLink && g.result !== "–")
      ? `<a href="${g.resultLink}" target="_blank" class="result-box">${g.result}</a>`
      : `<div class="result-box">${g.result}</div>`;

  return `
  <div class="match-two-row">
    <div class="match-row-top">
      ${view==="place"
        ? `<span>${g.time}</span><span>${g.series}</span>`
        : `<span>${g.series}</span><span>${g.arenaName}</span><span>${calcArenaDistance(g.lat,g.long).toFixed(1)} km</span>`
      }
    </div>
    <div class="match-row-bottom">
      ${view==="place"
        ? `<span>${g.home}</span><img class="team-logo" src="${logoHome}">${resultCell}<img class="team-logo" src="${logoAway}"><span>${g.away}</span>`
        : `<span>${g.time}</span><span>${g.home}</span><img class="team-logo" src="${logoHome}">${resultCell}<img class="team-logo" src="${logoAway}"><span>${g.away}</span>`
      }
    </div>
  </div>
  `;
}

/* ===========================================================
   == ARENA SWAP w/ AUTOSCROLL B
   =========================================================== */

function handleScrollArenaSwap() {
  const arenaHeaders = [...mainContent.querySelectorAll(".arena-header")];

  for (let i=0;i<arenaHeaders.length;i++) {
    let rect = arenaHeaders[i].getBoundingClientRect();
    if (rect.top <= (70 + 5) && rect.bottom >= (70 + 5)) {
      let arena = arenaHeaders[i].dataset.arena;
      sticky.innerHTML = arenaHeaders[i].innerHTML;
    }
  }
}

/* ===========================================================
   == LOGOS
   =========================================================== */

function pickLogo(clubList) {
  let first = clubList.split(",")[0].trim();
  let file = clubLogoMap[first];
  return file ? `logos/${file}` : `logos/placeholder.png`;
}

/* ===========================================================
   == UTILITIES
   =========================================================== */

function updateDateLabel() {
  let d = new Date(currentDate);
  let weekday = ["Sön","Mån","Tis","Ons","Tors","Fre","Lör"][d.getDay()];
  let month   = ["jan","feb","mar","apr","maj","jun","jul","aug","sep","okt","nov","dec"][d.getMonth()];
  dateLabel.innerHTML = `${weekday}<br>${d.getDate()} ${month}`;
}

function updateSortButtons() {
  document.getElementById("sortPlace").classList.toggle("active", sortMode==="place");
  document.getElementById("sortSeries").classList.toggle("active", sortMode==="series");
  document.getElementById("sortTime").classList.toggle("active", sortMode==="time");
}

function distanceSort(a,b) {
  return calcArenaDistance(getLat(a),getLong(a)) - calcArenaDistance(getLat(b),getLong(b));
}

function calcArenaDistance(lat,long) {
  let R = 6371;
  let dLat = deg2rad(lat - defaultLat);
  let dLon = deg2rad(long - defaultLong);
  let a = Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(deg2rad(defaultLat)) * Math.cos(deg2rad(lat)) *
          Math.sin(dLon/2) * Math.sin(dLon/2);
  let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}
function deg2rad(d) { return d * (Math.PI/180); }

function getLat(arena){return 0;}
function getLong(arena){return 0;}

function seriesSortThenTime(a,b){
  if (a.time < b.time) return -1;
  if (a.time > b.time) return +1;
  return a.series.localeCompare(b.series);
}
</script>
</body>
</html>

