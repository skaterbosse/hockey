<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>LocalSport – Plats / Serie</title>
<style>
  :root{
    --topbar-h:62px;
    --sticky-hint-h:0px;
    --bg:#ffffff;
    --bar:#f7f7f7;
    --hair:#dadde2;
    --text:#0f172a;
    --muted:#556271;
    --accent:#16a34a;
    --link:#2563eb;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif}
  .app{height:100dvh;display:flex;flex-direction:column;overflow:hidden}

  /* Topbar */
  .topbar{
    position:sticky;top:0;z-index:1000;
    height:var(--topbar-h);
    background:var(--bar);
    border-bottom:1px solid var(--hair);
    display:grid;grid-template-columns:1fr auto 1fr;align-items:center;
    padding:8px 10px;
  }
  .cluster{display:flex;align-items:center;gap:8px}
  .cluster.center{justify-content:center}
  .icon{width:28px;height:28px;display:block;object-fit:contain;cursor:pointer}
  .date-pack{display:flex;align-items:center;gap:8px}
  .arrow{user-select:none;cursor:pointer;font-size:22px;line-height:1}
  .date-text{min-width:138px;text-align:center;font-weight:700}

  /* Tabs (enkel växling för att kunna se ”Inga matcher idag” i båda) */
  .tabs{display:flex;gap:6px;margin-left:auto}
  .pill{padding:6px 10px;border:1px solid var(--hair);border-radius:999px;font-weight:600;font-size:12px;cursor:pointer;user-select:none;background:#fff;color:#64748b}
  .pill.on{background:#dcfce7;border-color:#86efac;color:var(--accent)}

  /* Views */
  .view{position:absolute;inset:var(--topbar-h) 0 0 0;overflow:auto;background:#fff}
  #seriesView{display:none}

  /* Sticky arena header for place view */
  .arena-sticky{position:sticky;top:var(--topbar-h);z-index:500;background:#fff;border-bottom:1px solid var(--hair);padding:10px 12px;display:flex;justify-content:space-between;font-weight:700}
  .arena-sticky.hidden{display:none}

  /* Scroll list content wrappers */
  .section{padding:0 0 12px 0}

  /* Arena header inside list */
  .arena-head{padding:10px 12px;display:flex;justify-content:space-between;border-bottom:1px solid var(--hair);font-weight:700;background:#fff}

  /* Match card (gemensam) */
  .match{padding:8px 12px;border-bottom:1px solid #eef1f5;background:#fff}
  .match-top{display:flex;gap:10px;align-items:center;font-size:14px;color:var(--muted);white-space:nowrap;overflow:hidden}
  .match-top .time{font-weight:700;color:#111}
  .match-top .series{min-width:0;overflow:hidden;text-overflow:ellipsis}
  .match-top .series a{color:var(--link);text-decoration:none}
  .match-bottom{display:grid;grid-template-columns:1fr auto auto auto 1fr;align-items:center;gap:6px;margin-top:4px}

  .team-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:600}
  .team-name.home{text-align:right;padding-right:6px}
  .team-name.away{text-align:left;padding-left:6px}

  .logo-box{width:34px;height:34px;display:flex;align-items:center;justify-content:center}
  .logo-box img{max-width:100%;max-height:100%;object-fit:contain;object-position:center}

  /* Result-box: fast bredd/höjd. ”–” visar stilla text, länk blå */
  .result-box{width:62px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800}
  .result-box.no-link{background:#111;color:#fff}
  .result-box.link a{text-decoration:none;color:var(--link);font-weight:800}
  .result-box.dash{background:#111;color:#fff}

  /* Serie-vy grupper */
  .series-group-head{position:sticky;top:var(--topbar-h);z-index:300;background:#fff;border-bottom:1px solid var(--hair);padding:10px 12px;font-weight:800}
  .series-subarena{padding:8px 12px;display:flex;justify-content:space-between;color:#334155;border-bottom:1px dashed #e5e7eb}

  /* ”Inga matcher idag” */
  .empty{
    padding:24px 16px;text-align:center;color:#b42318;font-weight:800;font-size:18px;
    border-top:1px solid var(--hair)
  }

  /* Debug badge */
  .dbg{position:fixed;right:8px;bottom:8px;background:#111;color:#fff;border-radius:999px;padding:6px 10px;font-size:12px;opacity:.85;z-index:9999}
</style>
</head>
<body>
<div class="app">
  <header class="topbar">
    <div class="cluster">
      <img id="btnMap" class="icon" src="icons/map.jpeg" alt="Karta">
    </div>

    <div class="cluster center">
      <div class="date-pack">
        <span id="prevDate" class="arrow">‹</span>
        <span id="dateText" class="date-text">—</span>
        <span id="nextDate" class="arrow">›</span>
      </div>
    </div>

    <div class="cluster" style="justify-content:flex-end; gap:10px;">
      <div class="tabs">
        <div id="tabPlace" class="pill on">Plats</div>
        <div id="tabSeries" class="pill">Serie</div>
      </div>
      <img id="btnHome" class="icon" src="icons/home.jpeg" alt="Hem">
    </div>
  </header>

  <!-- PLATS-VY -->
  <main id="placeView" class="view">
    <div id="placeSticky" class="arena-sticky hidden">
      <div id="placeStickyName"></div>
      <div id="placeStickyDist"></div>
    </div>
    <div id="placeBody" class="section"></div>
    <div id="placeEmpty" class="empty" style="display:none;">Inga matcher idag</div>
  </main>

  <!-- SERIE-VY -->
  <main id="seriesView" class="view">
    <div id="seriesBody" class="section"></div>
    <div id="seriesEmpty" class="empty" style="display:none;">Inga matcher idag</div>
  </main>
</div>

<script>
/* ======================= CONFIG / STATE ======================= */
const USER_POS = { lat:57.590214281624824, lon:11.94608216084837 }; // Billdal
const DEBUG = new URL(location.href).searchParams.get("debug") === "1";
if (DEBUG) {
  const b=document.createElement('div'); b.className='dbg'; b.textContent='DEBUG ON'; document.body.appendChild(b);
  console.info("[DEBUG] Läge aktivt");
}

const els = {
  dateText: document.getElementById('dateText'),
  prevDate: document.getElementById('prevDate'),
  nextDate: document.getElementById('nextDate'),
  btnHome:  document.getElementById('btnHome'),
  btnMap:   document.getElementById('btnMap'),
  tabPlace: document.getElementById('tabPlace'),
  tabSeries:document.getElementById('tabSeries'),
  placeView:document.getElementById('placeView'),
  seriesView:document.getElementById('seriesView'),
  placeSticky:document.getElementById('placeSticky'),
  placeStickyName:document.getElementById('placeStickyName'),
  placeStickyDist:document.getElementById('placeStickyDist'),
  placeBody: document.getElementById('placeBody'),
  placeEmpty:document.getElementById('placeEmpty'),
  seriesBody:document.getElementById('seriesBody'),
  seriesEmpty:document.getElementById('seriesEmpty'),
};

let ALL = [];           // alla rader från CSV (objekt)
let currentDate = null; // JS Date för valt datum
let mode = 'place';     // 'place' eller 'series'

/* ======================= HELPERS ======================= */
const dayNames = ["Sön","Mån","Tis","Ons","Tors","Fre","Lör"];
const monNames = ["jan","feb","mar","apr","maj","jun","jul","aug","sep","okt","nov","dec"];

function pad(n){return (n<10?'0':'')+n}
function toDateStr(d){return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`}
function fromDateStr(s){const [y,m,d]=s.split('-').map(Number); const dt=new Date(y,m-1,d); dt.setHours(0,0,0,0); return dt}
function setDateHeader(d){
  els.dateText.textContent = `${dayNames[d.getDay()]} ${d.getDate()} ${monNames[d.getMonth()]}`;
}
function haversineKm(lat1,lon1,lat2,lon2){
  const R=6371; const toRad=x=>x*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return Math.round(R*2*Math.asin(Math.sqrt(a)));
}

/* ======================= CSV LOAD ======================= */
async function loadCSV(){
  const txt = await fetch('data/games.csv', {cache:'no-store'}).then(r=>r.text());
  const rows = txt.split(/\r?\n/).filter(l=>l.trim().length>0);
  const header = rows.shift(); // remove header
  if (DEBUG) console.info("[DEBUG] Header:", header);

  ALL = rows.map(line=>{
    const s = line.split(";"); // fält enligt specifikationen
    return {
      date: s[0],
      time: s[1],
      series_name: s[2],
      link_to_series: s[3],
      admin_host: s[4],
      home_team: s[5],
      away_team: s[6],
      result: s[7],
      result_link: s[8],
      arena: s[9],
      status: s[10],
      iteration_fetched: s[11],
      iterations_total: s[12],
      home_club_list: s[13],
      away_club_list: s[14],
      arena_nbr: s[15],
      PreferedName: s[16],
      Lat: s[17] ? Number(s[17]) : null,
      Long: s[18] ? Number(s[18]) : null,
    };
  });
  if (DEBUG) console.info("[DEBUG] Laddade matcher:", ALL.length);
}

/* ======================= RENDER – GENERIC ======================= */
function filterByDate(dstr){
  return ALL.filter(g => g.date === dstr);
}

function ensureTodayStart(){
  const today = new Date();
  today.setHours(0,0,0,0);
  currentDate = today;
  setDateHeader(today);
}

/* ======================= RENDER – PLATS ======================= */
function renderPlace(){
  const list = filterByDate(toDateStr(currentDate));
  els.placeBody.innerHTML = '';
  els.placeSticky.classList.add('hidden');

  if (list.length === 0){
    els.placeEmpty.style.display = 'block';
    return;
  }
  els.placeEmpty.style.display = 'none';

  // gruppera per arena (PreferedName först)
  const arenaMap = new Map();
  list.forEach(g=>{
    const name = g.PreferedName && g.PreferedName.trim() ? g.PreferedName.trim() : (g.arena||'');
    if(!arenaMap.has(name)) arenaMap.set(name, []);
    arenaMap.get(name).push(g);
  });

  // sortera arenor på avstånd från Billdal (om lat/long finns)
  const arenas = Array.from(arenaMap.keys()).map(name=>{
    const any = arenaMap.get(name).find(x=>x.Lat!=null && x.Long!=null);
    const dist = any ? haversineKm(USER_POS.lat, USER_POS.lon, any.Lat, any.Long) : null;
    return {name, dist};
  }).sort((a,b)=>{
    if (a.dist==null && b.dist==null) return a.name.localeCompare(b.name);
    if (a.dist==null) return 1;
    if (b.dist==null) return -1;
    return a.dist - b.dist;
  });

  // visa första arenan i sticky header och ta bort den ur listan
  const first = arenas[0];
  if (first){
    els.placeStickyName.textContent = first.name;
    els.placeStickyDist.textContent = first.dist!=null ? `Avst ${first.dist} km` : '';
    els.placeSticky.classList.remove('hidden');

    // Rendera första arenans matcher (utan arenahuvud i listan)
    const gamesFirst = arenaMap.get(first.name).slice().sort((a,b)=>a.time.localeCompare(b.time));
    gamesFirst.forEach(g=> els.placeBody.appendChild(makeMatchCardPlace(g)));
  }

  // Rendera övriga arenor med egna rubriker
  arenas.slice(1).forEach(a=>{
    const head = document.createElement('div');
    head.className='arena-head';
    head.innerHTML = `<div>${a.name}</div><div>${a.dist!=null?`Avst ${a.dist} km`:''}</div>`;
    els.placeBody.appendChild(head);

    const games = arenaMap.get(a.name).slice().sort((x,y)=>x.time.localeCompare(y.time));
    games.forEach(g=> els.placeBody.appendChild(makeMatchCardPlace(g)));
  });
}

function makeMatchCardPlace(g){
  // Övre rad: Tid + Serie
  const wrap = document.createElement('div');
  wrap.className='match';

  const top = document.createElement('div');
  top.className='match-top';
  const time = document.createElement('div'); time.className='time'; time.textContent=g.time||'';
  const series = document.createElement('div'); series.className='series';
  if (g.link_to_series && g.link_to_series.trim()){
    series.innerHTML = `<a href="${g.link_to_series}" target="_blank" rel="noopener">${g.series_name||''}</a>`;
  } else {
    series.textContent = g.series_name||'';
  }
  top.appendChild(time); top.appendChild(series);
  wrap.appendChild(top);

  // Nedre rad: Hemma [logo] [RESULTAT] [logo] Borta
  const bottom = document.createElement('div');
  bottom.className='match-bottom';

  const homeName = document.createElement('div'); homeName.className='team-name home'; homeName.textContent=g.home_team||'';
  const homeLogo = document.createElement('div'); homeLogo.className='logo-box'; homeLogo.innerHTML = `<img src="logos/no_club_found.png" alt="">`;
  const resBox = document.createElement('div'); resBox.className='result-box';
  const awayLogo = document.createElement('div'); awayLogo.className='logo-box'; awayLogo.innerHTML = `<img src="logos/no_club_found.png" alt="">`;
  const awayName = document.createElement('div'); awayName.className='team-name away'; awayName.textContent=g.away_team||'';

  // Result logik
  const hasResult = g.result && g.result.trim().length>0 && g.result.trim()!=="–";
  const hasLink = g.result_link && g.result_link.trim().length>0;

  if (!hasResult){
    resBox.classList.add('dash');
    resBox.textContent = "–";
  } else if (hasLink){
    resBox.classList.add('link');
    resBox.innerHTML = `<a href="${g.result_link}" target="_blank" rel="noopener">${g.result.trim()}</a>`;
  } else {
    resBox.classList.add('no-link');
    resBox.textContent = g.result.trim();
  }

  bottom.appendChild(homeName);
  bottom.appendChild(homeLogo);
  bottom.appendChild(resBox);
  bottom.appendChild(awayLogo);
  bottom.appendChild(awayName);

  wrap.appendChild(bottom);
  return wrap;
}

/* ======================= RENDER – SERIE ======================= */
function renderSeries(){
  const list = filterByDate(toDateStr(currentDate));
  els.seriesBody.innerHTML = '';

  if (list.length === 0){
    els.seriesEmpty.style.display = 'block';
    return;
  }
  els.seriesEmpty.style.display = 'none';

  // gruppera per series_name
  const serMap = new Map();
  list.forEach(g=>{
    const key = g.series_name || '(utan serie)';
    if(!serMap.has(key)) serMap.set(key, []);
    serMap.get(key).push(g);
  });

  // enkel alfabetisk ordning (ingen annan logik ändrad nu)
  const seriesKeys = Array.from(serMap.keys()).sort((a,b)=>a.localeCompare(b,'sv'));

  seriesKeys.forEach(ser=>{
    const head = document.createElement('div');
    head.className='series-group-head';
    head.textContent = ser;
    els.seriesBody.appendChild(head);

    // Under varje serie – lista matcher (tidsordning)
    const games = serMap.get(ser).slice().sort((x,y)=>x.time.localeCompare(y.time));

    games.forEach(g=>{
      // SERIE-VY: topp-rad = Tid + (serie-länk) + Arena + Avst
      const card = document.createElement('div');
      card.className='match';

      const top = document.createElement('div');
      top.className='match-top';

      const time = document.createElement('div'); time.className='time'; time.textContent=g.time||'';
      const series = document.createElement('div'); series.className='series';
      if (g.link_to_series && g.link_to_series.trim()){
        series.innerHTML = `<a href="${g.link_to_series}" target="_blank" rel="noopener">${g.series_name||''}</a>`;
      } else {
        series.textContent = g.series_name||'';
      }

      // arena & avstånd höger sida
      let arenaName = (g.PreferedName && g.PreferedName.trim()) ? g.PreferedName.trim(): (g.arena||'');
      const right = document.createElement('div');
      right.style.marginLeft='auto';
      const dist = (g.Lat!=null && g.Long!=null) ? haversineKm(USER_POS.lat, USER_POS.lon, g.Lat, g.Long) : null;
      right.textContent = arenaName + (dist!=null? ` · Avst ${dist} km` : '');

      top.appendChild(time);
      top.appendChild(series);
      top.appendChild(right);

      // nedre rad = Hemma [logo] [RESULTAT] [logo] Borta
      const bottom = document.createElement('div');
      bottom.className='match-bottom';

      const homeName = document.createElement('div'); homeName.className='team-name home'; homeName.textContent=g.home_team||'';
      const homeLogo = document.createElement('div'); homeLogo.className='logo-box'; homeLogo.innerHTML = `<img src="logos/no_club_found.png" alt="">`;
      const resBox = document.createElement('div'); resBox.className='result-box';
      const awayLogo = document.createElement('div'); awayLogo.className='logo-box'; awayLogo.innerHTML = `<img src="logos/no_club_found.png" alt="">`;
      const awayName = document.createElement('div'); awayName.className='team-name away'; awayName.textContent=g.away_team||'';

      // Result logik
      const hasResult = g.result && g.result.trim().length>0 && g.result.trim()!=="–";
      const hasLink = g.result_link && g.result_link.trim().length>0;

      if (!hasResult){
        resBox.classList.add('dash');
        resBox.textContent = "–";
      } else if (hasLink){
        resBox.classList.add('link');
        resBox.innerHTML = `<a href="${g.result_link}" target="_blank" rel="noopener">${g.result.trim()}</a>`;
      } else {
        resBox.classList.add('no-link');
        resBox.textContent = g.result.trim();
      }

      card.appendChild(top);
      bottom.appendChild(homeName);
      bottom.appendChild(homeLogo);
      bottom.appendChild(resBox);
      bottom.appendChild(awayLogo);
      bottom.appendChild(awayName);
      card.appendChild(bottom);

      els.seriesBody.appendChild(card);
    });
  });
}

/* ======================= VIEW TOGGLING ======================= */
function setMode(m){
  mode = m;
  if (mode==='place'){
    els.placeView.style.display='block';
    els.seriesView.style.display='none';
    els.tabPlace.classList.add('on');
    els.tabSeries.classList.remove('on');

    // render + empty check
    els.placeEmpty.style.display='none';
    renderPlace();
    if (els.placeBody.children.length===0){
      els.placeEmpty.style.display='block';
    }
  } else {
    els.placeView.style.display='none';
    els.seriesView.style.display='block';
    els.tabPlace.classList.remove('on');
    els.tabSeries.classList.add('on');

    // render + empty check
    els.seriesEmpty.style.display='none';
    renderSeries();
    if (els.seriesBody.children.length===0){
      els.seriesEmpty.style.display='block';
    }
  }
}

/* ======================= DATE CONTROLS ======================= */
function shiftDate(days){
  currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate()+days);
  currentDate.setHours(0,0,0,0);
  setDateHeader(currentDate);
  // omdatum: alltid rendera aktiv vy + tom-meddelande
  if (mode==='place'){
    els.placeEmpty.style.display='none';
    renderPlace();
    if (els.placeBody.children.length===0){
      els.placeEmpty.style.display='block';
    }
  } else {
    els.seriesEmpty.style.display='none';
    renderSeries();
    if (els.seriesBody.children.length===0){
      els.seriesEmpty.style.display='block';
    }
  }
}

/* ======================= EVENTS ======================= */
els.prevDate.addEventListener('click', ()=>shiftDate(-1));
els.nextDate.addEventListener('click', ()=>shiftDate(1));
els.btnHome.addEventListener('click', ()=>{
  ensureTodayStart();
  setMode('place');
});
els.btnMap.addEventListener('click', ()=>alert('Kartvy ej implementerad ännu.'));
els.tabPlace.addEventListener('click', ()=>setMode('place'));
els.tabSeries.addEventListener('click', ()=>setMode('series'));

/* ======================= BOOT ======================= */
(async function(){
  await loadCSV();
  ensureTodayStart();     // alltid verkligt dagens datum
  setMode('place');       // default vy
})();
</script>
</body>
</html>

